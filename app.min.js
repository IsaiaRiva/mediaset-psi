import SolutionManifest from"/solution-manifest.js";class R0{static readable(e,t,a){const s=Number.parseInt(e||0,10);if(!s)return"0 "+a[0];const n=Math.floor(Math.log(s)/Math.log(t));return`${1*(s/t**n).toFixed(2)} ${a[n]}`}}const mxReadable=e=>class extends e{static readableFileSize(e){return R0.readable(e,1024,["B","KB","MB","GB","TB","PB"])}static readableBitrate(e){return R0.readable(e,1024,["bps","Kbps","Mbps","Gbps","Tbps","Pbps"])}static readableDuration(e=0,t=!0){const a=Math.floor(e/36e5),s=Math.floor(e%36e5/6e4),n=Math.floor(e%6e4/1e3),i=Math.ceil(e%1e3),o=`${a.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`;return t?o:`${o}.${i.toString().padStart(3,"0")}`}static capitalize(e){return e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}static shorten(e,t=40){switch(typeof e){case"number":case"boolean":case"symbol":case"undefined":return e}const a=Array.isArray(e)?e.join(", "):e.toString(),s=Math.max(t,20);return a.length<=s?a:`${a.substring(0,s-10)}...${a.substring(a.length-7)}`}static isoDateTime(e){return e?new Date(e).toISOString():void 0}},mxZero=e=>class extends e{static zeroMd5(){return new Array(32).fill("0").join("")}static zeroUuid(){const e=new Array(36).fill("0");return e[8]=e[13]=e[18]=e[23]="-",e.join("")}static zeroAccountId(){return new Array(12).fill("0").join("")}};class SigV4Client{constructor(e={}){const t=["accessKey","secretKey","endpoint"].filter(t=>void 0===e[t]);if(t.length)throw new Error("missing params, "+t.join(", "));this.$accessKey=e.accessKey,this.$secretKey=e.secretKey,this.$sessionToken=e.sessionToken,this.$region=e.region||"us-east-1",this.$serviceName=e.serviceName||"execute-api",this.$defaultAcceptType=e.defaultAcceptType||"application/json",this.$defaultContentType=e.defaultContentType||"application/json",this.$endpoint=e.endpoint}static get Constants(){return{AWS_SHA_256:"AWS4-HMAC-SHA256",AWS4_REQUEST:"aws4_request",AWS4:"AWS4",X_AMZ_DATE:"x-amz-date",X_AMZ_SECURITY_TOKEN:"x-amz-security-token",HOST:"host",AUTHORIZATION:"Authorization"}}get accessKey(){return this.$accessKey}get secretKey(){return this.$secretKey}get sessionToken(){return this.$sessionToken}get region(){return this.$region}get serviceName(){return this.$serviceName}get defaultAcceptType(){return this.$defaultAcceptType}get defaultContentType(){return this.$defaultContentType}get endpoint(){return this.$endpoint}hash(e){return CryptoJS.SHA256(e)}hexEncode(e){return e.toString(CryptoJS.encHex)}hmac(e,t){return CryptoJS.HmacSHA256(t,e,{asBytes:!0})}buildCanonicalRequest(e,t,a,s,n){return`${e}\n${this.buildCanonicalUri(t)}\n${this.buildCanonicalQueryString(a)}\n${this.buildCanonicalHeaders(s)}\n${this.buildCanonicalSignedHeaders(s)}\n${this.hexEncode(this.hash(n))}`}hashCanonicalRequest(e){return this.hexEncode(this.hash(e))}buildCanonicalUri(e){return encodeURI(e)}buildCanonicalQueryString(e){if(Object.keys(e).length<1)return"";const t=Object.keys(e).sort();let a="";for(let s of t)a=`${a}${s}=${encodeURIComponent(e[s])}&`;return a.substring(0,a.length-1)}buildCanonicalHeaders(e){let t="";const a=Object.keys(e).sort();for(let s of a)t=`${t}${s.toLowerCase()}:${e[s]}\n`;return t}buildCanonicalSignedHeaders(e){return Object.keys(e).map(e=>e.toLowerCase()).sort().join(";")}buildStringToSign(e,t,a){return`${SigV4Client.Constants.AWS_SHA_256}\n${e}\n${t}\n${a}`}buildCredentialScope(e,t,a){return`${e.substr(0,8)}/${t}/${a}/${SigV4Client.Constants.AWS4_REQUEST}`}calculateSigningKey(e,t,a,s){return this.hmac(this.hmac(this.hmac(this.hmac(`${SigV4Client.Constants.AWS4}${e}`,t.substr(0,8)),a),s),SigV4Client.Constants.AWS4_REQUEST)}calculateSignature(e,t){return this.hexEncode(this.hmac(e,t))}extractHostname(e){return(e.indexOf("://")>-1?e.split("/")[2]:e.split("/")[0]).split(":").shift().split("?").shift()}buildAuthorizationHeader(e,t,a,s){return`${SigV4Client.Constants.AWS_SHA_256} Credential=${e}/${t}, SignedHeaders=${this.buildCanonicalSignedHeaders(a)}, Signature=${s}`}signRequest(e){const t=/(^https?:\/\/[^/]+)/g.exec(this.endpoint)[1],a=`${this.endpoint.substring(t.length)}${e.path}`,s=e.method.toUpperCase(),n=Object.assign({},e.queryParams),i=Object.assign({},e.headers);i["Content-Type"]=i["Content-Type"]||this.defaultContentType,i.Accept=i.Accept||this.defaultAcceptType;const o=void 0===e.body||"GET"===s?"":e.body;o||delete i["Content-Type"];const r=(new Date).toISOString().replace(/\.\d{3}Z$/,"Z").replace(/[:-]|\.\d{3}/g,"");i[SigV4Client.Constants.X_AMZ_DATE]=r,i[SigV4Client.Constants.HOST]=this.extractHostname(t);const l=this.buildCanonicalRequest(s,a,n,i,o),d=this.hashCanonicalRequest(l),c=this.buildCredentialScope(r,this.region,this.serviceName),p=this.buildStringToSign(r,c,d),h=this.calculateSigningKey(this.secretKey,r,this.region,this.serviceName),u=this.calculateSignature(h,p);i[SigV4Client.Constants.AUTHORIZATION]=this.buildAuthorizationHeader(this.accessKey,c,i,u),this.sessionToken&&(i[SigV4Client.Constants.X_AMZ_SECURITY_TOKEN]=this.sessionToken),delete i[SigV4Client.Constants.HOST];let m=`${t}${a}`;const g=this.buildCanonicalQueryString(n);return g&&(m=`${m}?${g}`),i["Content-Type"]=i["Content-Type"]||this.defaultContentType,{headers:i,url:m}}}const THUMBNAIL_W=72,THUMBNAIL_H=72;class MimeWrapper{constructor(){MimeWrapper.$.define({"image/x-adobe-dng":["DNG"],"image/x-canon-cr2":["CR2"],"image/x-canon-crw":["CRW"],"image/x-epson-erf":["ERF"],"image/x-fuji-raf":["RAF"],"image/x-kodak-dcr":["DCR"],"image/x-kodak-k25":["K25"],"image/x-kodak-kdc":["KDC"],"image/x-minolta-mrw":["MRW"],"image/x-nikon-nef":["NEF"],"image/x-olympus-orf":["ORF"],"image/x-panasonic-raw":["RAW"],"image/x-pentax-pef":["PEF"],"image/x-sony-arw":["ARW"],"image/x-sony-sr2":["SR2"],"image/x-sony-srf":["SRF"],"image/x-sigma-x3f":["X3F"]},!0)}static get $(){return window.AWSomeNamespace.Mime}static getSingleton(){return(window.AWSomeNamespace||{}).MimeSingleton||(window.AWSomeNamespace={...window.AWSomeNamespace,MimeSingleton:new MimeWrapper}),window.AWSomeNamespace.MimeSingleton}getMime(e){return"string"==typeof e?MimeWrapper.$.getType(e):(e||{}).type?e.type:(e||{}).mime?e.mime:(e||{}).name?MimeWrapper.$.getType(e.name):(e||{}).key?MimeWrapper.$.getType(e.key):void 0}getKind(e){const[t,a]=(this.getMime(e)||"").split("/").filter(e=>e).map(e=>e.toLowerCase());return"video"===t||"audio"===t||"image"===t?t:"mxf"===a||"gxf"===a?"video":"pdf"===a?"document":a}}class AppUtils extends(mxReadable(mxZero(class{}))){static signRequest(e,t,a,s,n){return new SigV4Client({accessKey:AWS.config.credentials.accessKeyId,secretKey:AWS.config.credentials.secretAccessKey,sessionToken:AWS.config.credentials.sessionToken,region:AWS.config.region,serviceName:"execute-api",endpoint:t}).signRequest({method:e,path:a,headers:{"Content-Type":"application/json"},queryParams:s,body:"string"==typeof n?n:JSON.stringify(n)})}static async authHttpRequest(e,t,a={},s=""){return new Promise((n,i)=>{const o=new XMLHttpRequest,r=JSON.parse(JSON.stringify(a)),{url:l,headers:d}=AppUtils.signRequest(e,t,"",r,s);o.open(e,l,!0),Object.keys(d).forEach(e=>{o.setRequestHeader(e,d[e])}),o.withCredentials=!1,o.onerror=e=>i(e),o.onabort=e=>i(e),o.onreadystatechange=()=>{if(o.readyState===XMLHttpRequest.DONE){if(200===o.status){if(void 0===o.responseText||!o.responseText.length)return n(void 0);const e=JSON.parse(o.responseText);return e.errorCode?(console.error(`[ERR]: ${e.errorCode} - ${encodeURIComponent(e.errorMessage)}`),i(new Error(`${e.errorCode} - ${e.errorMessage}`))):n(JSON.parse(o.responseText))}if(o.status>=400)return i(new Error(`${o.status} - ${o.responseURL}`))}},o.send("string"==typeof s?s:JSON.stringify(s))})}static sanitize(e){return e.toString().replace(/</g,"&lt;").replace(/>/g,"&gt;")}static async pause(e=0){return new Promise(t=>{setTimeout(()=>t(),e)})}static loading(e="spinning-icon",t=!0){t?$("#"+e).removeClass("collapse"):$("#"+e).addClass("collapse")}static uuid4(e){const t=(e||CryptoJS.lib.WordArray.random(16)).toString(),a=t.match(/([0-9a-fA-F]{8})([0-9a-fA-F]{4})([0-9a-fA-F]{4})([0-9a-fA-F]{4})([0-9a-fA-F]{12})/);if(!a)throw new Error(`failed to generate uuid from '${t}'`);return a.shift(),a.join("-").toLowerCase()}static toMD5String(e,t="hex"){if(!e)return;const a=e.match(/^[0-9a-fA-F]{32}$/)?"hex":"base64";if(a===t)return e;const s="hex"===a?CryptoJS.enc.Hex.parse(e):CryptoJS.enc.Base64.parse(e);return"hex"===t?CryptoJS.enc.Hex.stringify(s):CryptoJS.enc.Base64.stringify(s)}static get Mime(){return MimeWrapper.getSingleton()}static randomHexstring(){const e=new Uint32Array(1);return(window.crypto||window.msCrypto).getRandomValues(e),e[0].toString(16)}static randomNumber(e=1e3,t=0){const a=new Uint32Array(1);(window.crypto||window.msCrypto).getRandomValues(a);const s=Math.max(1,e-t+1);return a[0]%s+t}static randomRGB(){const e=new Uint32Array(3);(window.crypto||window.msCrypto).getRandomValues(e);return`rgb(${e[0]%256}, ${e[1]%256}, ${e[2]%256})`}static randomRGBNumber(){const e=new Uint32Array(3);return(window.crypto||window.msCrypto).getRandomValues(e),[e[0]%256,e[1]%256,e[2]%256]}static parsePrefix(e){return e&&"/"!==e[e.length-1]?e.substring(0,e.lastIndexOf("/")):e}static toFriendlyName(e){return(e||"").replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}static async downscale(e,t=72,a=72){return new Promise((s,n)=>{if(!e)return void n(new Error("missing url"));const i=new Image;i.onload=()=>{const e=t/i.width,n=a/i.height,o=Math.max(e,n);let r=Math.floor(i.width*o);r-=r%2;let l=Math.floor(i.height*o);l-=l%2;const d=document.createElement("canvas");d.width=r,d.height=l;d.getContext("2d").drawImage(i,0,0,i.width,i.height,0,0,r,l);const c=d.toDataURL("image/png");s(c)},i.crossOrigin="anonymous",i.src=e})}}const EXPIRE_IN_7DAYS=6048e5,StoreDefinitions={Stores:{Images:"local-images",Settings:"settings",Dataset:"dataset",Faces:"faces"},TimeToLive:{Name:"ttl",Value:6048e5}},DATABASE_NAME="m2cv3-0",DATABASE_VERSION=1,RW="readwrite";class LocalStoreDB{constructor(){this.monkeyPatch(),this.$db=void 0}static getSingleton(){if(!(window.AWSomeNamespace||{}).LocalStoreDBSingleton){const e=Object.values(StoreDefinitions.Stores);window.AWSomeNamespace={...window.AWSomeNamespace,LocalStoreDBSingleton:new LocalStoreDB(e)}}return window.AWSomeNamespace.LocalStoreDBSingleton}get db(){return this.$db}set db(e){this.$db=e}isSupported(){return!!window.indexedDB}monkeyPatch(){window.indexedDB||(window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB),window.IDBTransaction||(window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction||{READ_WRITE:RW}),window.IDBKeyRange||(window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange)}async open(){if(!this.isSupported())throw new Error("indexedDB not supported");return this.db||(this.db=await new Promise((e,t)=>{const a=indexedDB.open("m2cv3-0",1);a.onerror=e=>{console.error(e),t(e)},a.onsuccess=async()=>{const t=Object.values(StoreDefinitions.Stores),s=a.result;await Promise.all(t.map(e=>this.removeExpired(s,e).catch(t=>(console.error(`ERR: onsuccess: ${e}: ${t.message}`),t)))),e(s)},a.onupgradeneeded=e=>{const t=Object.values(StoreDefinitions.Stores),s=StoreDefinitions.TimeToLive.Name,n=a.result;t.map(e=>n.createObjectStore(e).createIndex(s,s))}})),this.db}async close(){this.db&&(this.db.close(),this.db=void 0)}async openStore(e,t=RW){return this.db||await this.open(),this.db.transaction([e],t).objectStore(e)}async getItem(e,t){const a=await this.openStore(e);return new Promise(e=>{const s=a.get(t);s.onerror=t=>{console.error("getItem.onerror: "+t.message),e(void 0)},s.onsuccess=t=>e((t.target.result||{}).value)})}async putItem(e,t,a,s=StoreDefinitions.TimeToLive.Value){const n=await this.openStore(e);return new Promise(e=>{const i=n.put({value:a,[StoreDefinitions.TimeToLive.Name]:new Date(Date.now()+s)},t);i.onerror=t=>{console.error("putItem.onerror: "+t.message),e(void 0)},i.onsuccess=t=>e(t.target.result.value)})}async deleteItem(e,t){const a=await this.openStore(e);return new Promise(e=>{const s=a.delete(t);s.onerror=t=>{console.error("deleteItem.onerror: "+t.message),e()},s.onsuccess=()=>e()})}async removeExpired(e,t){return new Promise((a,s)=>{let n;try{n=e.transaction([t],RW)}catch(e){return void s(e)}const i=StoreDefinitions.TimeToLive.Name,o=n.objectStore(t).index(i),r=IDBKeyRange.upperBound(new Date);o.openCursor(r).onsuccess=t=>{const s=t.target.result;s?(console.log("expired item: "+s.primaryKey),s.delete(),s.continue()):a(e)}})}async clearAllStores(){const e=Object.values(StoreDefinitions.Stores);return Promise.all(e.map(e=>this.cleanStore(e)))}async cleanStore(e){if(!e)return;return(await this.openStore(e)).clear()}}const FIELD_PWD=["P","a","s","s","w","o","r","d"].join("");class Localization{static get isoCode(){return"en-US"}static get Messages(){return Localization.Languages[Localization.isoCode].Messages}static get Tooltips(){return Localization.Languages[Localization.isoCode].Tooltips}static get Buttons(){return Localization.Languages[Localization.isoCode].Buttons}static get Alerts(){return Localization.Languages[Localization.isoCode].Alerts}static get Statuses(){return Localization.Languages[Localization.isoCode].Statuses}static get Languages(){return{"en-US":{Messages:{Title:'Media2Cloud Demo Portal <span style="font-size:0.85rem">by AWS Solutions Team</span>',PwdRequirement:FIELD_PWD+' must be at least <abbr title="eight characters">eight</abbr> characters long and contain <abbr title="one uppercase character">one</abbr> uppercase, <abbr title="one lowercase character">one</abbr> lowercase, <abbr title="one numeric character">one</abbr> number, and <abbr title="one special character">one</abbr> special character.',ResetSendCode:`Please enter the username and press <strong>Send code</strong>. You should receive a 6-digits code in mail in a few minutes. You will need the code to reset the ${FIELD_PWD}.`,ResetPwd:`Please enter the verification code that has sent to your email address and your new ${FIELD_PWD}.`,SolutionName:"AWS Media2Cloud Solution",AboutTab:"About",Mission:"AWS Media2Cloud Solution is designed to help customers to blah...",Design:"Architecture Design goes here...",Team:"Team member goes here...",StatsTab:"Stats",FaceCollectionTab:"FaceCollection",SettingsTab:"Settings",SettingsDesc:"This setting page allows you to configure and fine tune AI/ML settings for each of the Amazon AI services. (Admin privileges required)",DatastoreFeature:"Local Data Store (IndexedDB)",DatastoreFeatureDesc:'Media2Cloud uses <a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API" target="_blank">IndexedDB</a> to cache thumbnail images, datasets, and other settings locally. Click <strong/>Clean up data store</strong> to delete the local data.',RekognitionFeatures:"Amazon Rekognition Settings",RekognitionFeaturesDesc:'<a href="https://aws.amazon.com/rekognition" target="_blank">Amazon Rekognition</a> allows you to detect celebrities, faces, labels, objects or create your own <a href="https://docs.aws.amazon.com/rekognition/latest/dg/collections.html" target="_blank">Face Collection</a> to match faces in your collection.',ComprehendFeatures:"Amazon Comprehend Settings",ComprehendFeaturesDesc:'<a href="https://aws.amazon.com/comprehend/" target="_blank">Amazon Comprehend</a> allows you to extract keyphrases, entities, sentiments, and classification. You can also train your <a href="https://docs.aws.amazon.com/comprehend/latest/dg/custom-entity-recognition.html" target="_blank">Custom Entity Recognizer</a> to identify custom entities for your business needs. Check out this blog post, <a href="https://aws.amazon.com/blogs/machine-learning/build-a-custom-entity-recognizer-using-amazon-comprehend/" target="_blank">Build a custom entity recognizer using Amazon Comprehend</a>.',TranscribeFeatures:"Amazon Transcribe Settings",TranscribeFeaturesDesc:'<a href="https://aws.amazon.com/transcribe/" target="_blank">Amazon Transcribe</a> is a automatic speech recognition (ASR) service. Media2Cloud extracts audio stream from your asset and autmatically create subtitle track using <a href="https://aws.amazon.com/blogs/aws/amazon-transcribe-now-supports-automatic-language-identification/" target="_blank">Amazon Transcribe Automatic Language Identification feature</a>. You can also train a custom language model to improve the ASR result. Check out this blog post, <a href="https://aws.amazon.com/blogs/machine-learning/building-custom-language-models-to-supercharge-speech-to-text-performance-for-amazon-transcribe/" target="_blank">Building custom language models to supercharge speech-to-text performance for Amazon Transcribe</a>. (Note that Custom Language Model currently supports English only.)',TextractFeatures:"Amazon Textract Settings",TextractFeaturesDesc:'<a href="https://aws.amazon.com/textract/">Amazon Textract</a> is an optical character recognition (OCR) service that allows you to extract text and relationship of a document such as PDF file.',AIMLSetting:"AI/ML Settings",AdvanceFeatures:"Advanced Features",CollectionTab:"Collection",UploadTab:"Upload",ReviewAnalysisSettings:"Carefully review the following AI/ML settings that are used to analyze the contents.",Enabled:"Enabled",Disabled:"Disabled",NotSet:"Not set",Search:"Search",Submit:"Submit",SearchDesc:"Fine tune search results by selecting media type(s) such as <strong>Video</strong> or <strong>Photo</strong>, type(s) of categories such as <strong>Known faces</strong> to search Celebrities and Faces found in Face Collection, <strong>Labels</strong> to search Rekognition labels, <strong>Transcript</strong> to search speech to text results, and/or <strong>Content attributes</strong> to search group name and attributes associated with uploaded content. Select <strong>Exact match</strong> to search exact terms",SearchQueryFailed:"Fail to query the search results",ExactMatch:"Exact match",PageSize10:"10 results per page",PageSize30:"30 results per page",PageSize50:"50 results per page",SearchResultDesc:"Search results",Category:"Category",Transcript:"Transcript",KnownFaces:"Known faces",Keyphrases:"Key phrases",Entities:"Entities",VisualText:"Visual text",ContentAttributes:"Content attributes",TranscriptPhrasesEntities:"Transcript, Phrases, & Entities",LabelsModeration:"Labels & Moderation",ContentTab:"Content",VideoTab:"Video",PhotoTab:"Photo",PodcastTab:"Podcast",DocumentTab:"Document",GroupTab:"Group",NoMediaPresent:'You don\'t have any <abbr title="media">{{MEDIATYPE}}</abbr> files in your collection. Navigate to <abbr title="upload">{{UPLOADTAB}} Tab</abbr> to start adding files.',MediaInProcess:"<p><strong>{{BASENAME}}</strong> media is still in process. Please navigate to <strong>{{PROCESSINGTAB}} Tab</strong> to check the progress.</p>",MediaError:"<p><strong>{{BASENAME}}</strong> media has failed to process. Please navigate to <strong>{{PROCESSINGTAB}} Tab</strong> to see more details.</p>",RemoveMedia:"<p/>Removing <strong/>{{BASENAME}}</strong> will <u>delete</u> all proxies, metadata, and records from the collection.</p><p>Would you like to proceed?</p>",ProcessingTab:"Processing",ProcessingDesc:"List of processing jobs",ProcessingError:'Fail to process <abbr title="basename">{{BASENAME}}</abbr>. Navigate to <abbr title="processing">{{PROCESSINGTAB}} Tab</abbr> to check the details.',ErrorDesc:"List of recent error jobs",Name:"Name",Uuid:"Unique Id",Status:"Current status",OverallStatus:"Overall status",DropzoneDesc:"Drag and drop file(s) to the 'drop area' or click on 'Browse files' to select file(s) to start the process. You can drop multiple files or folders. (Note: Folder is supported in Chrome, Firefox, and Edge browsers.)",AttributeDesc:'Associate additional information to the files. The information will be indexed to <a href="https://aws.amazon.com/elasticsearch-service/" target="_blank">Amazon Elasticsearch service</a> and be made available through the search feature.',AnalysisDesc:'Media2Cloud uses various AWS AI services to analyze video, images, audio, and documents. The analysis includes detecting celebrities, faces, labels, moderations, key phrases, entities, sentiments, and transcription. To learn more about AWS AI services, please visit <a href="https://aws.amazon.com/rekognition/" target="_blank">Amazon Rekognition</a>, <a href="https://aws.amazon.com/transcribe/" target="_blank">Amazon Transcribe</a>, and <a href="https://aws.amazon.com/comprehend/" target="_blank">Amazon Comprehend</a>.',FinalizeUploadDesc:'This final upload process assigns an unique ID (uuid) to each file, checks for collision, computes a MD5 checksum of the file, and uses <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/mpuoverview.html" target="_blank">multipart upload</a> to transfer the file to your Amazon S3 Bucket, {{BUCKET}}. Please confirm the final list below and click on \'Start now\' to start the process.',DropFileHere:"Drop file(s) here to start",FileToBeProcessed:"File(s) to be processed:",GroupName:"Specify group name",GroupDesc:"Specify a group name to tie all the files together. You can then search the files by group later on. The group name should only contain alphanumeric, dash, and underscore characters. Leave it blank if you don't want to group them.",AttrDesc:"Attach additional attributes such as author, synopsis, or genre to the files. The attribute is a set of key-value pairs. Key can contain alphanumeric, dash and underscore characters. Value can contain alphanumeric, dash, underscore, comma, period, or percent sign characters. Use encodeURIComponent to encode the value if it contains other characters.",FramebasedDesc:'<span class="text-success">New feature:</span> Frame based analysis uses Amazon Rekognition Image APIs instead of Amazon Rekognition Video APIs to analyze video files. Detections include celebrities, faces, labels, moderations, and texts. (Note: segment and person pathing detections continue to use Amazon Rekognition Video APIs.)',Framebased:"Frame based analysis",FaceCollectionId:"Face Collection",CustomLabelModels:"Custom label model(s)",FrameCaptureMode:"Frame capture mode",FrameCaptureModeNone:"Disable frame capture",FrameCaptureMode1FPS:"1 frame per second",FrameCaptureMode2FPS:"2 frames per second",FrameCaptureMode3FPS:"3 frames per second",FrameCaptureMode4FPS:"4 frames per second",FrameCaptureMode5FPS:"5 frames per second",FrameCaptureMode10FPS:"10 frames per second",FrameCaptureMode12FPS:"12 frames per second",FrameCaptureMode15FPS:"15 frames per second",FrameCaptureModeAllFrames:"Every frame",FrameCaptureModeEveryOtherFrame:"Every other frame",FrameCaptureMode1FramePer2Seconds:"1 frame every 2 seconds",FrameCaptureMode1FramePer5Seconds:"1 frame every 5 seconds",FrameCaptureMode1FramePer10Seconds:"1 frame every 10 seconds",FrameCaptureMode1FramePer30Seconds:"1 frame every 30 seconds",FrameCaptureMode1FramePer1Minute:"1 frame every 1 minute",FrameCaptureMode1FramePer2Minutes:"1 frame every 2 minutes",FrameCaptureMode1FramePer5Minutes:"1 frame every 5 minutes",TextROI:"Text regions of interest",LanguageCode:"Language code",CustomLanguageModel:"Custom Language Model",CustomVocabulary:"Custom vocabulary",CustomEntityRecognizer:"Custom Entity Recognizer",TextRegionOfInterest:"Region of Interest for Amazon Rekognition Text Detection",SelectModel:"Select a model...",SelectModels:"Select model(s)...",SelectFrameCaptureMode:"Auto select...",SelectLanguageCode:"Auto detect language...",SelectCollection:"Select a collection...",MinConfidence:"Min. confidence",Celeb:"Celebrity detection",Label:"Label detection",Face:"Face detection",Facematch:"Face match detection",Person:"Person detection",Moderation:"Moderation detection",Text:"Text detection",Entity:"Entity detection",Keyphrase:"Keyphrase detection",Sentiment:"Sentiment analysis",Topic:"Topic analysis",Document:"Document analysis",Segment:"Shot segment detection",CustomlabelDesc:'<span class="text-success">New feature:</span> With <a href="https://aws.amazon.com/rekognition/custom-labels-features/" target="_blank">Amazon Rekognition Custom Labels Feature</a>, you can quickly train a computer vision (CV) model such as image classification or object detection model to identify objects or classes based on your business needs. Select up to <strong>{{MAX_CUSTOMALBELMODELS}}</strong> models. Check out this GitHub sample solution, <a href="https://github.com/aws-samples/amazon-rekognition-custom-brand-detection" target="_blank">Building brand (custom object) detection demo</a>.',Customlabel:"Custom label detection",ComprehendInCertainLanguage:"** Comprehend features may not be available in certain languages",Summary:"Summary",Source:"Source",FileName:"Name",FileSize:"Size",FileType:"Type",LastModified:"Last modified",Destination:"Destination",Bucket:"Bucket",Key:"Key",Attributes:"Attributes",UploadStatus:"Upload status",ValidateUuid:"Validate uuid",ComputeChecksum:"Compute checksum",UploadS3:"Upload to S3",VideoCategory:"Video category",PhotoCategory:"Photo category",PodcastCategory:"Podcast category",DocumentCategory:"Document category",GroupCategory:"Group category",CelebrityCategory:"Celebrity category",LoadMore:"Load more...",NoMoreData:"No more data...",NoData:"No relevant data...",GeneralGroup:"General",ProxyGroup:"Proxies",MediaInfoGroup:"MediaInfo",EXIFGroup:"EXIF",BasicGroup:"Basic",GPSGroup:"GPS",PDFGroup:"PDF Info",OthersGroup:"Others",TechnicalGroup:"Technical",SourceTab:"Source",ProxiesTab:"Proxies",MediainfoTab:"Mediainfo",ImageinfoTab:"EXIF Info",Basic:"Basic",GPS:"GPS",ShowMap:"Show location",More:"More...",DocinfoTab:"Docinfo",AnalysisGroup:"Analysis",StatisticsTab:"Statistics",SearchResultTab:"Search Results",ReAnalyzeTab:"Re-Analyze",SummaryTab:"Summary",WorkflowHistory:"AWS Step Functions (workflow history)",Rekognition:"Amazon Rekognition",Comprehend:"Amazon Comprehend",Transcribe:"Amazon Transcribe",Textract:"Amazon Textract",Labels:"Labels",DownlaodJson:"Download JSON",TranscribeTab:"Transcribe",ImageCaptionTab:"Captioning",CelebTab:"Celebrity",LabelTab:"Label",FaceMatchTab:"Face Match",FaceTab:"Face",PersonTab:"Person",SegmentTab:"Segment",TextTab:"Text",ModerationTab:"Moderation",KeyphraseTab:"Keyphrase",EntityTab:"Entity",SentimentTab:"Sentiment",TopicTab:"Topic",ClassificationTab:"Classification",TextractTab:"Textract",CustomLabelTab:"Custom label",EnableAll:"Enable all labels",ToggleAll:"Toggle all labels",TranscriptionJob:"Transcription Job",SubtitleSwitch:"Turn subtitle on/off",DownloadEDLDesc:"Media2Cloud converts AI/ML detection results to Edit Decision List (EDL) format that allows you to import the detection results as timelines into popular editing software.",ScatterGraphDesc:"Toggle a legend to show or hide data points of the selected label. Click on individual data point to seek to the timestamp on the video to see the detection results.",SearchSpecificLabel:"(Search specific label)",Row:"Row",Rows:"Rows",Table:"Table",Tables:"Tables",KeyValueSets:"Key Value Sets",Lines:"Lines",Page:"Page",ToolsGroup:"Tools",SnapshotTab:"Snapshot",EnableSnapshot:"Enable snapshot",DoneSnapshot:"Done snapshot",CaptureImage:"Capture image",SelectLabels:"Select label(s)...",SelectNone:"Deselect all",SelectAll:"Select all",StatsDesc:"Provide overall and categorized statistics of your collection.",OverallStats:"Overall stats",TotalCount:"Total number of media per category",TotalSize:"Total sizes of media per category",WorkflowStatuses:"Overview of workflow statuses",MostRecentStats:"Most recently ingested media",Aggregations:"Aggregations of AI/ML metadata",TopKnownFaces:"Top known faces in library",TopLabels:"Top labels in library",TopModerations:"Top moderation labels in library",TopKeyphrases:"Top keyphrases in library",TopEntities:"Top entities in library",LongestFile:"Longest duration in library",LargestFile:"Largest filesize in library",FaceCollectionDesc:"Create, view and manage your Amazon Rekognition Face Collection(s).",AvailableFaceCollections:"List of available face collection(s)",IndexedFacesInCollection:"Indexed faces found in <strong>{{FACE_COLLECTION}}</strong> collection",SelectFaceCollection:"Select a face collection...",Alternatively:"Alternatively,",EnableSnapshotMode:"Snapshot mode",UserManagementTab:"User Management",UserManagementDesc:'The page provides a simple way to manage users and control user accesses to the Media2Cloud solution web portal. The user directory is managed by <a href="https://aws.amazon.com/cognito/" target="_blank">Amazon Cognito User Pool</a>. (Administrator privilege required.) Alternatively, you can manage your user directory from <a href="{{CONSOLE_USERPOOL}}" target="_blank">Amazon Cognito User Pools Console</a>.',Username:"Username",Email:"Email",Group:"Group",Permission:"Permission",RemoveUser:"Remove user?",PermissionViewer:"Can view assets",PermissionCreator:"Can view and ingest assets",PermissionAdmin:"Full admin access",CurrentUsers:"List of current user(s)",CreateNewUsers:"Create new user(s)",CreateNewUsersDesc:"To add a new user, click on <strong>{{ADD_EMAIL}}</strong> button, enter a valid <em>email address</em>, assign user to a <em>group</em>, and (optionally) specify an <em>username</em>. Repeat the process to add multiple users. When you are ready, click on <strong>{{CONFIRM_AND_ADD}}</strong> button to create the user(s).",ImageCaptionDesc:'(Image caption generated by BLIP: Bootstrapping Language-Image Pre-training for Unified Vision-Language Understanding and Generation machine learning model. Learn more about <a href="https://arxiv.org/abs/2201.12086" target="_blank">BLIP</a>)'},Tooltips:{VisitSolutionPage:"Visit AWS Solutions page",Logout:"ready to logout?",RemoveMedia:"Remove media from collection",MinConfidence:"Set the minimum confidence level for various Amazon Rekognition detection(s) to return the result set",FaceColection:"Uses Amazon Rekognition Face Collection",CustomLabelModels:"Uses Amazon Rekognition Custom Labels feature",FrameCaptureMode:"Define frame interval to run Custom Labels detection",TextROI:"Define the regions of interest to run Amazon Rekognition Text detection",LanguageCode:"Specify language code to run Amazon Transcribe",CustomLanguageModel:"Uses Amazon Transcribe Custom Language Model (English only)",CustomVocabulary:"Uses Amazon Transcribe Custom Vocabulary",CustomEntityRecognizer:"Uses Amazon Comprehend Custom Entity Recognizer",TextRegionOfInterest:"Define region of interest for Amazon Rekognition Text Detection",Celeb:"Uses Amazon Rekognition celebrity recognition detection",Label:"Uses Amazon Rekognition label detection",Face:"Uses Amazon Rekognition face detection",Facematch:"Uses Amazon Rekognition face search to match indexed faces in your own face collection",Person:"Uses Amazon Rekognition person pathing detection",Moderation:"Uses Amazon Rekognition moderation detection",Text:"Uses Amazon Rekognition text detection to extract texts from images and videos",Customlabel:"Uses Amazon Rekognition Custom Labels to detect objects",Framebased:"Opt in to use Amazon Rekognition Image APIs",Transcribe:"Uses Amazon Transcribe to convert speech to text from audio file or track",Entity:"Uses Amazon Comprehend to extract entities such as locations, dates, and quantities from the transcription",Keyphrase:"Uses Amazon Comprehend to extract key phrases from the transcription",Sentiment:"Uses Amazon Comprehend to analyze sentiments of the phrases from the transcription",Topic:"Uses Amazon Comprehend to analyze topics of the phrases from the transcription",Document:"Uses Amazon Textract to extract form, key-value pairs, and texts from documents",SetAsDefault:"Save settings as default on your local browser",RestoreOriginal:"Restore settings to the originals",ApplyToAllUsers:"Store settings globally and apply to all users",RemoveFromList:"Remove file from the list?",UploadOnly:"File will be uploaded but won't be analyzed",ViewOnAWSConsole:"view on console",ViewJobOnAWSConsole:"View job on AWS Console",DownloadFile:"download file",DeveloperWarning:"To remove 'For development purposes only' message, go to 'Settings' page, enter your Google Map API Key, and refresh the page.",Confidence:"Confidence",DeleteImage:"Delete image",SelectMultipleItems:"Select multiple items",PreviewMedia:"Preview media",RefreshStats:"Refresh stats",RemoveFaceFromCollection:"Remove face from collection",RemoveFaceCollection:"Delete the entire face collection!",IndexFace:"Enter a name of the cropped face and select a face collection to store the face",RemoveUserFromCognito:"Remove user from user directory",RefreshUserTable:"Fetch users from Amazon Cognito User Pool again"},Buttons:{Back:"Back",Next:"Next",Cancel:"Cancel",Close:"Close",Done:"Done",QuickUpload:"Quick upload",Startover:"Start over",StartNow:"Start now",Remove:"Remove",BrowseFiles:"Browse files",SetAsDefault:"Save as default",RestoreOriginal:"Restore original settings",ApplyToAllUsers:"Apply settings to all users",DownloadSummary:"Download summary",ClosePreview:"Close preview window",DownloadEDL:"Download EDL Package",Refresh:"Refresh",CreateNewCollection:"Create new collection",RemoveFaceCollection:"Delete face collection",IndexFace:"Index face",CleanupDatastore:"Clean up data store",ReAnalyzeContent:"Re-run AI/ML analysis",AddEmail:"Add email",ConfirmAndAddUsers:"Confirm and add users"},Statuses:{NotStarted:"Not started",Queuing:"Queuing",Waiting:"Waiting",Processing:"Processing",Completed:"Completed",Error:"Error",Total:"Total"},Alerts:{Oops:"Oops...",Warning:"Warning",Confirmed:"Confirmed",PwdConformance:`${FIELD_PWD} doesn't conform with the requirements. Please make sure the ${FIELD_PWD} is at least 8 characters, 1 uppercase, 1 lowercase, 1 numeric, and 1 special character.`,UsernameConformance:"Username don't conform with the requirements. Please make sure the username only contains alphanumeric and/or '.', '_', '%', '+', '-' characters",SignInProblem:"Problem to sign in. Please try again.",MismatchPwds:`${FIELD_PWD} doesn't match. Please re-enter the ${FIELD_PWD}`,PwdConfirmed:`Your new ${FIELD_PWD} has been set. Please re-sign in to the portal.`,SessionExpired:"Session expired. Please sign in again.",NoValidFile:"No valid file has been imported.",FileTypeNotSupported:"File type is not supported",FileCannotImported:"A few files cannot be imported.",InvalidGroupName:"Invalid group name. <strong>Group Name</strong> can contain alphnumeric, dash, or underscore characters and must be less than 128 characters.",InvalidKeyValue:"Invalid key or value. <strong>Key</strong> can contain alphnumeric, dash, or underscore characters and must be less than 128 characters. <strong>Value</strong> can contain alphanumeric, dash, underscore, comma, period, or percent sign characters and must be less than 255 characters",MaxNumOfAttrs:"You can add at most 20 attributes.",CreateUuidError:"fail to create an unique uuid...",ComputeChecksumError:"fail to compute MD5 checksum...",UploadS3Error:"fail to upload file to S3 bucket...",StartWorkflowError:"fail to start ingest workflow...",InvalidFaceCollectionName:"Face Collection name can only contain alphnumeric, period, dash, and underscore characters and be less than 255 characters",InvalidIndexedName:"Name can only contain alphnumeric, space, period, dash, and underscore characters and be less than 255 characters",InvalidFaceCollectionSelection:"Make sure to select a face collection. If you don`t have any face collection, navigate to <strong>FaceCollection Tab</strong> to create one.",ConfirmFaceIndexed:"<strong>{{NAME}}</strong> has successfully added to <strong>{{FACECOLLECTION}}</strong> collection!",ReAnalzyeFailed:"Fail to re-run AI/ML analysis process for <strong>{{BASENAME}}</strong> media.",ReAnalyzeSubmitted:"Re-runing the AI/ML analysis process for <strong>{{BASENAME}}</strong> media.",DeleteMediaNotAllowed:"You don't have permission to delete the media.",InvalidEmailAddress:"Invalid email address",NoNewUsers:"No user to add",FailAddingUsers:"Problem adding the following users: {{USERS}}"}}}}}const ID_DEMOAPP$3="#demo-app",ID_EVENTSOURCE="cognito-"+AppUtils.randomHexstring(),ON_SESSION_REFRESH="cognito:session:refresh",ON_SESSION_SIGNIN="cognito:session:signin",ON_SESSION_SIGNOUT="cognito:session:signout",ATTR_COGNITO_GROUPS="cognito:groups";class CognitoConnector{constructor(){this.$user=void 0,this.$assignedGroup=void 0,this.$sessionTimer=void 0,this.$userPool=new AmazonCognitoIdentity.CognitoUserPool({UserPoolId:SolutionManifest.Cognito.UserPoolId,ClientId:SolutionManifest.Cognito.ClientId}),AWS.config.region=SolutionManifest.Region,this.$eventSource=$("<div/>").attr("id",ID_EVENTSOURCE),$("#demo-app").append(this.$eventSource)}static getSingleton(){return window.AWSomeNamespace.CognitoConnectorSingleton||(window.AWSomeNamespace.CognitoConnectorSingleton=new CognitoConnector),window.AWSomeNamespace.CognitoConnectorSingleton}static get Events(){return{Session:{SignIn:ON_SESSION_SIGNIN,SignOut:ON_SESSION_SIGNOUT,Refresh:ON_SESSION_REFRESH}}}get eventSource(){return this.$eventSource}get user(){return this.$user}set user(e){this.$user=e}get userPool(){return this.$userPool}set userPool(e){this.$userPool=e}get isAnonymousUser(){return!this.userPool.getCurrentUser()}get sessionTimer(){return this.$sessionTimer}set sessionTimer(e){this.$sessionTimer=e}get assignedGroup(){return this.$assignedGroup}set assignedGroup(e){this.$assignedGroup=e}getCognitoIdpEndpoint(){return`cognito-idp.${SolutionManifest.Region}.amazonaws.com/${SolutionManifest.Cognito.UserPoolId}`}async getUserSession(e){return new Promise((t,a)=>{const s=e||this.user;s?s.getSession((e,s)=>e?a(new Error(e)):t(s)):a(new Error("no current user"))})}async checkStatus(){if(this.user=this.userPool.getCurrentUser(),!this.user)throw new Error("no current user");if(!(await this.getUserSession(this.user)).isValid()){const e=this.user.username;throw this.user.signOut(),this.user=void 0,this.assignedGroup=void 0,Error("session expired for "+e)}return this.user}async onSuccess(e,t,a){return console.log(this.user.username+" logged in"),e({status:"completed"})}async onFailure(e,t,a){return this.user=void 0,this.assignedGroup=void 0,t(new Error(a.message))}async newPasswordRequired(e,t,a,s){e({status:"newPasswordRequired",userAttributes:a,requiredAttributes:s})}async confirmNewPassword(e){return new Promise((t,a)=>{this.user.completeNewPasswordChallenge(e,{},{onSuccess:this.onSuccess.bind(this,t,a),onFailure:this.onFailure.bind(this,t,a)})})}async authenticate(e){return new Promise((t,a)=>{["Username","Password"].filter(e=>!e).length&&a(new Error("invalid username or password"));const s=new AmazonCognitoIdentity.AuthenticationDetails({Username:e.Username,Password:e.Password});this.user=new AmazonCognitoIdentity.CognitoUser({Username:e.Username,Pool:this.userPool}),this.user.authenticateUser(s,{onSuccess:this.onSuccess.bind(this,t,a),onFailure:this.onFailure.bind(this,t,a),newPasswordRequired:this.newPasswordRequired.bind(this,t,a)})})}async getCredentials(){const e=this.user.getSignInUserSession().getIdToken(),t=this.getCognitoIdpEndpoint(),a={IdentityPoolId:SolutionManifest.Cognito.IdentityPoolId,Logins:{[t]:e.getJwtToken()}},s=new AWS.CognitoIdentityCredentials(a,{region:SolutionManifest.Region});return new Promise(t=>{s.getPromise().then(()=>{AWS.config.credentials=s,AWS.config.region=SolutionManifest.Region,this.assignedGroup=(e.payload["cognito:groups"]||[])[0],this.monitorSession(e.getExpiration()),t(s)})})}static toStringFromMsecs(e){return`${Math.floor(e/36e5).toString().padStart(2,"0")}:${Math.floor(e%36e5/6e4).toString().padStart(2,"0")}:${Math.floor(e%6e4/1e3).toString().padStart(2,"0")}.${Math.ceil(e%1e3).toString().padStart(3,"0")}`}signOut(){const e=this.user.username;this.user.signOut(),AWS.config.credentials=void 0,this.eventSource.trigger(CognitoConnector.Events.Session.SignOut,[e])}async signIn(){await this.checkStatus();const e=await this.getCredentials();return this.eventSource.trigger(CognitoConnector.Events.Session.SignIn,[e]),this.user}async refreshSession(){const e=await this.getUserSession();await new Promise((t,a)=>{this.user.refreshSession(e.refreshToken,(e,s)=>e?a(new Error(e)):t(s))});const t=await this.getCredentials();return this.eventSource.trigger(CognitoConnector.Events.Session.Refresh,[t]),t}monitorSession(e){const t=new Date(1e3*e),a=t-new Date-1e4;console.log(`schedule to refresh session in ${CognitoConnector.toStringFromMsecs(a)} (${t.toISOString()})`),this.sessionTimer&&clearTimeout(this.sessionTimer),this.sessionTimer=setTimeout(async()=>this.refreshSession().catch(e=>console.error(encodeURIComponent(e.message))),a)}async forgotPasswordFlow(e={}){return new Promise((t,a)=>{e.Username||a(new Error("invalid username")),this.user=new AmazonCognitoIdentity.CognitoUser({Username:e.Username,Pool:this.userPool}),this.user.forgotPassword({onSuccess:this.onSuccess.bind(this,t,a),onFailure:this.onFailure.bind(this,t,a),inputVerificationCode:this.inputVerificationCode.bind(this,t,a)})})}async inputVerificationCode(e,t,a){e({status:"inputVerificationCode",data:a})}async confirmPassword(e,t){return new Promise((a,s)=>{this.user.confirmPassword(e,t,{onSuccess:this.onSuccess.bind(this,a,s),onFailure:this.onFailure.bind(this,a,s)})})}canRead(){return void 0!==this.assignedGroup}canWrite(){return this.assignedGroup===SolutionManifest.Cognito.Group.Admin||this.assignedGroup===SolutionManifest.Cognito.Group.Creator}canModify(){return this.assignedGroup===SolutionManifest.Cognito.Group.Admin}}const MediaTypes={Video:"video",Audio:"audio",Image:"image",Podcast:"audio",Photo:"image",Document:"document",Group:"group",Celebrity:"celebrity",Unknown:"unknown"},ENDPOINTS={Asset:`${SolutionManifest.ApiEndpoint}/${SolutionManifest.ApiOps.Assets}`,Analysis:`${SolutionManifest.ApiEndpoint}/${SolutionManifest.ApiOps.Analysis}`,Search:`${SolutionManifest.ApiEndpoint}/${SolutionManifest.ApiOps.Search}`,Execution:`${SolutionManifest.ApiEndpoint}/${SolutionManifest.ApiOps.Execution}`,AttachIot:`${SolutionManifest.ApiEndpoint}/${SolutionManifest.ApiOps.AttachPolicy}`,FaceCollections:`${SolutionManifest.ApiEndpoint}/${SolutionManifest.ApiOps.FaceCollections}`,FaceCollection:`${SolutionManifest.ApiEndpoint}/${SolutionManifest.ApiOps.FaceCollection}`,Faces:`${SolutionManifest.ApiEndpoint}/${SolutionManifest.ApiOps.Faces}`,Face:`${SolutionManifest.ApiEndpoint}/${SolutionManifest.ApiOps.Face}`,CustomLabelModels:`${SolutionManifest.ApiEndpoint}/${SolutionManifest.ApiOps.CustomLabelModels}`,CustomVocabularies:`${SolutionManifest.ApiEndpoint}/${SolutionManifest.ApiOps.CustomVocabularies}`,CustomLanguageModels:`${SolutionManifest.ApiEndpoint}/${SolutionManifest.ApiOps.CustomLanguageModels}`,CustomEntityRecognizers:`${SolutionManifest.ApiEndpoint}/${SolutionManifest.ApiOps.CustomEntityRecognizers}`,Stats:`${SolutionManifest.ApiEndpoint}/${SolutionManifest.ApiOps.Stats}`,Users:`${SolutionManifest.ApiEndpoint}/${SolutionManifest.ApiOps.Users}`,AIOptionsSettings:`${SolutionManifest.ApiEndpoint}/${SolutionManifest.ApiOps.AIOptionsSettings}`};class ApiHelper{static async scanRecords(e){return AppUtils.authHttpRequest("GET",ENDPOINTS.Asset,e)}static async getRecord(e){return AppUtils.authHttpRequest("GET",`${ENDPOINTS.Asset}/${e}`)}static async purgeRecord(e){return AppUtils.authHttpRequest("DELETE",`${ENDPOINTS.Asset}/${e}`)}static async getAnalysisResults(e){return AppUtils.authHttpRequest("GET",`${ENDPOINTS.Analysis}/${e}`)}static async attachIot(){return AppUtils.authHttpRequest("POST",ENDPOINTS.AttachIot)}static async search(e){return AppUtils.authHttpRequest("GET",ENDPOINTS.Search,e)}static async searchInDocument(e,t){return AppUtils.authHttpRequest("GET",`${ENDPOINTS.Search}/${e}`,t)}static async startIngestWorkflow(e,t){return AppUtils.authHttpRequest("POST",ENDPOINTS.Asset,t,e)}static async startAnalysisWorkflow(e,t,a){return AppUtils.authHttpRequest("POST",`${ENDPOINTS.Analysis}/${e}`,a,t)}static async startWorkflow(e,t){return AppUtils.authHttpRequest("POST",ENDPOINTS.Asset,t,e)}static async getRekognitionFaceCollections(){return AppUtils.authHttpRequest("GET",ENDPOINTS.FaceCollections)}static async getRekognitionCustomLabelModels(){return AppUtils.authHttpRequest("GET",ENDPOINTS.CustomLabelModels)}static async getTranscribeCustomVocabulary(){return AppUtils.authHttpRequest("GET",ENDPOINTS.CustomVocabularies)}static async getTranscribeCustomLanguageModels(){return AppUtils.authHttpRequest("GET",ENDPOINTS.CustomLanguageModels)}static async getComprehendCustomEntityRecognizers(){return AppUtils.authHttpRequest("GET",ENDPOINTS.CustomEntityRecognizers)}static async getStats(e){return AppUtils.authHttpRequest("GET",ENDPOINTS.Stats,e)}static async getFaceCollections(){return AppUtils.authHttpRequest("GET",ENDPOINTS.FaceCollections)}static async createFaceCollection(e){return AppUtils.authHttpRequest("POST",ENDPOINTS.FaceCollection,void 0,{collectionId:e})}static async deleteFaceCollection(e){return AppUtils.authHttpRequest("DELETE",ENDPOINTS.FaceCollection,{collectionId:e})}static async getFacesInCollection(e,t){const a=t.token?encodeURIComponent(t.token):void 0;return AppUtils.authHttpRequest("GET",ENDPOINTS.Faces,{...t,token:a,collectionId:e})}static async deleteFaceFromCollection(e,t){return AppUtils.authHttpRequest("DELETE",ENDPOINTS.Face,{collectionId:e,faceId:t})}static async indexFaceToCollection(e,t){return AppUtils.authHttpRequest("POST",ENDPOINTS.Face,void 0,{...t,collectionId:e})}static async getUsers(){return AppUtils.authHttpRequest("GET",ENDPOINTS.Users)}static async addUsers(e){return AppUtils.authHttpRequest("POST",ENDPOINTS.Users,void 0,e)}static async deleteUser(e){return AppUtils.authHttpRequest("DELETE",ENDPOINTS.Users,{user:e})}static async getGlobalAIOptions(){return AppUtils.authHttpRequest("GET",ENDPOINTS.AIOptionsSettings)}static async setGlobalAIOptions(e){return AppUtils.authHttpRequest("POST",ENDPOINTS.AIOptionsSettings,void 0,e)}static async deleteGlobalAIOptions(){return AppUtils.authHttpRequest("DELETE",ENDPOINTS.AIOptionsSettings)}}class S3Utils{static get Constants(){return{Expiration:7200}}static getInstance(e){return new AWS.S3({apiVersion:"2006-03-01",computeChecksums:!0,signatureVersion:"v4",s3DisableBodySigning:!1,useAccelerateEndpoint:!!(SolutionManifest.S3||{}).UseAccelerateEndpoint,customUserAgent:SolutionManifest.CustomUserAgent,...e})}static signUrl(e,t){return S3Utils.getInstance().getSignedUrl("getObject",{Bucket:e,Key:t,Expires:S3Utils.Constants.Expiration})}static async getObject(e,t){return S3Utils.getInstance().getObject({Bucket:e,Key:t,ExpectedBucketOwner:SolutionManifest.S3.ExpectedBucketOwner}).promise()}static async listObjects(e,t){const a=[],s=S3Utils.getInstance();let n;do{n=await s.listObjectsV2({Bucket:e,Prefix:t,MaxKeys:100,ContinuationToken:(n||{}).NextContinuationToken,ExpectedBucketOwner:SolutionManifest.S3.ExpectedBucketOwner}).promise(),a.splice(a.length,0,...n.Contents)}while((n||{}).NextContinuationToken);return a}static async upload(e,t,a,s){return S3Utils.getInstance().upload({Bucket:e,Key:t,Body:a,ContentType:s,ExpectedBucketOwner:SolutionManifest.S3.ExpectedBucketOwner}).promise()}static async deleteObject(e,t){return S3Utils.getInstance().deleteObject({Bucket:e,Key:t,ExpectedBucketOwner:SolutionManifest.S3.ExpectedBucketOwner}).promise()}}class BaseStore{constructor(e){this.$storeName=e,this.$db=LocalStoreDB.getSingleton()}get storeName(){return this.$storeName}get db(){return this.$db}async getItem(e){return this.db.getItem(this.storeName,e)}async putItem(e,t){return this.db.putItem(this.storeName,e,t)}async deleteItem(e){return this.db.deleteItem(this.storeName,e)}}class ImageStore extends BaseStore{constructor(){super(StoreDefinitions.Stores.Images)}static getSingleton(){return(window.AWSomeNamespace||{}).ImageStoreSingleton||(window.AWSomeNamespace={...window.AWSomeNamespace,ImageStoreSingleton:new ImageStore}),window.AWSomeNamespace.ImageStoreSingleton}async getImageURL(e,t,a){let s=await this.getItem(e);if(!s){const n=await S3Utils.getObject(t,a);s=new Blob([n.Body.buffer],{type:n.ContentType}),await this.putItem(e,s)}return URL.createObjectURL(s)}async getBlob(e){let t=await this.getItem(e);if(!t){if(t=await fetch(e).then(e=>{if(!e.ok)return;const t=(e.headers.get("Content-Type")||"").split("/").shift();return t&&"image"===t.toLowerCase()?e.blob():void 0}),!t)return;await this.putItem(e,t)}return URL.createObjectURL(t)}}class DatasetStore extends BaseStore{constructor(){super(StoreDefinitions.Stores.Dataset)}static getSingleton(){return(window.AWSomeNamespace||{}).DatasetStoreSingleton||(window.AWSomeNamespace={...window.AWSomeNamespace,DatasetStoreSingleton:new DatasetStore}),window.AWSomeNamespace.DatasetStoreSingleton}async getDataset(e,t){let a=await this.getItem(t).catch(()=>{});return a||(a=await S3Utils.getObject(e,t).then(e=>JSON.parse(e.Body.toString())).catch(()=>{}),a&&await this.putItem(t,a)),a}}const DEFAULT_IMAGE$2="./images/image.png";class BaseMedia extends(mxReadable(class{})){constructor(e){super(),this.$data={...e},this.$analysisResults=void 0,this.$store=ImageStore.getSingleton(),this.$datasetStore=DatasetStore.getSingleton()}get data(){return this.$data}set data(e){this.$data=e}get analysisResults(){return this.$analysisResults}set analysisResults(e){this.$analysisResults=e}get store(){return this.$store}get datasetStore(){return this.$datasetStore}get uuid(){return this.$data.uuid}get type(){return this.$data.type}get lastModified(){return this.$data.lastModified}get lastModifiedISOFormat(){return BaseMedia.isoDateTime(this.lastModified)}get timestamp(){return this.$data.timestamp}get timestampISOFormat(){return BaseMedia.isoDateTime(this.timestamp)}get basename(){return this.$data.basename}get bucket(){return this.$data.bucket}get key(){return this.$data.key}get schemaVersion(){return this.$data.schemaVersion}get storageClass(){return this.$data.storageClass}get fileSize(){return this.$data.fileSize}get readableFileSize(){return BaseMedia.readableFileSize(this.fileSize)}get mime(){return this.$data.mime}get md5(){return this.$data.md5}get proxies(){return this.$data.proxies}get mediainfo(){return this.$data.mediainfo}get imageinfo(){return this.$data.imageinfo}get docinfo(){return this.$data.docinfo}get executionArn(){return this.$data.executionArn}get status(){return this.$data.status}get overallStatus(){return this.$data.overallStatus}get errorMessage(){return this.$data.errorMessage}get aiOptions(){return this.$data.aiOptions}get attributes(){return this.$data.attributes}get duration(){return this.$data.duration}get readableDuration(){return BaseMedia.readableDuration(this.duration)}get proxyBucket(){return(this.$data.destination||{}).bucket}get proxyPrefix(){return(this.$data.destination||{}).prefix}get defaultImage(){return DEFAULT_IMAGE$2}getVideoDimension(){const e=this.mediainfo.media.track.find(e=>"video"===e.$.type.toLowerCase())||{};return{width:e.width||0,height:e.height||0}}async refresh(){const e=await ApiHelper.getRecord(this.uuid),t=e.destination.bucket;if(Array.isArray(e.mediainfo)&&e.mediainfo.length>0){const a=e.mediainfo.find(e=>/\.json$/.test(e));t&&a&&(e.mediainfo=await S3Utils.getObject(t,a).then(e=>JSON.parse(e.Body.toString()).mediaInfo).catch(e=>console.error("[ERR]: fail to get mediainfo. "+encodeURIComponent(e.message))))}else e.imageinfo&&(e.imageinfo=await S3Utils.getObject(t,e.imageinfo).then(e=>JSON.parse(e.Body.toString())).catch(e=>console.error("[ERR]: fail to get imageinfo. "+encodeURIComponent(e.message))));return this.data=e,this.status===SolutionManifest.Statuses.AnalysisCompleted&&await this.getAnalysisResults(!0),this}async setError(){const e=await ApiHelper.getRecord(this.uuid);this.data=e}async getThumbnail(){const e=(this.proxies||[]).filter(e=>"image"===e.type);if(!e.length)return this.defaultImage;const t=AppUtils.randomNumber(e.length-1,0);return this.getImageUrl(this.uuid,this.proxyBucket,e[t].key)}async getImageUrl(e,t,a){return this.store.getImageURL(e,t,a).catch(()=>{})||S3Utils.signUrl(t,a)}async getUrl(e,t){return S3Utils.signUrl(e,t)}getMediainfo(){return this.mediainfo}getImageinfo(){return this.imageinfo}getDocinfo(){return this.docinfo}getProxyBucket(){return this.proxyBucket}async getProxyVideo(){const e=this.proxies.find(e=>"video"===e.type);return e?S3Utils.signUrl(this.proxyBucket,e.key):void 0}async getProxyAudio(){const e=this.proxies.find(e=>"audio"===e.type);return e?S3Utils.signUrl(this.proxyBucket,e.key):void 0}getBasename(e){return e.substring(e.lastIndexOf("/")+1,e.length)}async getProxyImage(){const e=this.proxies.filter(e=>"image"===e.type).sort((e,t)=>t.fileSize-e.fileSize)[0];return e?this.getImageUrl(`${this.uuid}-${this.getBasename(e.key)}`,this.proxyBucket,e.key):this.defaultImage}async getNamedImageUrl(e,t){const a=this.getBasename(t);return{name:a,url:await this.getImageUrl(`${this.uuid}-${a}`,e,t)}}async getProxyNamedImageAll(){const e=this.proxies.filter(e=>"image"===e.type);return e.length?Promise.all(e.map(e=>this.getNamedImageUrl(this.proxyBucket,e.key))):void 0}async getAnalysisResults(e=!1){return this.analysisResults&&!e||(this.analysisResults=await ApiHelper.getAnalysisResults(this.uuid)),this.analysisResults}async getDataset(e,t){return this.datasetStore.getDataset(e,t)}getRekognitionResults(){return(this.analysisResults||[]).map(e=>e.rekognition).filter(e=>e)[0]}getRekognitionImageResults(){return(this.analysisResults||[]).map(e=>e["rekog-image"]).filter(e=>e)[0]}getTranscribeResults(){return(this.analysisResults||[]).map(e=>e.transcribe).filter(e=>e)[0]}getComprehendResults(){return(this.analysisResults||[]).map(e=>e.comprehend).filter(e=>e)[0]}getTextractResults(){return(this.analysisResults||[]).map(e=>e.textract).filter(e=>e)[0]}getImageAutoCaptioning(){return((this.analysisResults||[])[0]||{}).caption}}class VideoMedia extends BaseMedia{}const SUFFIX="_thumbnail";class PhotoMedia extends BaseMedia{get width(){return(this.imageinfo||{}).ImageWidth}get height(){return(this.imageinfo||{}).ImageHeight}async getThumbnail(){const e=(this.proxies||[]).filter(e=>"image"===e.type).sort((e,t)=>e.fileSize-t.fileSize);if(!e.length)return this.defaultImage;let t,a=e[0].key.lastIndexOf(SUFFIX+".jpg");if(a<0){a=e[0].key.lastIndexOf(".jpg");let s=e[0].key.substring(0,a);s=`${s}${SUFFIX}.jpg`,t=await this.store.getImageURL(`${this.uuid}${SUFFIX}`,this.proxyBucket,s).catch(()=>{})}return t||(t=await this.store.getImageURL(this.uuid,this.proxyBucket,e[0].key).catch(()=>{})),t||S3Utils.signUrl(this.proxyBucket,e[0].key)}}const DEFAULT_IMAGE$1="./images/podcast.png";class PodcastMedia extends BaseMedia{get defaultImage(){return DEFAULT_IMAGE$1}}const DEFAULT_IMAGE="./images/document.png";class DocumentMedia extends BaseMedia{constructor(e){super(e),this.$pages=[]}get fingerprint(){return(this.docinfo||{}).fingerprint}get numPages(){return(this.docinfo||{}).numPages}get defaultImage(){return DEFAULT_IMAGE}get pages(){return this.$pages}set pages(e){this.$pages=e}async loadPages(){const e=await this.loadJsonResults();return this.pages=(await Promise.all((e||[]).map(e=>this.loadPageImage(e)))).filter(e=>e),this.pages}async loadJsonResults(){const e=this.getTextractResults();if(!e||!e.output||!e.numOutputs)return;const t=this.getProxyBucket();let a=[];for(let s=0;s<e.numOutputs;s++){const n=this.makeSequnceFileName(s);a.push(S3Utils.getObject(t,`${e.output}${n}`).then(e=>JSON.parse(e.Body.toString()).Documents).catch(e=>console.error(e)))}return a=await Promise.all(a),a.filter(e=>e).reduce((e,t)=>e.concat(t),[])}async loadPageImage(e){const t=this.getProxyBucket();return this.getNamedImageUrl(t,e.FileName).then(t=>({...t,data:e})).catch(e=>console.error(e))}makeSequnceFileName(e){return String(e).padStart(8,"0")+".json"}}class BasePreview{constructor(e,t){this.$ids={container:"preview-"+AppUtils.randomHexstring()},this.$container=$("<div/>").addClass("p-0 m-0 w-100").attr("id",this.$ids.container).attr("data-media-type",e.type),this.$media=e,this.$searchResults=t,this.$preloaded=!1}get ids(){return this.$ids}get container(){return this.$container}get media(){return this.$media}get searchResults(){return this.$searchResults}get preloaded(){return this.$preloaded}set preloaded(e){this.$preloaded=e}getView(){}async preload(){return this}async load(){return this}async unload(){return this.preloaded=!1,this.container.children().remove(),this}async pause(){}async unpause(){}async beforeViewHide(){return this}async viewHidden(){return this}getContainerDimensions(){return{width:this.container.outerWidth(),height:this.container.outerHeight()}}}class VideoPreview extends BasePreview{constructor(e,t){super(e,t),this.$ids={...this.$ids,player:"vjs-"+AppUtils.randomHexstring()},this.$player=void 0,this.$subtitleView=$("<div/>").addClass("lead"),this.$trackCached={},this.$proxyBucket=void 0,this.$mediaType="video/mp4",this.$canvasView=$("<div/>").attr("id","canvas-"+AppUtils.randomHexstring())}static get Events(){return{Track:{Loaded:"v:preview:track:loaded"}}}static get Constants(){return{Subtitle:"subtitle",Track:{Kind:"subtitles"}}}get player(){return this.$player}set player(e){this.$player=e}get subtitleView(){return this.$subtitleView}set subtitleView(e){this.$subtitleView=e}get canvasView(){return this.$canvasView}set canvasView(e){this.$canvasView=e}get trackCached(){return this.$trackCached}set trackCached(e){this.$trackCached=e}get proxyBucket(){return this.$proxyBucket||(this.$proxyBucket=this.media.getProxyBucket()),this.$proxyBucket}set proxyBucket(e){this.$proxyBucket=e}get mediaType(){return this.$mediaType}getSubtitleView(){return this.subtitleView}getVideoPlayer(){return this.player}getView(){return this.player?$("video",this.player.el()):void 0}getCanvasView(){return this.$canvasView}appendSubtitleViewTo(e){return e.append(this.subtitleView),this}async getProxyMedia(){return this.media.getProxyVideo()}async load(){await this.unload();const[e,t]=await Promise.all([this.getProxyMedia(),this.media.getThumbnail()]);this.container.append($("<video/>").addClass("video-js vjs-fluid w-100").attr("id",this.ids.player).attr("controls","controls").attr("preload","metadata").attr("poster",t).attr("crossorigin","anonymous")).append(this.canvasView);const a=this.media.getVideoDimension(),s=a.height>a.width?"16:9":void 0,n=videojs(this.ids.player,{textTrackDisplay:{allowMultipleShowingTracks:!0},aspectRatio:s});n.markers({markers:[]}),n.src({type:this.mediaType,src:e}),n.load(),n.on("play",()=>this.canvasView.children().remove()),this.player=n;const i=(this.media.getTranscribeResults()||{}).vtt;return i&&(this.trackRegister(VideoPreview.Constants.Subtitle,i),await this.trackToggle(VideoPreview.Constants.Subtitle,!0)),super.load()}async unload(){return this.player&&this.player.dispose(),this.player=void 0,this.subtitleView.children().remove(),this.canvasView.children().remove(),super.unload()}async beforeViewHide(){return this.player&&this.player.pause(),super.beforeViewHide()}async play(){return this.player&&(this.canvasView.children().remove(),this.player.play()),this}async pause(){return this.player&&this.player.pause(),this}async seek(e){return this.player&&this.player.currentTime(e),this}getCurrentTime(){return this.player?Math.floor(1e3*this.player.currentTime()+.5):void 0}trackIsSub(e){return"string"==typeof e?e===VideoPreview.Constants.Subtitle:(e||{}).label===VideoPreview.Constants.Subtitle}trackIsEnabled(e){if(this.player){const t=this.player.remoteTextTracks();for(let a of t)if(a.label===e)return"showing"===a.mode}return!1}trackRegister(e,t,a="en"){return this.trackCached[e]={key:t,language:a,loaded:!1},this}trackUnregister(e){return delete this.trackCached[e],this}async trackLoad(e){if(this.player){const t=await this.media.getUrl(this.proxyBucket,this.trackCached[e].key),a=this.player.addRemoteTextTrack({kind:VideoPreview.Constants.Track.Kind,language:this.trackCached[e].language,label:e,src:t},!1);a.off("load"),a.on("load",t=>{const a=t.target.track;a.mode="showing",this.trackIsSub(e)&&(a.off("cuechange"),a.on("cuechange",()=>this.cueChangedEvent(a))),this.trackLoadedEvent(a)})}return this}async trackToggle(e,t){if(this.player){const a=this.player.remoteTextTracks();for(let s of a)if(s.label===e)return s.mode=t?"showing":"hidden",this.markerToggle(s,t)}return t&&this.trackCached[e]&&!this.trackCached[e].loaded?this.trackLoad(e):this}trackLoadedEvent(e){return this.trackCached[e.label].loaded=!0,this.trackIsSub(e)?this.cueToHtml(e):this.markerAdd(e),this.subtitleView.trigger(VideoPreview.Events.Track.Loaded,[e]),this}cueChangedEvent(e){if((e.activeCues||[]).length>0){this.subtitleView.find(`[data-cue-index="${e.activeCues[0].id}"]`).addClass("cue-highlight").siblings().removeClass("cue-highlight")}}cueToHtml(e){for(let t=0;t<e.cues.length;t++){const a=$(e.cues[t].getCueAsHTML()).addClass("d-inline pr-1").attr("data-cue-index",t);a.text(a.text().replace(/-{2}\s/g," ")),this.subtitleView.append(a)}}markerAdd(e){const t=[];for(let a of e.cues)t.push({time:a.startTime,duration:a.endTime-a.startTime,text:e.label,overlayText:e.label});return this.player.markers.add(t),this}markerRemove(e){const t=[],a=this.player.markers.getMarkers();for(let s=0;s<a.length;s++)a[s].overlayText===e.label&&t.push(s);return this.player.markers.remove(t),this}markerToggle(e,t){if(e.label!==VideoPreview.Constants.Subtitle)return t?this.markerAdd(e):this.markerRemove(e)}createTrackFromCues(e,t){if(this.player){const a=this.player.addRemoteTextTrack({kind:"chapters",language:"en",label:e},!1);return t.forEach(e=>a.track.addCue(e)),a.track.mode="hidden",a.track}}}class PodcastPreview extends VideoPreview{constructor(e,t){super(e,t),this.$mediaType="audio/mp4"}async getProxyMedia(){return this.media.getProxyAudio()}}const AnalysisTypes=SolutionManifest.AnalysisTypes;class PhotoPreview extends BasePreview{constructor(e,t){super(e,t),this.$imageView=void 0,this.$canvases={},this.$canvasIndex=PhotoPreview.Constants.Canvas.ZIndex}static get Constants(){return{...BasePreview.Constants,Canvas:{ZIndex:100}}}get imageView(){return this.$imageView}set imageView(e){this.$imageView=e}get canvases(){return this.$canvases}set canvases(e){this.$canvases=e}get canvasIndex(){return this.$canvasIndex}set canvasIndex(e){this.$canvasIndex=e}getView(){return this.imageView}getCanvasesByType(e){return Object.keys(this.canvases).map(t=>this.canvases[t].type===e?this.canvases[t]:void 0).filter(e=>e)}async load(){return this.preloaded?this:this.preload()}async unload(){return this.canvases={},this.canvasIndex=PhotoPreview.Constants.Canvas.ZIndex,this.imageView=void 0,super.unload()}async pause(){this.container.find("div.canvas-list").addClass("collapse")}async unpause(){this.container.find("div.canvas-list").removeClass("collapse")}async preload(){await this.unload();const e=await this.media.getProxyImage();this.imageView=await new Promise(t=>{const a=$("<img/>").addClass("h-600max w-100 img-contain").attr("alt",this.media.basename),s=new Image;s.onload=()=>t(a.attr("src",e)),s.src=e});const t=$("<div/>").addClass("canvas-list");(await this.createCanvases()).forEach(e=>t.append(e));const a=$("<div/>").addClass("overlay-container").append(this.imageView).append(t);return this.container.append($("<div/>").addClass("col-9 p-0 m-0 mx-auto").append(a)),super.preload()}async createCanvases(){const e=this.media.getRekognitionImageResults()||{},t=Object.keys(e);return(await Promise.all(t.map(t=>e[t].output?this.createCanvasesByType(t,e[t].output):void 0))).filter(e=>e)}async createCanvasesByType(e,t){const a=await S3Utils.getObject(this.media.getProxyBucket(),t).catch(()=>{});if(!a)return;const s=JSON.parse(a.Body);return s.CelebrityFaces?this.createCelebCanvas(s):s.FaceDetails?this.createFaceCanvas(s):s.FaceMatches?this.createFaceMatchCanvas(s):s.Labels?this.createLabelCanvas(s):s.ModerationLabels?this.createModerationCanvas(s):s.TextDetections?this.createTextCanvas(s):void 0}createCelebCanvas(e){const t=[];for(;e.CelebrityFaces.length;){const a=e.CelebrityFaces.shift(),s=this.canvasRegister({type:AnalysisTypes.Rekognition.Celeb,name:a.Name,confidence:Number(Number(a.MatchConfidence).toFixed(2)),coord:{y:Number(Number(a.Face.BoundingBox.Top).toFixed(2)),x:Number(Number(a.Face.BoundingBox.Left).toFixed(2)),w:Number(Number(a.Face.BoundingBox.Width).toFixed(2)),h:Number(Number(a.Face.BoundingBox.Height).toFixed(2))}}),n=$("<canvas/>").addClass("image-canvas-overlay collapse").attr("data-canvas-id",s).attr("data-init",!1);t.push(n)}return t}createFaceCanvas(e){const t=[];let a=0;for(;e.FaceDetails.length;){const s=e.FaceDetails.shift(),n=this.canvasRegister({type:AnalysisTypes.Rekognition.Face,name:"Face "+a++,confidence:Number(Number(s.Confidence).toFixed(2)),coord:{y:s.BoundingBox.Top,x:s.BoundingBox.Left,w:s.BoundingBox.Width,h:s.BoundingBox.Height},gender:(s.Gender||{}).Value?`${s.Gender.Value} (${Number(s.Gender.Confidence).toFixed(2)})`:void 0,ageRange:(s.AgeRange||{}).Value?`${s.AgeRange.Low}/${s.AgeRange.High}`:void 0}),i=$("<canvas/>").addClass("image-canvas-overlay collapse").attr("data-canvas-id",n).attr("data-init",!1);t.push(i)}return t}createFaceMatchCanvas(e){const t=[];for(;e.FaceMatches.length;){const a=e.FaceMatches.shift(),s=this.canvasRegister({type:AnalysisTypes.Rekognition.FaceMatch,name:a.Face.ExternalImageId.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),confidence:Number(Number(a.Similarity).toFixed(2)),coord:{y:Number(Number(e.SearchedFaceBoundingBox.Top).toFixed(2)),x:Number(Number(e.SearchedFaceBoundingBox.Left).toFixed(2)),w:Number(Number(e.SearchedFaceBoundingBox.Width).toFixed(2)),h:Number(Number(e.SearchedFaceBoundingBox.Height).toFixed(2))}}),n=$("<canvas/>").addClass("image-canvas-overlay collapse").attr("data-canvas-id",s).attr("data-init",!1);t.push(n)}return t}createLabelCanvas(e){const t=[];for(;e.Labels.length;){const a=e.Labels.shift();let s=a.Parents.map(e=>e.Name);if(s=s.length>0?s.join(", "):"",a.Instances.length>0){let e=0;for(;a.Instances.length;){const n=a.Instances.shift(),i=this.canvasRegister({type:AnalysisTypes.Rekognition.Label,name:`${a.Name} ${e++}`,confidence:Number(Number(n.Confidence).toFixed(2)),coord:{y:n.BoundingBox.Top,x:n.BoundingBox.Left,w:n.BoundingBox.Width,h:n.BoundingBox.Height},parentName:s}),o=$("<canvas/>").addClass("image-canvas-overlay collapse").attr("data-canvas-id",i).attr("data-init",!1);t.push(o)}}else{const e=this.canvasRegister({type:AnalysisTypes.Rekognition.Label,name:a.Name,confidence:Number(Number(a.Confidence).toFixed(2)),coord:void 0,parentName:s}),n=$("<canvas/>").addClass("image-canvas-overlay collapse").attr("data-canvas-id",e).attr("data-init",!1);t.push(n)}}return t}createModerationCanvas(e){const t=[];for(;e.ModerationLabels.length;){const a=e.ModerationLabels.shift();if(!a.ParentName)continue;const s=this.canvasRegister({type:AnalysisTypes.Rekognition.Moderation,name:a.Name,confidence:Number(Number(a.Confidence).toFixed(2)),coord:void 0,parentName:a.ParentName}),n=$("<canvas/>").addClass("image-canvas-overlay collapse").attr("data-canvas-id",s).attr("data-init",!1);t.push(n)}return t}createTextCanvas(e){const t=[];for(;e.TextDetections.length;){const a=e.TextDetections.shift();if("WORD"===a.Type)continue;const s=this.canvasRegister({type:AnalysisTypes.Rekognition.Text,name:a.DetectedText,confidence:Number(Number(a.Confidence).toFixed(2)),coord:{y:a.Geometry.BoundingBox.Top,x:a.Geometry.BoundingBox.Left,w:a.Geometry.BoundingBox.Width,h:a.Geometry.BoundingBox.Height}}),n=$("<canvas/>").addClass("image-canvas-overlay collapse").attr("data-canvas-id",s).attr("data-init",!1);t.push(n)}return t}canvasRegister(e){const t="canvas-"+this.canvasIndex++;return this.canvases[t]={...e,id:t},t}canvasUnregister(e){this.container.find(`[data-canvas-id="${e}"]`).remove(),delete this.canvases[e]}canvasToggle(e,t,a){const s=this.container.find(`[data-canvas-id="${e}"]`);return t?(!1===s.data("init")&&this.canvasInit(s,this.canvases[e],a),s.removeClass("collapse")):s.addClass("collapse"),s}canvasInit(e,t,a){const s=(a||this.imageView).width(),n=(a||this.imageView).height(),i=e[0];i.width=s,i.height=n;const o=e[0].getContext("2d");let r=0,l=0,d=0,c=0;t.coord&&(r=Math.floor(t.coord.w*s),l=Math.floor(t.coord.h*n),d=Math.floor(t.coord.x*s),c=Math.floor(t.coord.y*n));const p=r||l||d||c;p&&(o.strokeStyle="#ffffff",o.moveTo(0,0),o.strokeRect(d,c,r,l),o.fillStyle="rgba(255, 255, 255, 0.2)",o.fillRect(d,c,r,l));const h=[`${t.name} (${t.confidence}%)`,t.gender&&"Gender: "+t.gender,t.ageRange&&"Age: "+t.ageRange,t.parentName&&`(${t.parentName})`].filter(e=>e);let u;switch(p?(u=14,o.textAlign="left",o.textBaseline="top"):(d=.5*s,c=.5*n,u=18,o.textAlign="center",o.textBaseline="middle"),o.font=u+"px sans-serif",t.type){case AnalysisTypes.Rekognition.Celeb:case AnalysisTypes.Rekognition.Label:case AnalysisTypes.Rekognition.Face:case AnalysisTypes.Rekognition.FaceMatch:case AnalysisTypes.Rekognition.Moderation:case AnalysisTypes.Rekognition.Text:default:o.fillStyle="#ffffff"}let m=Math.max(c-h.length*(u+0),2);for(;h.length;)o.fillText(h.shift(),d,m),m+=u+0;return e.data("init",!0),e}}const CANVAS_LIST="canvas-list",CAROUSEL_IMAGE="carousel-image",PAGE_DETAILS="page-details",PAGE_DETAILS_CONTAINER="page-details-container",PAGE_BUTTONS_CONTAINER="page-buttons-container",DATA_PAGEINDEX="data-page-idx",DATA_COORD="data-coord",DATA_BOX="data-box",DATA_CANVAS_ID="data-canvas-id",DATA_CANVAS_TYPE="data-canvas-type",TYPE_LINE="line",TYPE_KEYVAL="keyval",TYPE_CELL="cell";class DocumentPreview extends BasePreview{constructor(e,t){super(e,t),this.$slide=void 0,this.$pageControlContainer=void 0,this.$ids={...this.ids,carousel:"doc-"+AppUtils.randomHexstring()}}get slide(){return this.$slide}set slide(e){this.$slide=e}get pageControlContainer(){return this.$pageControlContainer}set pageControlContainer(e){this.$pageControlContainer=e}getPageControlContainer(){return this.pageControlContainer}slideTo(e){return this.slide.carousel(e)}async load(){return this.preloaded?this:this.preload()}async unload(){return this.pageControlContainer&&this.pageControlContainer.remove(),this.slide&&this.slide.remove(),super.unload()}async preload(){await this.unload();const e=await this.media.loadPages();if(!e||!e.length)return this.noData();const t=$("<div/>").addClass("carousel-inner"),a=$("<div/>").addClass("no-gutters d-flex overflow-auto").addClass(PAGE_BUTTONS_CONTAINER),s=$("<div/>").addClass("col-12 p-0 m-0").addClass(PAGE_DETAILS_CONTAINER);return e.map(e=>this.createPage(e)).forEach((e,n)=>{0===n&&e.carouselItem.addClass("active"),t.append(e.carouselItem),a.append(e.pageButton),s.append(e.pageDetails)}),this.pageControlContainer=$("<div/>").addClass("col-12 my-4 p-0 m-0").append(a).append(s),this.slide=$("<div/>").addClass("carousel slide w-100").attr("data-ride",!1).attr("data-interval",!1).attr("id",this.ids.carousel).append(t),this.container.append($("<div/>").addClass("col-12 p-0 m-0").append(this.slide)),this.preloaded=!0,this}createPage(e){const t=this.creatCarouselItem(e);return{carouselItem:t,...this.createPageControl(e,t)}}creatCarouselItem(e){const t=e.data.PageNum,a=$("<div/>").addClass(CANVAS_LIST),s=$("<img/>").addClass("h-800max img-contain carousel-image").attr("src",e.url).attr("alt","Page "+(t+1)),n=$("<div/>").addClass("overlay-container mx-auto").append(s).append(a);return $("<div/>").addClass("carousel-item").attr(DATA_PAGEINDEX,t).append(n)}createPageControl(e,t){const a=$("<div/>").addClass("col-11 p-0 ml-4 h-600max overflow-auto").addClass(PAGE_DETAILS).addClass("collapse").attr(DATA_PAGEINDEX,e.data.PageNum),s=$("<img/>").addClass("thumbnail d-inline-flex m-3").attr(DATA_PAGEINDEX,e.data.PageNum).attr("src",e.url);s.on("click",async t=>(t.preventDefault(),this.onPageButtonSelected(s,a,e)));const n=this.createLineDetails(t,e.data.Blocks),i=this.createKeyValueDetails(t,e.data.Blocks),o=this.createTableCellDetails(t,e.data.Blocks);return a.append(i).append(o).append(n),{pageButton:s,pageDetails:a}}createLineDetails(e,t){const a=[],s=(t||[]).filter(e=>"LINE"===e.BlockType);for(let t of s)a.push(this.createCanvasButton(e,{text:t.Text,coord:t.Geometry.Polygon,box:t.Geometry.BoundingBox,confidence:t.Confidence,type:"line"}));if(0===a.length)return;return $("<details/>").addClass("ml-1").append($("<summary/>").addClass("my-2").append($("<span/>").addClass("lead-sm text-capitalize").append(`${Localization.Messages.Lines} (${a.length})`))).append(a)}createKeyValueDetails(e,t){const a=[],s=(t||[]).filter(e=>"KEY_VALUE_SET"===e.BlockType),n=[],i=[];for(let e of s)"KEY"===e.EntityTypes[0]?n.push(e):i.push(e);for(;n.length;){const s=n.shift(),o=$("<div/>").addClass("btn-group").attr("role","group").attr("aria-label","KeyValue Set");let r="Blank";if(s.Relationships){r=s.Relationships.filter(e=>"CHILD"===e.Type).reduce((e,t)=>e.concat(t.Ids),[]).reduce((e,a)=>{const s=(t||[]).find(e=>e.Id===a);return s?e.concat(s.Text):e},[]).filter(e=>e).join(" ")}const l=this.createCanvasButton(e,{text:r,coord:s.Geometry.Polygon,box:s.Geometry.BoundingBox,confidence:s.Confidence,type:"keyval"});o.append(l);const d=s.Relationships.filter(e=>"VALUE"===e.Type).reduce((e,t)=>e.concat(t.Ids),[]).shift(),c=this.findAndSplice(i,"Id",d);let p="Blank";if(c&&c.Relationships){p=c.Relationships.filter(e=>"CHILD"===e.Type).reduce((e,t)=>e.concat(t.Ids),[]).reduce((e,a)=>{const s=(t||[]).find(e=>e.Id===a);return s?e.concat(s.Text||s.SelectionStatus):e},[]).filter(e=>e).join(" ")}const h=this.createCanvasButton(e,{text:p,coord:s.Geometry.Polygon,box:s.Geometry.BoundingBox,confidence:s.Confidence,type:"keyval"});h.removeClass("btn-primary").addClass("btn-light"),o.append(h),a.push(o)}if(0===a.length)return;return $("<details/>").addClass("ml-1").append($("<summary/>").addClass("my-2").append($("<span/>").addClass("lead-sm text-capitalize").append(`${Localization.Messages.KeyValueSets} (${a.length})`))).append(a)}createTableCellDetails(e,t){const a=(t||[]).filter(e=>"TABLE"===e.BlockType),s=(t||[]).filter(e=>"CELL"===e.BlockType);let n=0;const i=[];for(;a.length;){const o=a.shift().Relationships.find(e=>"CHILD"===e.Type).Ids;for(;o.length;){const a=this.findAndSplice(s,"Id",o.shift());if(a){let s="Blank";if(a.Relationships){s=a.Relationships.find(e=>"CHILD"===e.Type).Ids.reduce((e,a)=>{const s=t.find(e=>e.Id===a);return s?e.concat(s.Text):e},[]).filter(e=>e).join(" ")}const o=a.RowIndex-1;i[n]||(i[n]=[]),i[n][o]||(i[n][o]=[]);const r=this.createCanvasButton(e,{text:s,coord:a.Geometry.Polygon,box:a.Geometry.BoundingBox,confidence:a.Confidence,type:"cell"});i[n][o].push(r)}}n++}if(0===i.length)return;const o=$("<details/>").addClass("ml-1").append($("<summary/>").addClass("my-2").append($("<span/>").addClass("lead-sm text-capitalize").append(`${Localization.Messages.Tables} (${i.length})`)));return i.forEach((e,t)=>{const a=$("<details/>").addClass("ml-2").append($("<summary/>").addClass("my-1").append($("<span/>").addClass("lead-xs text-captialize").append(`${Localization.Messages.Table} ${t+1} (${e.length} ${Localization.Messages.Rows})`)));e.forEach((e,t)=>{const s=$("<details/>").addClass("ml-3").append($("<summary/>").addClass("my-1").append($("<span/>").addClass("lead-xxs text-captialize").append(`${Localization.Messages.Row} ${t+1}`)));e.forEach(e=>{s.append(e)}),a.append(s)}),o.append(a)}),o}createCanvasButton(e,t={}){const a="control-"+AppUtils.randomHexstring(),s=Number.parseFloat(Number(t.confidence).toFixed(2)),n=`${t.box.Width},${t.box.Height},${t.box.Left},${t.box.Top}`,i=t.coord.reduce((e,t)=>e.concat(t.X,t.Y),[]).join(","),o=$("<button/>").addClass("btn btn-sm btn-primary mb-1 ml-1 text-left").attr("type","button").attr("data-toggle","button").attr("aria-pressed",!1).attr("autocomplete","off").attr("data-placement","bottom").attr(DATA_BOX,n).attr(DATA_COORD,i).attr(DATA_CANVAS_ID,a).attr(DATA_CANVAS_TYPE,t.type).attr("title",`${Localization.Tooltips.Confidence}: ${s}%`).append($("<span/>").addClass("lead-xxs").append(t.text)).tooltip({trigger:"hover"});return o.on("click",async t=>"false"===o.attr("aria-pressed")?this.showCanvas(o,e):this.hideCanvas(o,e)),o}showCanvas(e,t){const a=e.attr(DATA_CANVAS_ID),s=t.find("div.canvas-list");let n=s.find(`canvas[data-canvas-id="${a}"]`).first();if(n.length)return n.removeClass("collapse");const i=t.find("img.carousel-image").first(),[o,r,l,d]=e.attr(DATA_BOX).split(",").map(e=>Number.parseFloat(e)),c=i.width()*o,p=i.height()*r,h=i.width()*l,u=i.height()*d,m=e.attr(DATA_CANVAS_TYPE);return n=$("<canvas/>").addClass("canvas-type-"+m).attr(DATA_CANVAS_ID,a).attr("width",c).attr("height",p).css("left",h).css("top",u).css("position","absolute"),s.append(n),n}hideCanvas(e,t){const a=e.attr(DATA_CANVAS_ID);return t.find("div.canvas-list").find(`canvas[data-canvas-id="${a}"]`).first().addClass("collapse")}onPageButtonSelected(e,t,a){return e.parent().find("img").removeClass("active"),e.addClass("active"),t.parent().find("div.page-details").addClass("collapse"),t.removeClass("collapse"),this.slideTo(a.data.PageNum)}noData(){return this.container.append($("<h5/>").addClass("lead").append(Localization.Messages.NoData)),this}findAndSplice(e,t,a){const s=e.findIndex(e=>e[t]===a);return s<0?void 0:e.splice(s,1).shift()}}class MediaFactory{static async createMedia(e){const t=await ApiHelper.getRecord(e);if(!Object.keys(t).length)throw new Error(e+" contains no data");if(Array.isArray(t.mediainfo)&&t.mediainfo.length>0){const e=await MediaFactory.fetchMediainfo(t);e&&(t.mediainfo=e)}else if(t.imageinfo){const e=await MediaFactory.fetchImageinfo(t);e&&(t.imageinfo=e)}let a;switch(t.type){case MediaTypes.Video:case"mxf":a=new VideoMedia(t);break;case MediaTypes.Audio:a=new PodcastMedia(t);break;case MediaTypes.Image:a=new PhotoMedia(t);break;case MediaTypes.Document:a=new DocumentMedia(t);break;default:throw new Error(`${e} type '${t.type}' not supported`)}return a}static async lazyCreateMedia(e){const t=await ApiHelper.getRecord(e);if(!Object.keys(t).length)throw new Error(e+" contains no data");let a;switch(t.type){case MediaTypes.Video:case"mxf":a=new VideoMedia(t);break;case MediaTypes.Audio:a=new PodcastMedia(t);break;case MediaTypes.Image:a=new PhotoMedia(t);break;case MediaTypes.Document:a=new DocumentMedia(t);break;default:throw new Error(`${e} type '${t.type}' not supported`)}return a}static async createPreviewComponent(e,t){switch(await e.getAnalysisResults(),e.type){case MediaTypes.Video:return new VideoPreview(e,t);case MediaTypes.Audio:return new PodcastPreview(e,t);case MediaTypes.Image:return new PhotoPreview(e,t).preload();case MediaTypes.Document:return new DocumentPreview(e,t).preload();default:return}}static async fetchMediainfo(e){const t=e.destination.bucket,a=e.mediainfo.find(e=>/\.json$/.test(e));return t||a?S3Utils.getObject(t,a).then(e=>JSON.parse(e.Body.toString()).mediaInfo).catch(e=>console.error(e)):void 0}static async fetchImageinfo(e){const t=e.destination.bucket,a=e.imageinfo;return t&&a?S3Utils.getObject(t,a).then(e=>JSON.parse(e.Body.toString())).catch(e=>console.error(e)):void 0}}const ID_DEMOAPP$2="#demo-app",ID_IOTSUBSCRIBE="iotsubscriber-"+AppUtils.randomHexstring(),ON_RECEIVE_MESSAGE="iot:message:received";class IotSubscriber{constructor(){this.$mqtt=void 0,this.$clientId=void 0,this.$connected=!1,this.$eventSource=$("<div/>").attr("id",ID_IOTSUBSCRIBE),$("#demo-app").append(this.$eventSource),this.$cognito=CognitoConnector.getSingleton(),this.registerCognitoEvents()}static getSingleton(){return window.AWSomeNamespace.IotSubscriberSingleton||(window.AWSomeNamespace.IotSubscriberSingleton=new IotSubscriber),window.AWSomeNamespace.IotSubscriberSingleton}static get Event(){return{Message:{Received:ON_RECEIVE_MESSAGE}}}get mqtt(){return this.$mqtt}set mqtt(e){this.$mqtt=e}get clientId(){return this.$clientId}set clientId(e){this.$clientId=e}get eventSource(){return this.$eventSource}get cognito(){return this.$cognito}get connected(){return this.$connected}set connected(e){this.$connected=!!e}async connect(){try{if(this.connected)return;const e=(this.cognito.user||{}).username||"anonymous";this.clientId=`${e}-${AppUtils.randomHexstring()}`,this.mqtt=AWSIoTData.device({region:SolutionManifest.Region,host:SolutionManifest.IotHost,clientId:this.clientId,protocol:"wss",maximumReconnectTimeMs:8e3,debug:!0,accessKeyId:"",secretKey:"",sessionToken:""})}catch(e){return e.message="IotSubscriber.connect: "+encodeURIComponent(e.message),void console.error(e.message)}this.mqtt.on("connect",()=>{console.log(this.clientId+" connected to IoT"),this.mqtt.subscribe(SolutionManifest.IotTopic),this.connected=!0}),this.mqtt.on("reconnect",()=>{console.log(`reconnecting ${this.clientId}...`),this.reconnect()}),this.mqtt.on("error",e=>{console.log("error: iot.error: "+e)}),this.mqtt.on("message",(e,t)=>this.eventSource.trigger(IotSubscriber.Event.Message.Received,[JSON.parse(t.toString())]))}async reconnect(e){try{const{accessKeyId:t="",secretAccessKey:a="",sessionToken:s=""}=e||AWS.config.credentials;await this.mqtt.updateWebSocketCredentials(t,a,s)}catch(e){e.message="error: iot.reconnect: "+encodeURIComponent(e.message),console.error(e.message)}}unsubscribe(){this.mqtt&&this.mqtt.unsubscribe(SolutionManifest.IotTopic,()=>{})}registerCognitoEvents(){this.cognito.eventSource.on(CognitoConnector.Events.Session.SignIn,async(e,t)=>this.connect()),this.cognito.eventSource.on(CognitoConnector.Events.Session.Refresh,async(e,t)=>this.reconnect(t)),this.cognito.eventSource.on(CognitoConnector.Events.Session.SignOut,async(e,t)=>this.unsubscribe())}}const ID_DEMOAPP$1="#demo-app",ON_MEDIAADDED="mediamanager:media:added",ON_MEDIAUPDATED="mediamanager:media:updated",ON_MEDIAERROR="mediamanager:media:error",DEFAULT_PAGESIZE=10,PROCESSINGJOBS_PAGESIZE=20,PAGING_NOTSTARTED=Symbol("Paging not started"),PAGING_NOMOREDATA=Symbol("Paging no more data"),MEDIATYPES=[MediaTypes.Video,MediaTypes.Podcast,MediaTypes.Photo,MediaTypes.Document];class MediaManager{constructor(){this.$eventSource=$("<div/>").attr("id","media-manager-"+AppUtils.randomHexstring()),$("#demo-app").append(this.$eventSource),this.$collection=MEDIATYPES.reduce((e,t)=>({...e,[t]:{nextToken:PAGING_NOTSTARTED,items:[]}}),void 0),this.$overallStatusNextTokens={[SolutionManifest.Statuses.Processing]:PAGING_NOTSTARTED,[SolutionManifest.Statuses.Completed]:PAGING_NOTSTARTED,[SolutionManifest.Statuses.Error]:PAGING_NOTSTARTED},this.$pageSize=10,this.subscribeIot()}static getSingleton(){return window.AWSomeNamespace.MediaManager||(window.AWSomeNamespace.MediaManager=new MediaManager),window.AWSomeNamespace.MediaManager}static get Event(){return{Media:{Added:ON_MEDIAADDED,Updated:ON_MEDIAUPDATED,Error:ON_MEDIAERROR}}}get eventSource(){return this.$eventSource}get collection(){return this.$collection}get pageSize(){return this.$pageSize}set pageSize(e){this.$pageSize=Number.parseInt(e||10,10)}get overallStatusNextTokens(){return this.$overallStatusNextTokens}addMediaToCollection(e){if(!e)return;const t=Array.isArray(e)?e:[e];for(let e of t){const t=e.type;this.collection[t]&&void 0!==this.collection[t].items&&this.collection[t].items.push(e)}return t}getNextTokenByType(e){return(this.collection[e]||{}).nextToken}setNextTokenByType(e,t){this.collection[e].nextToken=t||PAGING_NOMOREDATA}noMoreData(e){return this.getNextTokenByType(e)===PAGING_NOMOREDATA}async scanRecordsByCategory(e){if(this.noMoreData(e))return;const t={pageSize:this.pageSize,type:e},a=this.getNextTokenByType(e);a&&"symbol"!=typeof a&&(t.token=a);const s=await ApiHelper.scanRecords(t);this.setNextTokenByType(e,s.NextToken);const n=await this.batchInsertMedia(s.Items);return this.addMediaToCollection(n),n}async scanRecords(){return(await Promise.all(MEDIATYPES.map(e=>this.scanRecordsByCategory(e)))).reduce((e,t)=>e.concat(t),[])}async scanProcessingRecords(){const e=SolutionManifest.Statuses.Processing,t=await this.scanRecordsByStatus(e,1),a=await this.batchInsertMedia(t.Items);return this.addMediaToCollection(a),a}async scanErrorRecords(){const e=SolutionManifest.Statuses.Error,t=await this.scanRecordsByStatus(e),a=await this.batchInsertMedia(t.Items);return this.addMediaToCollection(a),a}async scanCompletedRecords(){const e=SolutionManifest.Statuses.Completed,t=await this.scanRecordsByStatus(e),a=await this.batchInsertMedia(t.Items);return this.addMediaToCollection(a),a}async scanRecordsByStatus(e,t=20){const a=this.overallStatusNextTokens[e],s={overallStatus:e,pageSize:t};a&&"symbol"!=typeof a&&(s.token=a);const n=await ApiHelper.scanRecords(s);return this.overallStatusNextTokens[e]=n.NextToken||PAGING_NOMOREDATA,n}noMoreProccessingJob(){return this.noMoreDataByStatus(SolutionManifest.Statuses.Processing)}noMoreCompletedJob(){return this.noMoreDataByStatus(SolutionManifest.Statuses.Completed)}noMoreErrorJob(){return this.noMoreDataByStatus(SolutionManifest.Statuses.Error)}noMoreDataByStatus(e){return this.overallStatusNextTokens[e]===PAGING_NOMOREDATA}async batchInsertMedia(e){return(await Promise.all(e.map(e=>this.insertMedia(e)))).filter(e=>e)}async insertMedia(e){if(!(e||{}).uuid)return void console.error("item contains no uuid");if(void 0!==this.findMediaByUuid(e.uuid))return;const t=await MediaFactory.createMedia(e.uuid).catch(e=>e);if(!(t instanceof Error))return t;console.error(encodeURIComponent(t.message))}async removeMedia(e){const t=(e||{}).uuid;if(!t)return console.error("item contains no uuid");await ApiHelper.purgeRecord(t).catch(t=>console.error("fail to remove media "+e.uuid));const a=Object.keys(this.collection);for(;a.length;){const e=a.shift(),s=this.collection[e].items||[],n=s.findIndex(e=>e.uuid===t);if(n>=0)return s.splice(n,1)[0]}}findMediaByType(e){return(this.collection[e]||{}).items||[]}findMediaByUuid(e){const t=Object.keys(this.collection);for(;t.length;){const a=this.findMediaByType(t.shift()).find(t=>t.uuid===e);if(void 0!==a)return a}}findMediaByStatus(e){const t=[],a=Object.keys(this.collection);for(;a.length;){const s=this.findMediaByType(a.shift());t.splice(t.length,0,...s.filter(t=>t.status===e))}return t.filter(e=>e)}findMediaByOverallStatus(e){const t=[],a=Object.keys(this.collection);for(;a.length;){const s=this.findMediaByType(a.shift());t.splice(t.length,0,...s.filter(t=>t.overallStatus===e))}return t.filter(e=>e)}findProcessingMedias(){return this.findMediaByOverallStatus(SolutionManifest.Statuses.Processing)}findCompletedMedias(){return this.findMediaByOverallStatus(SolutionManifest.Statuses.Completed)}findErrorMedias(){return this.findMediaByOverallStatus(SolutionManifest.Statuses.Error)}subscribeIot(){IotSubscriber.getSingleton().eventSource.on(IotSubscriber.Event.Message.Received,async(e,t)=>this.onIotMessage(t))}async onIotMessage(e){let t=this.findMediaByUuid(e.uuid);return t?(e.status!==SolutionManifest.Statuses.AnalysisStarted&&e.status!==SolutionManifest.Statuses.AnalysisCompleted||await t.refresh(),e.status===SolutionManifest.Statuses.IngestStarted||e.status===SolutionManifest.Statuses.IngestCompleted||e.status===SolutionManifest.Statuses.AnalysisStarted||e.status===SolutionManifest.Statuses.AnalysisCompleted?this.eventSource.trigger(MediaManager.Event.Media.Updated,[t]):e.overallStatus===SolutionManifest.Statuses.Error?(await t.setError(),this.eventSource.trigger(MediaManager.Event.Media.Error,[t])):t):(t=await this.insertMedia(e),this.addMediaToCollection(t),t?this.eventSource.trigger(MediaManager.Event.Media.Added,[t]):void 0)}async lazyGetByUuid(e){let t=this.findMediaByUuid(e);return t||(t=await MediaFactory.lazyCreateMedia(e).catch(e=>e),t instanceof Error?void console.error(encodeURIComponent(t.message)):t)}}const CategorySlideComponentEvents={Media:{Selected:"media:selected",Removing:"media:removing",Preview:{Close:"media:preview:close"}}},mxSpinner=e=>class extends e{constructor(...e){super(...e),this.$spinnerId="spinner-"+AppUtils.randomHexstring()}get spinnerId(){return this.$spinnerId}createLoading(){return $("<div/>").addClass("spinner-grow text-secondary loading-4 collapse").attr("id",this.spinnerId).append($("<span/>").addClass("lead-sm sr-only").html("Loading..."))}loading(e=!0){const t=$("#"+this.spinnerId);return e?t.removeClass("collapse"):t.addClass("collapse")}},mxAlert=e=>class extends e{shake(e,t=200){e.addClass("shake-sm").off("webkitAnimationEnd oanimationend msAnimationEnd animationend").on("webkitAnimationEnd oanimationend msAnimationEnd animationend",a=>e.delay(t).removeClass("shake-sm"))}async showMessage(e,t,a,s,n=5e3){return new Promise((i,o)=>{const r=$("<div/>").addClass("up-alert"),l=$("<div/>").addClass("alert alert-dismissible fade show alert-"+t).attr("role","alert").append($("<h4/>").addClass("alert-heading").html(a)).append($("<p/>").html(s)).append($("<button/>").addClass("close").attr("type","button").attr("data-dismiss","alert").attr("aria-label","Close").append($("<span/>").attr("aria-hidden",!0).html("&times;")));let d=setTimeout(()=>{l.alert("close"),d=void 0},n);l.on("close.bs.alert",()=>{clearInterval(d),d=void 0}),l.on("closed.bs.alert",()=>{l.alert("dispose"),r.remove(),i()}),r.append(l),e.append(r)})}};class BaseSlideComponent extends(mxAlert(mxSpinner(class{}))){constructor(){super(),this.$ids={slide:"slide-"+AppUtils.randomHexstring()},this.$slide=$("<div/>").addClass("container p-0 m-0 col-12").append(this.createLoading()),this.$initialized=!1}get ids(){return this.$ids}get slideId(){return this.ids.slide}get slide(){return this.$slide}set slide(e){this.$slide=e}get initialized(){return this.$initialized}set initialized(e){this.$initialized=e}getSlide(){return this.slide}async show(){return this.initialized=!0,this.slide}async hide(){this.slide.children().remove().append(this.createLoading()),this.initialized=!1}async saveData(){return this}async clearData(){return this}async getData(){return this}async showAlert(e,t){return super.showMessage(this.slide,"danger",Localization.Alerts.Oops,e,t)}async createSlide(){return this.slide}on(e,t){return this.slide.on(e,t)}off(e){return this.slide.off(e)}}const DATA_UUID$2="data-uuid",DATA_ROLE$1="data-role",DATA_STATUS="data-status",ROLE_MEDIADESC="media-desc",ROLE_LOADMORE="load-more";class BaseCategorySlideComponent extends BaseSlideComponent{constructor(e,t={}){super(),this.$ids={...super.ids,mediaList:"media-"+AppUtils.randomHexstring()},this.$mediaType=e,this.$displayOptions=t,this.$mediaManager=MediaManager.getSingleton(),this.registerMediaManagerEvents()}static get Events(){return CategorySlideComponentEvents}get mediaType(){return this.$mediaType}get displayOptions(){return this.$displayOptions}get mediaManager(){return this.$mediaManager}async show(){return this.initialized?await this.refreshContent():(this.slide.append(this.createSkeleton()).append(this.createLoading()),await this.delayLoadContent()),super.show()}async delayLoadContent(){setTimeout(async()=>(this.loading(!0),await this.mediaManager.scanRecordsByCategory(this.mediaType),this.loading(!1),this.refreshContent()),10)}registerMediaManagerEvents(){this.mediaManager.eventSource.on(MediaManager.Event.Media.Added,async(e,t)=>this.onMediaAdded(t,!0)),this.mediaManager.eventSource.on(MediaManager.Event.Media.Updated,async(e,t)=>this.onMediaUpdated(t)),this.mediaManager.eventSource.on(MediaManager.Event.Media.Error,async(e,t)=>this.onMediaError(t))}async onMediaAdded(e,t=!1){if(e.type!==this.mediaType)return;const a=this.slide.find("#"+this.ids.mediaList);let s=a.find(`div[data-uuid="${e.uuid}"]`);if(0===s.length){s=await this.createMediaListItem(e);const n=t?a.children().first():a.children().last();s.insertBefore(n)}return s}async onMediaUpdated(e){if(e.type!==this.mediaType)return;const t=this.slide.find("#"+this.ids.mediaList).find(`div[data-uuid="${e.uuid}"]`);let a;return t.length>0&&(t.attr(DATA_STATUS)!==e.overallStatus||e.status===SolutionManifest.Statuses.IngestStarted||e.status===SolutionManifest.Statuses.AnalysisStarted)&&(a=await this.createMediaListItem(e),t.replaceWith(a)),a}async onMediaRemoved(e){await this.mediaManager.removeMedia(e);this.slide.find("#"+this.ids.mediaList).find(`div[data-uuid="${e.uuid}"]`).remove()}async onMediaError(e){if(e.type!==this.mediaType)return;const t=this.slide.find("#"+this.ids.mediaList).find(`div[data-uuid="${e.uuid}"]`);if(t.length>0){const a=await this.createMediaListItem(e);t.replaceWith(a)}const a=Localization.Messages.ProcessingError.replace("{{BASENAME}}",e.basename).replace("{{PROCESSINGTAB}}",Localization.Messages.ProcessingTab);return this.showAlert(a)}createSkeleton(){const e=this.createNoMediaMessage(),t=this.createMediaList();return $("<div/>").addClass("row no-gutters").append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").addClass("collapse").attr("data-role","media-desc").append(e)).append($("<div/>").addClass("col-12 p-0 mx-auto mt-4").append(t))}createNoMediaMessage(){const e=Localization.Messages.NoMediaPresent.replace("{{MEDIATYPE}}",this.mediaType).replace("{{UPLOADTAB}}",Localization.Messages.UploadTab);return $("<p/>").addClass("lead").html(e)}showNoMediaMessage(e=!0){const t=this.slide.find('div[data-role="media-desc"]');return e?t.removeClass("collapse"):t.addClass("collapse")}createMediaList(){return $("<div/>").addClass("row no-gutters").attr("id",this.ids.mediaList)}async refreshContent(){this.loading(!0);const e=this.slide.find("#"+this.ids.mediaList);e.children().remove();const t=this.mediaManager.findMediaByType(this.mediaType).filter(e=>e.overallStatus!==SolutionManifest.Statuses.Error);t?(await Promise.all(t.map(t=>this.createMediaListItem(t,e))),this.showNoMediaMessage(!1)):this.showNoMediaMessage(!0),e.append(this.createLoadMoreMedia()),this.loading(!1)}async createMediaListItem(e,t){const a=await this.createThumbnail(e),s=this.createMediaOverlay(e),n=$("<div/>").addClass("col-3").addClass("media-"+e.overallStatus.toLowerCase()).attr("data-uuid",e.uuid).attr(DATA_STATUS,e.overallStatus).append(a).append(s);return n.off("click").on("click",async t=>(t.preventDefault(),this.slide.trigger(BaseCategorySlideComponent.Events.Media.Selected,[e]))),t&&t.append(n),n}createLoadMoreMedia(){const e=`<svg width="80" height="45" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 45" preserveAspectRatio="none">\n      <g id="${AppUtils.randomHexstring()}"><rect width="80" height="45" stroke="none" stroke-width="1"></rect></g>\n    </svg>`,t="data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(e),a=Localization.Messages.LoadMore,s=$("<div/>").addClass("col-3").attr("data-uuid","load-more").append($("<img/>").addClass("w-100 h-max-12rem").attr("src",t).attr("alt",a)).append($("<div/>").addClass("card-img-overlay category").css("background-color","#777777").append($("<div/>").addClass("h-100 d-flex").append($("<h5/>").addClass("text-white lead m-0 align-self-center").attr("data-role","load-more").append(a)).append($("<i/>").addClass("fas fa-ellipsis-h icon-3 ml-auto my-auto"))));return s.off("click").on("click",async e=>{e.preventDefault(),await this.scanNextByMediaType(),this.mediaManager.noMoreData(this.mediaType)&&this.disableScan(s)}),s}async createThumbnail(e){const t=await e.getThumbnail();return $("<img/>").addClass("w-100 h-max-12rem").css("object-fit",this.displayOptions.objectFit||"contain").attr("src",t).attr("alt",e.basename)}createMediaOverlay(e){const t=$("<div/>").addClass("col-6 p-0 m-0").append($("<h5/>").addClass("lead-s m-0 text-white text-contain").append(AppUtils.shorten(e.basename,54))),a=this.createMediaStatus(e),s=$("<button/>").addClass("btn btn-sm btn-outline-danger lead-sm media-action").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",Localization.Tooltips.RemoveMedia).append($("<i/>").addClass("far fa-trash-alt")).tooltip({trigger:"hover"});s.off("click").on("click",async t=>(t.preventDefault(),t.stopPropagation(),s.tooltip("hide"),this.slide.trigger(BaseCategorySlideComponent.Events.Media.Removing,[e])));const n=$("<button/>").addClass("btn btn-link media-action").append($("<i/>").addClass("far fa-play-circle icon-4")),i=$("<div/>").addClass("row no-gutters h-100").append(t).append(a).append($("<div/>").addClass("col-12 p-0 align-self-end d-flex").append($("<div/>").addClass("col-6 p-0 m-0 mt-auto").append(s)).append($("<div/>").addClass("col-6 p-0 m-0 ml-auto text-right").append(n)));return $("<div/>").addClass("card-img-overlay category p-2").append(i)}createMediaStatus(e){const t=$("<span/>").addClass("lead-xs px-2 text-white text-right bg-dark"),a=$("<div/>").addClass("col-6 p-0 m-0").append($("<div/>").addClass("p-0 m-0 d-flex justify-content-end").append(t));return e.overallStatus===SolutionManifest.Statuses.Completed&&e.duration?(t.append(e.readableDuration),a):e.overallStatus===SolutionManifest.Statuses.Processing?(t.removeClass("bg-dark").addClass("bg-primary").append(Localization.Statuses.Processing),a):e.overallStatus===SolutionManifest.Statuses.Error?(t.removeClass("bg-dark").addClass("bg-danger").append(Localization.Statuses.Error),a):void 0}async scanNextByMediaType(){this.loading(!0);const e=await this.mediaManager.scanRecordsByCategory(this.mediaType);if(e)for(let t of e)await this.onMediaAdded(t);this.loading(!1)}disableScan(e){e.find(".category").attr("disabled","disabled"),e.find('[data-role="load-more"]').html(Localization.Messages.NoMoreData)}}class VideoCategorySlideComponent extends BaseCategorySlideComponent{constructor(){super(MediaTypes.Video,{objectFit:"cover"})}}const PreviewSlideComponentEvents={Preview:{Close:"media:preview:close"}};class AWSConsoleS3{static getLink(e,t){return t?`https://s3.console.aws.amazon.com/s3/object/${e}/${t}?region=${SolutionManifest.Region}`:`https://s3.console.aws.amazon.com/s3/buckets/${e}/?region=${SolutionManifest.Region}`}}class AWSConsoleStepFunctions{static getExecutionLink(e){return`https://console.aws.amazon.com/states/home?region=${SolutionManifest.Region}#/executions/details/${e}`}}class AWSConsoleTranscribe{static getJobLink(e){return`https://console.aws.amazon.com/transcribe/home?region=${SolutionManifest.Region}#job-details/${e}`}}class AWSConsoleCongito{static getUserPoolLink(e){return`https://${SolutionManifest.Region}.console.aws.amazon.com/cognito/users/?region=${SolutionManifest.Region}#pool/${e}/users`}}const CSS_DL="row text-left lead-xs ml-2 mb-2",CSS_DT="col-sm-2",CSS_DD="col-sm-10",DEFAULT_CSS={dl:CSS_DL,dt:CSS_DT,dd:CSS_DD};class DescriptionList extends(mxReadable(class{})){constructor(e){super(),this.$cssOptions={...DEFAULT_CSS,...e}}get cssOptions(){return this.$cssOptions}createTableList(){return $("<dl/>").addClass(this.cssOptions.dl)}createListTitle(e){return $("<dt/>").addClass(this.cssOptions.dt).addClass("text-capitalize text-truncate").append(e)}createListData(e){const t=$("<dd/>").addClass(this.cssOptions.dd);return Array.isArray(e)?(e.forEach(e=>t.append(e)),t):t.append(e)}appendTableList(e,t,a){return e.append(this.createListTitle(a)).append(this.createListData(this.readableValue(t,a)))}createDetailGroup(e,t=0){let a;a=t?1===t?{margin:"ml-2",lead:"lead-s"}:{margin:"ml-4",lead:"lead-s"}:{margin:"",lead:"lead-s"};return $("<details/>").addClass(a.margin).append($("<summary/>").addClass("my-2").append($("<span/>").addClass(a.lead+" text-capitalize").append(e)))}readableValue(e,t){if("key"===t&&e.bucket){const t=$("<a/>").addClass("mr-1").addClass("badge badge-pill badge-primary mr-1 mb-1 lead-xs").attr("href",AWSConsoleS3.getLink(e.bucket,e.key)).attr("target","_blank").html(Localization.Tooltips.ViewOnAWSConsole),a=$("<a/>").addClass("mr-1").attr("href",S3Utils.signUrl(e.bucket,e.key)).attr("download","").attr("target","_blank").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",Localization.Tooltips.DownloadFile).append(e.key).tooltip({trigger:"hover"});return $("<div/>").append(a).append(t)}return"fileSize"===t?DescriptionList.readableFileSize(e.fileSize):"duration"===t?DescriptionList.readableDuration(e[t]):"timestamp"===t||"lastModified"===t||"startTime"===t||"endTime"===t?DescriptionList.isoDateTime(e[t]):"executionArn"===t?$("<a/>").addClass("badge badge-pill badge-primary mr-1 mb-1 lead-xs").attr("href",AWSConsoleStepFunctions.getExecutionLink(e[t])).attr("target","_blank").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",Localization.Tooltips.ViewOnAWSConsole).html(e[t].split(":").pop()).tooltip({trigger:"hover"}):Array.isArray(e[t])?e[t].join(", "):e[t]}}class GeneralGroup{static createGroup(e){if(!e)return;const t=new DescriptionList,a=t.createDetailGroup(Localization.Messages.GeneralGroup),s=t.createTableList();return Object.keys(e).filter(t=>!("object"==typeof e[t]||Array.isArray(e[t])||"storageClass"===t)).forEach(a=>t.appendTableList(s,e,a)),a.append(s)}}class ProxyGroup{static createGroup(e){if(!e&&!e.length)return;const t=new DescriptionList,a=t.createDetailGroup(Localization.Messages.ProxyGroup);return e.forEach(e=>{const s=e.key.substring(e.key.lastIndexOf("/")+1),n=t.createDetailGroup(s,1);n.find("span.text-capitalize").removeClass("text-capitalize");const i=t.createTableList();Object.keys(e).filter(t=>!("object"==typeof e[t]||Array.isArray(e[t])||"storageClass"===t)).forEach(a=>t.appendTableList(i,e,a)),n.append(i),a.append(n)}),a}}class MediaInfoGroup{static createGroup(e){if(!e)return;const t=new DescriptionList({dt:"col-sm-3",dd:"col-sm-9"}),a=t.createDetailGroup(Localization.Messages.MediaInfoGroup);return((e.media||{}).track||[]).forEach(e=>{const s=t.createDetailGroup(e.$.type,1),n=t.createTableList();Object.keys(e).filter(t=>!("object"==typeof e[t]||Array.isArray(e[t])||"storageClass"===t)).forEach(a=>t.appendTableList(n,e,a)),s.append(n),a.append(s)}),a}}const EXPIRES_IN_YEAR=31536e6;class SettingStore extends BaseStore{constructor(){super(StoreDefinitions.Stores.Settings)}static getSingleton(){return(window.AWSomeNamespace||{}).SettingStoreSingleton||(window.AWSomeNamespace={...window.AWSomeNamespace,SettingStoreSingleton:new SettingStore}),window.AWSomeNamespace.SettingStoreSingleton}async putItem(e,t,a=31536e6){return this.db.putItem(this.storeName,e,t,a)}}class GoogleMap{static async getSingleton(e){return new Promise(t=>{GoogleMap.singleton?t(GoogleMap.singleton):GoogleMap.loadMap(t,e)})}static loadMap(e,t=""){const a=document.createElement("script");a.src="https://maps.googleapis.com/maps/api/js?key="+t,a.onerror=t=>{console.error("GoogleMapLaoder onerror: "+encodeURIComponent(t.message)),e(void 0)},a.onload=()=>{GoogleMap.singleton=new GoogleMap,e(GoogleMap.singleton)},window.document.body.appendChild(a)}static initMap(){GoogleMap.mapIsReady=!0}get mapIsReady(){return GoogleMap.mapIsReady}static dms2dd(e){const[t,a,s,n]=e.split(" ").map(e=>e.trim());let i=Number.parseFloat(t)+Number.parseFloat(a)/60+Number.parseFloat(s)/3600;return"W"!==n&&"S"!==n||(i=0-i),i}render(e,t,a){const s={lat:GoogleMap.dms2dd(t),lng:GoogleMap.dms2dd(a)},n=new google.maps.Map(e,{zoom:8,center:s,mapTypeControl:!1,fullscreenControl:!1,streetViewControl:!1});new google.maps.Marker({position:s,map:n})}}GoogleMap.mapIsReady=!1,GoogleMap.singleton=void 0;const OPT_MAPAPIKEY="mapApiKey",DATA_INIT="data-initialized",DATA_LAT="data-lat",DATA_LNG="data-lng",DATA_ROLE="data-role",ROLE_MAP="map",ATTRB_BASIC=["Make","Model","ImageSize","ImageHeight","ImageWidth","Orientation","ColorSpace","XResolution","YResolution","CreateDate"];class EXIFGroup{static createGroup(e){if(!e)return;const t=new DescriptionList({dt:"col-sm-3",dd:"col-sm-9"}),a=t.createDetailGroup(Localization.Messages.EXIFGroup),s={},n={},i={};Object.keys(e).forEach(t=>{ATTRB_BASIC.indexOf(t)>=0?s[t]=e[t]:0===t.indexOf("GPS")?n[t]=e[t]:i[t]=e[t]});let o=Object.keys(s);if(o.length){const e=t.createDetailGroup(Localization.Messages.BasicGroup,1),n=t.createTableList();o.forEach(e=>t.appendTableList(n,s,e)),e.append(n),a.append(e)}if(o=Object.keys(n),o.length){const e=t.createDetailGroup(Localization.Messages.GPSGroup,1),s=t.createTableList();if(o.forEach(e=>t.appendTableList(s,n,e)),e.append(s),n.GPSLongitude&&n.GPSLatitude){const t=EXIFGroup.createMap(n.GPSLongitude,n.GPSLatitude);e.prepend(t)}a.append(e)}if(o=Object.keys(i),o.length){const e=t.createDetailGroup(Localization.Messages.OthersGroup,1),s=t.createTableList();o.forEach(e=>t.appendTableList(s,i,e)),e.append(s),a.append(e)}return a}static createMap(e,t){const a=$("<div/>").addClass("collapse ml-4 mb-2 h-400").attr(DATA_ROLE,"map").attr(DATA_INIT,!1).attr(DATA_LAT,t).attr(DATA_LNG,e).css("width","90%"),s=$("<input/>").attr("type","checkbox");s.off("click").on("click",async e=>EXIFGroup.showMap(a,s.prop("checked")));const n=$("<label/>").addClass("xs-switch").append(s).append($("<span/>").addClass("xs-slider round")),i=$("<div/>").addClass("form-group ml-4 mb-2").append($("<div/>").addClass("input-group").append(n).append($("<span/>").addClass("lead-sm ml-2").html(Localization.Messages.ShowMap)));return $("<div/>").append(i).append(a)}static async showMap(e,t){if(!t)return e.addClass("collapse");if(e.removeClass("collapse"),!0===e.data("initialized"))return e;const a=e.data("lat"),s=e.data("lng"),n=await SettingStore.getSingleton().getItem("mapApiKey"),i=await GoogleMap.getSingleton(n);return i&&(i.render(e[0],a,s),e.prop(DATA_INIT,!0)),e}}class PDFGroup{static createGroup(e){if(!e)return;const t=new DescriptionList,a=t.createDetailGroup(Localization.Messages.PDFGroup),s=t.createTableList();return Object.keys(e).filter(t=>!("object"==typeof e[t]||Array.isArray(e[t])||"storageClass"===t)).forEach(a=>t.appendTableList(s,e,a)),a.append(s)}}class TechnicalComponentHelper{static createContents(e){if(!e)return;const t=$("<div/>").addClass("col-12 p-0 m-4"),a=$("<h5/>").addClass("lead my-2 text-left").html(`${e.basename} (${e.readableDuration||e.readableFileSize})`);t.append($("<div/>").addClass("col-12 p-0 m-0").append(a));const s=GeneralGroup.createGroup(e.data);s&&t.append($("<div/>").addClass("col-12 p-0 my-2 mx-0").append(s));const n=ProxyGroup.createGroup(e.data.proxies);n&&t.append($("<div/>").addClass("col-12 p-0 my-2 mx-0").append(n));const i=MediaInfoGroup.createGroup(e.data.mediainfo);i&&t.append($("<div/>").addClass("col-12 p-0 my-2 mx-0").append(i));const o=EXIFGroup.createGroup(e.data.imageinfo);o&&t.append($("<div/>").addClass("col-12 p-0 my-2 mx-0").append(o));const r=PDFGroup.createGroup(e.data.docinfo);return r&&t.append($("<div/>").addClass("col-12 p-0 my-2 mx-0").append(r)),t}}class BaseTab{constructor(e,t){this.$ids={tabId:"tab-"+AppUtils.randomHexstring(),contentId:"tabcontent-"+AppUtils.randomHexstring()},this.$title=e;const a=$("<a/>").addClass("nav-link").attr("id",this.tabId).attr("href","#"+this.contentId).attr("role","tab").attr("data-toggle","tab").attr("aria-controls",this.$contentId).attr("aria-selected",!!t.selected).css("font-size",t.fontSize||"1.2rem").html(this.$title);this.$tabLink=$("<li/>").addClass("nav-item").append(a),this.$tabContent=$("<div/>").addClass("tab-pane fade").attr("id",this.contentId).attr("role","tabpanel").attr("aria-labelledby",this.tabId),t.selected&&(a.addClass("active"),this.$tabContent.addClass("show active")),a.off("shown.bs.tab").on("shown.bs.tab",async e=>{const t=$(e.target);t.parent().siblings().children(".nav-link").removeClass("show active"),t.closest('[data-role="custom-tab-group"]').siblings().find(".nav-link").removeClass("show active"),t.prop("id")===this.tabId&&await this.show()}),this.$initialized=!1}get ids(){return this.$ids}get tabId(){return this.$ids.tabId}get contentId(){return this.$ids.contentId}get title(){return this.$title}set title(e){this.$title=e,this.tabLink.children("a.nav-link").html(this.$title)}get tabLink(){return this.$tabLink}get tabContent(){return this.$tabContent}get initialized(){return this.$initialized}set initialized(e){this.$initialized=e}async show(){return this.initialized=!0,this.tabContent}async hide(){this.tabContent.children().remove(),this.initialized=!1}async showIfActive(){return this.tabContent.hasClass("active")?this.show():this}}const COL_TAB$4="col-11";class BaseAnalysisTab extends(mxReadable(mxSpinner(BaseTab))){constructor(e,t,a=!1){super(e,{selected:a,fontSize:"1rem"}),this.$previewComponent=t,this.$css={dl:{dt:"col-sm-2",dd:"col-sm-10"}}}get ids(){return this.$ids}get css(){return this.$css}get previewComponent(){return this.$previewComponent}get media(){return(this.$previewComponent||{}).media}async show(){if(!this.initialized){const e=$("<div/>").addClass("row no-gutters justify-content-md-center min-h24r").append(this.createLoading()).append(this.createBackgroundTitle()).append(await this.createContent());this.tabContent.append(e)}return super.show()}async download(e){return e?S3Utils.getObject(this.media.getProxyBucket(),e).catch(t=>{console.error(`failed to download '${e}' - ${encodeURIComponent(t.message)}`)}):void 0}createBackgroundTitle(){return $("<div/>").addClass("col-11 d-flex justify-content-center custom-bg min-h24r").append($("<span/>").addClass("align-self-center text-uppercase").html(this.title))}async createContent(){return $("<div/>").addClass("col-11 my-4 max-h36r").html(Localization.Messages.NoData)}readableValue(e,t){if("key"===t&&e.bucket){const t=$("<a/>").addClass("mr-1").addClass("badge badge-pill badge-primary mr-1 mb-1 lead-xs").attr("href",AWSConsoleS3.getLink(e.bucket,e.key)).attr("target","_blank").html(Localization.Tooltips.ViewOnAWSConsole),a=$("<a/>").addClass("mr-1").attr("href",S3Utils.signUrl(e.bucket,e.key)).attr("download","").attr("target","_blank").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",Localization.Tooltips.DownloadFile).append(e.key).tooltip({trigger:"hover"});return $("<div/>").append(a).append(t)}return"fileSize"===t?BaseMedia.readableFileSize(e.fileSize):"timestamp"===t||"lastModified"===t||"startTime"===t||"endTime"===t?BaseMedia.isoDateTime(e[t]):"executionArn"===t?$("<a/>").addClass("badge badge-pill badge-primary mr-1 mb-1 lead-xs").attr("href",AWSConsoleStepFunctions.getExecutionLink(e[t])).attr("target","_blank").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",Localization.Tooltips.ViewOnAWSConsole).html(e[t].split(":").pop()).tooltip({trigger:"hover"}):Array.isArray(e[t])?e[t].join(", "):e[t]}createGrouping(e,t=0){let a;a=t?1===t?{margin:"ml-2",lead:"lead-xs"}:{margin:"ml-4",lead:"lead-xxs"}:{margin:"",lead:"lead-sm"};return $("<details/>").addClass(a.margin).append($("<summary/>").addClass("my-2").append($("<span/>").addClass(a.lead+" text-capitalize").append(e)))}createTableList(){return $("<dl/>").addClass("row text-left lead-xs ml-2 mb-2")}createListTitle(e){return $("<dt/>").addClass(this.css.dl.dt).addClass("text-capitalize text-truncate").append(e)}createListData(e){const t=$("<dd/>").addClass(this.css.dl.dd);return Array.isArray(e)?(e.forEach(e=>t.append(e)),t):t.append(e)}createBadge(e,t,a){const s=t?$("<a/>").addClass("badge-primary").attr("href",t):$("<span/>").addClass("badge-secondary");return s.addClass("badge badge-pill mr-1 mb-1 lead-xs").append(e),a&&s.attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",a).tooltip({trigger:"hover"}),s}appendTableList(e,t,a){return e.append(this.createListTitle(t)).append(this.createListData(a))}createButton(e,t){const a=(t?`${t} ${e}`:e).replace(/_/g," "),s=$("<button/>").addClass("btn btn-sm btn-primary text-capitalize mb-1 ml-1").attr("type","button").attr("data-toggle","button").attr("aria-pressed",!1).attr("autocomplete","off").attr("data-track-name",e).append(a);return s.off("click").on("click",async t=>{const a="false"===s.attr("aria-pressed");return this.previewComponent.trackToggle(e,a)}),s}createEnableAll(e){const t=$("<input/>").attr("type","checkbox");t.off("click").on("click",async a=>{const s=t.prop("checked");e.forEach(e=>{"false"===e.attr("aria-pressed")===s&&e.click()})});return $("<div/>").addClass("form-group px-0 mt-2 mb-2").append($("<div/>").addClass("input-group").append($("<label/>").addClass("xs-switch").append(t).append($("<span/>").addClass("xs-slider round"))).append($("<span/>").addClass("lead ml-2").html(Localization.Messages.EnableAll)))}}const COL_TAB$3="col-11";class StatisticsTab extends BaseAnalysisTab{constructor(e,t=!1){super(Localization.Messages.StatisticsTab,e,t)}async createWorkflowHistory(e){const t=this.createGrouping(Localization.Messages.WorkflowHistory);return e.forEach(e=>{const a=this.createTableList();Object.keys(e).filter(t=>"object"!=typeof e[t]&&!Array.isArray(e[t])).forEach(t=>this.appendTableList(a,t,this.readableValue(e,t))),t.append(this.createGrouping(e.type,1).append(a))}),t}async createRekognition(e){const t=this.createGrouping(Localization.Messages.Rekognition);return Object.keys(e).forEach(async a=>t.append(await this.iterateAndCreateRekognitionItemByType(e[a],a))),t}async iterateAndCreateRekognitionItemByType(e,t){const a=[].concat(e);return Promise.all(a.map(e=>this.createRekognitionByType(e,t)))}async createRekognitionByType(e,t){const a=this.media.getProxyBucket(),s=this.createTableList(),n=this.createGrouping(t,1).append(s);if(["startTime","endTime","id","customLabelModels"].forEach(t=>e[t]&&this.appendTableList(s,t,this.readableValue(e,t))),((e.trackBasenames||{}).metadata||[]).length>0){let t=e.trackBasenames.metadata.map(e=>e.replace(/_/g," "));t=t.map(e=>this.createBadge(e).addClass("text-capitalize")),this.appendTableList(s,Localization.Messages.Labels,t)}const i="/"===e.output[e.output.length-1]?e.output:e.output.substring(0,e.output.lastIndexOf("/")),o=(await S3Utils.listObjects(a,i)).map(e=>{const t=e.Key.substring(e.Key.lastIndexOf("/")+1,e.Key.length),s=S3Utils.signUrl(a,e.Key),n=`${Localization.Messages.FileSize}: ${BaseMedia.readableFileSize(e.Size)}`;return this.createBadge(t,s,n)});return this.appendTableList(s,Localization.Messages.DownlaodJson,o),n}async createTranscribe(e){const t=this.media.getProxyBucket(),a=this.createTableList(),s=this.createGrouping(Localization.Messages.Transcribe).append(a),n=$("<a/>").addClass("mr-1").attr("href",AWSConsoleTranscribe.getJobLink(e.jobId)).attr("target","_blank").html(e.name);return this.appendTableList(a,Localization.Messages.TranscriptionJob,n),["startTime","endTime"].forEach(t=>this.appendTableList(a,t,this.readableValue(e,t))),["output","vtt"].forEach(s=>{if(e[s]){const n=e[s].substring(e[s].lastIndexOf("/")+1,e[s].length),i=S3Utils.signUrl(t,e[s]),o=Localization.Tooltips.DownloadFile;this.appendTableList(a,s,this.createBadge(n,i,o))}}),s}async createComprehend(e){const t=this.createGrouping(Localization.Messages.Comprehend);return Object.keys(e).forEach(async a=>t.append(await this.createComprehendByType(e[a],a))),t}async createComprehendByType(e,t){const a=this.media.getProxyBucket(),s=this.createTableList(),n=this.createGrouping(t,1).append(s);return["startTime","endTime"].forEach(t=>this.appendTableList(s,t,this.readableValue(e,t))),["output","metadata"].forEach(t=>{if(e[t]){const n=e[t].substring(e[t].lastIndexOf("/")+1,e[t].length),i=S3Utils.signUrl(a,e[t]),o=Localization.Tooltips.DownloadFile;this.appendTableList(s,t,this.createBadge(n,i,o))}}),n}async createTextract(e){const t=this.media.getProxyBucket(),a=this.createTableList(),s=this.createGrouping(Localization.Messages.Textract).append(a);return["startTime","endTime"].forEach(t=>this.appendTableList(a,t,this.readableValue(e,t))),["output"].forEach(s=>{const n=e[s].substring(e[s].lastIndexOf("/")+1,e[s].length),i=S3Utils.signUrl(t,e[s]),o=Localization.Tooltips.DownloadFile;this.appendTableList(a,s,this.createBadge(n,i,o))}),s}async createContent(){const e=$("<div/>").addClass("col-11 my-4 max-h36r");return setTimeout(async()=>{this.loading(!0);const t=await this.media.getAnalysisResults();return t&&t.length?(e.append(await this.createWorkflowHistory(t)),t.forEach(async t=>{t.type===MediaTypes.Video&&t.rekognition?e.append(await this.createRekognition(t.rekognition)):t.type===MediaTypes.Audio?(t.transcribe&&e.append(await this.createTranscribe(t.transcribe)),t.comprehend&&e.append(await this.createComprehend(t.comprehend))):t.type===MediaTypes.Image?e.append(await this.createRekognition(t["rekog-image"])):t.type===MediaTypes.Document&&e.append(await this.createTextract(t.textract))}),this.loading(!1)):(e.html(Localization.Messages.NoData),this.loading(!1))},10),e}}const EVENT_DATA_SELECTED="scatter:data:selected",EVENT_LEGEND_CHANGED="scatter:legend:changed";class ScatterGraph extends(mxReadable(class{})){constructor(e){super(),this.$datasets=e.filter(e=>e.data.length>0),this.$labels=this.$datasets.map(e=>e.label),this.$graphContainer=$("<div/>").addClass("scatter-graph").attr("id","scatter-"+AppUtils.randomHexstring());const t=this.makeGraphOptions(this.$datasets),a=echarts.init(this.$graphContainer[0]);this.registerGraphEvents(this.$datasets,a),a.setOption(t),this.$graph=a}static get Events(){return{Data:{Selected:EVENT_DATA_SELECTED},Legend:{Changed:EVENT_LEGEND_CHANGED}}}get graphContainer(){return this.$graphContainer}set graphContainer(e){this.$graphContainer=e}get graph(){return this.$graph}set graph(e){this.$graph=e}get datasets(){return this.$datasets}set datasets(e){this.$datasets=e}get labels(){return this.$labels}get graphId(){return this.graphContainer.prop("id")}getGraphContainer(){return this.graphContainer}makeGraphOptions(e){const t={type:"scroll",orient:"horizontal",data:e.sort((e,t)=>t.appearance-e.appearance).map(e=>({name:e.label})),selected:e.reduce((e,t)=>({...e,[t.label]:!1}),{}),tooltip:{show:!0,trigger:"item",formatter:t=>{const a=e.find(e=>e.label===t.name)||{},s=a.data||[],n=AppUtils.readableDuration((s[0]||{}).x||0,!0),i=AppUtils.readableDuration((s[s.length-1]||{}).x||0,!0);let o="";if(a.duration&&a.appearance){o=`Show rate <strong>${Number(a.appearance/a.duration*100).toFixed(2)}%</strong> (${AppUtils.readableDuration(a.appearance,!0)} of ${AppUtils.readableDuration(a.duration,!0)})`}return s.length?`<span>Total <strong>${s.length}</strong> data points</span><br/>Starting at <strong>${n}</strong><br/>Ended at <strong>${i}</strong><br/>${o}`:`<span>${t.name}</span>`}}},a={type:"time",scale:!1,minInterval:1e3,axisLabel:{formatter:e=>AppUtils.readableDuration(e,!0),rotate:45},splitLine:{show:!0}};let s=Math.round(Math.min(e[0].duration,6e4)/e[0].duration*100);s=Math.max(s,10);return{legend:t,grid:{containLabel:!0,show:!0},xAxis:a,yAxis:{type:"value",scale:!0,axisLabel:{formatter:"{value}"},splitLine:{show:!0},min:0,interval:1},dataZoom:[{type:"slider",show:!0,xAxisIndex:[0],start:0,end:s,minValueSpan:2e3,labelFormatter:e=>AppUtils.readableDuration(e,!0)}],tooltip:{show:!0,trigger:"item",formatter:e=>`<span style="color:${e.color}">${e.seriesName}</span> (x${e.data[1]})<br/>at ${AppUtils.readableDuration(e.data[0],!0)}`},series:e.map(e=>({name:e.label,type:"scatter",large:!0,largeThreshold:5e3,data:e.data.map(e=>[e.x,e.y])}))}}destroy(){this.graph&&this.graph.dispose(),this.graph=void 0,this.graphContainer&&this.graphContainer.remove(),this.graphContainer=void 0,this.datasets&&(this.datasets.length=0)}onDataPointClickEvent(e,t){if("series"!==t.componentType)return;const a={...e[t.seriesIndex].data[t.dataIndex],color:t.color,label:t.seriesName,desc:e[t.seriesIndex].desc};return this.graphContainer.trigger(ScatterGraph.Events.Data.Selected,[a])}onLegendSelectChangedEvent(e,t){const a=e.find(e=>e.label===t.name),s=[{name:t.name,enabled:t.selected[t.name],basename:(a||{}).basename}];return this.graphContainer.trigger(ScatterGraph.Events.Legend.Changed,[s])}onInverseLegendsEvent(e,t){const a=[];return e.forEach((e,s)=>{void 0!==t.selected[e.label]&&a.push({name:e.label,enabled:t.selected[e.label],basename:e.basename})}),this.graphContainer.trigger(ScatterGraph.Events.Legend.Changed,[a])}onRenderedEvent(e){e.getWidth()<=0||e.getHeight()<=0?setTimeout(()=>e.resize(),200):e.off("rendered")}resize(){return this.graph.resize()}on(e,t){return this.graphContainer.on(e,t)}off(e){return this.graphContainer.off(e)}async toggleAllLegends(e){return this.graph.dispatchAction({type:"legendInverseSelect"})}registerGraphEvents(e,t){const a=this.onRenderedEvent.bind(this,t);t.off("rendered").on("rendered",async()=>a());const s=this.onDataPointClickEvent.bind(this,e);t.off("click").on("click",async e=>s(e));const n=this.onLegendSelectChangedEvent.bind(this,e);t.off("legendselectchanged").on("legendselectchanged",async e=>n(e));const i=this.onInverseLegendsEvent.bind(this,e);t.off("legendinverseselect").on("legendinverseselect",async e=>i(e))}updateLegends(e){const t=this.datasets,a=this.graph.getOption(),s=[];for(let n of a.legend){const a=Object.keys(n.selected);for(;a.length;){const e=a.shift();if(!0===n.selected[e]){const a=t.find(t=>t.label===e);a&&s.push({name:a.label,enabled:!1,basename:a.basename}),n.selected[e]=!1}}this.graph.setOption({legend:{data:e,selected:n.selected}})}s.length>0&&this.graphContainer.trigger(ScatterGraph.Events.Legend.Changed,[s])}}class BaseRekognitionImageTab extends BaseAnalysisTab{constructor(e,t,a,s=!1){let n;switch(e){case AnalysisTypes.Rekognition.Celeb:n=Localization.Messages.CelebTab;break;case AnalysisTypes.Rekognition.Label:n=Localization.Messages.LabelTab;break;case AnalysisTypes.Rekognition.Face:n=Localization.Messages.FaceTab;break;case AnalysisTypes.Rekognition.FaceMatch:n=Localization.Messages.FaceMatchTab;break;case AnalysisTypes.Rekognition.Moderation:n=Localization.Messages.ModerationTab;break;case AnalysisTypes.Rekognition.Person:n=Localization.Messages.PersonTab;break;case AnalysisTypes.Rekognition.Text:n=Localization.Messages.TextTab;break;case AnalysisTypes.Rekognition.Segment:n=Localization.Messages.SegmentTab;break;case AnalysisTypes.Rekognition.CustomLabel:n=Localization.Messages.CustomLabelTab;break;default:n="Unknown"}super(n,t,s),this.$category=e,this.$data=a}get category(){return this.$category}get data(){return this.$data}async createContent(){const e=$("<div/>").addClass("col-9 my-4 max-h36r"),t=this.createCanvasButtons(this.category);if(!t.length)return super.createContent();const a=this.createEnableAll(t);return e.append(a),t.forEach(t=>e.append(t)),e}createCanvasButtons(e){return this.previewComponent.getCanvasesByType(e).map(e=>{const t=$("<button/>").addClass("btn btn-sm btn-primary text-capitalize mb-1 ml-1").attr("type","button").attr("data-toggle","button").attr("aria-pressed",!1).attr("autocomplete","off").attr("data-canvas-id",e.id).attr("data-placement","bottom").attr("title",`${Localization.Tooltips.Confidence}: ${e.confidence}%`).append(e.name).tooltip({trigger:"hover"});return t.off("click").on("click",async a=>{t.tooltip("hide");const s="false"===t.attr("aria-pressed");return this.previewComponent.canvasToggle(e.id,s)}),t})}}const TOGGLE_ALL=Localization.Messages.ToggleAll,SEARCH_SPECIFIC_LABEL=Localization.Messages.SearchSpecificLabel;class BaseRekognitionTab extends BaseRekognitionImageTab{constructor(e,t,a,s=!1){super(e,t,a,s),this.$scatterGraph=void 0,this.$datasetStore=DatasetStore.getSingleton()}get scatterGraph(){return this.$scatterGraph}set scatterGraph(e){this.$scatterGraph&&this.$scatterGraph.destroy(),this.$scatterGraph=e}get datasetStore(){return this.$datasetStore}async createContent(){const e=$("<div/>").addClass("col-9 my-4 max-h36r");return this.delayContentLoad(e),e}delayContentLoad(e){setTimeout(async()=>{this.loading(!0);const t=await this.createScatterGraph(this.category);if(t){await this.registerVttTracks(this.category);const a=$("<p/>").addClass("lead-sm").append(Localization.Messages.ScatterGraphDesc);e.append(a).append(this.createToggleAll()).append(t)}else e.html(Localization.Messages.NoData);this.loading(!1)},100)}async registerVttTracks(e){const t=this.data||{},a=t.vtt,s=(t.trackBasenames||{}).vtt||[];if(a&&s.length)return s.map(e=>this.previewComponent.trackRegister(e,`${a}${e}.vtt`))}async createTrackButtons(e,t){const a=this.data||{},s=a.vtt,n=(a.trackBasenames||{}).vtt||[];if(s&&n.length)return n.map(e=>(this.previewComponent.trackRegister(e,`${s}${e}.vtt`),this.createButton(e,t)))}async createScatterGraph(e,t){const a=this.data||{},s=a.timeseries,n=(a.trackBasenames||{}).timeseries||[];if(!s||!n.length)return;const i=await this.downloadDatasets(s,n);if(!i||!i.length)return;this.scatterGraph=new ScatterGraph(i),this.scatterGraph.on(ScatterGraph.Events.Data.Selected,async(e,t)=>this.onDataPointSelected(t)),this.scatterGraph.on(ScatterGraph.Events.Legend.Changed,async(e,t)=>this.onLegendChanged(t));return $("<div/>").addClass("col-9 p-0 m-4 mx-auto").append(this.scatterGraph.getGraphContainer())}async downloadDatasets(e,t){let a=await this.datasetStore.getItem(e).catch(()=>{});if(a&&void 0!==a[0].duration)return a;const s=await Promise.all(t.map(t=>this.download(`${e}${t}.json`).then(e=>JSON.parse(e.Body.toString())).catch(()=>{})));a=[];for(let e=0;e<s.length;e++)void 0!==s[e]&&a.push({...s[e],basename:t[e]});return await this.datasetStore.putItem(e,a).catch(()=>{}),a}async selectAll(){return await Promise.all(this.scatterGraph.datasets.map(e=>this.previewComponent.trackToggle(e.basename,!0))),this.scatterGraph.selectAllDataset()}async deselectAll(){return await Promise.all(this.scatterGraph.datasets.map(e=>this.previewComponent.trackToggle(e.basename,!1))),this.scatterGraph.deselectAllDataset()}async select(e){const t=(this.scatterGraph.findDataset(e)||{}).basename;return t&&await this.previewComponent.trackToggle(t,!0),this.scatterGraph.selectDataset(e)}async deselect(e){const t=(this.scatterGraph.findDataset(e)||{}).basename;return t&&await this.previewComponent.trackToggle(t,!1),this.scatterGraph.deselectDataset(e)}async onDataPointSelected(e){this.previewComponent.pause(),this.previewComponent.seek(e.x/1e3);const t=this.previewComponent.getContainerDimensions(),a=this.previewComponent.getCanvasView();a.children().remove();const s=$("<div/>").addClass("lead-sm").css("position","absolute").css("top","1rem").css("left","1rem");for(let n=0;n<e.details.length;n++){const i=this.createBadges(e,n);let[o,r,l,d]=this.computeCoordinate(e.details[n],t.width,t.height);if(void 0!==o){let c=this.createCanvas(o,r,l,d,e.color);a.append(c),e.details[n].xy&&([o,r,l,d]=this.computeCoordinate(e.details[n].xy,t.width,t.height),c=this.createCanvas(o,r,l,d,e.color),a.append(c));const p=i.map(e=>e.prop("outerHTML"));c.hover(()=>s.html(p).removeClass("collapse"),()=>s.html(p).addClass("collapse"))}else s.append(i)}a.append(s)}async onLegendChanged(e){return this.previewComponent.getCanvasView().children().remove(),e.filter(e=>e.basename).map(e=>this.previewComponent.trackToggle(e.basename,e.enabled))}computeCoordinate(e,t,a){return void 0===e.w?[]:[Math.min(Math.round(e.w*t),t),Math.min(Math.round(e.h*a),a),Math.max(Math.round(e.l*t),0),Math.max(Math.round(e.t*a),0)]}createCanvas(e,t,a,s,n){return $("<canvas/>").addClass("canvas-item").attr("width",e).attr("height",t).css("left",a).css("top",s).css("background-color",n+"4C").css("border-color",n)}createBadges(e,t,a){const s=[],n=e.details[t].c||(e.details[t].xy||{}).c||"--";let i=`${e.label} (${n}%)`;return a&&(i=`${a} ${i}`),s.push(this.createBadge(i)),e.desc&&e.desc.split(";").forEach(e=>s.push(this.createBadge(e))),e.details[t].desc&&e.details[t].desc.split(";").forEach(e=>s.push(this.createBadge(e,"badge-dark"))),s}createBadge(e,t="badge-success"){return $("<span/>").addClass("badge badge-pill lead-xs mb-1").addClass(t).css("display","block").html(e)}async hide(){return this.scatterGraph&&this.scatterGraph.destroy(),this.scatterGraph=void 0,super.hide()}createToggleAll(){const e=$("<div/>").addClass("form-group px-0 mt-2 mb-2"),t=$("<div/>").addClass("input-group");e.append(t);const a=$("<input/>").attr("type","checkbox"),s=$("<span/>").addClass("xs-slider round"),n=$("<label/>").addClass("xs-switch");n.append(a).append(s),t.append(n);const i=$("<span/>").addClass("lead ml-2").append(TOGGLE_ALL);t.append(i),a.off("click").on("click",async e=>this.scatterGraph.toggleAllLegends(a.prop("checked")));const o=$("<div/>").addClass("dropdown col-3 p-0 ml-auto");t.append(o);const r="dropdown-"+AppUtils.randomHexstring(),l=$("<input/>").addClass("form-control form-control-sm").attr("type","text").attr("id",r).attr("autocomplete","off").attr("data-toggle","dropdown").attr("aria-haspopup",!0).attr("aria-expanded",!1).attr("placeholder",SEARCH_SPECIFIC_LABEL);o.append(l);const d=$("<div/>").addClass("dropdown-menu col-12 lead-xs").attr("aria-labelledby",r);o.append(d);const c=this.scatterGraph.labels.map(e=>this.createDropdownItem(e,o,l,a));d.append(c),l.on("keyup",()=>{const e=l.val();let t=this.scatterGraph.labels;if(e.length>0){const a=new RegExp(e,"gi");t=this.scatterGraph.labels.filter(e=>e.match(a))}t=t.map(e=>this.createDropdownItem(e,o,l,a)),d.children().remove(),d.append(t),o.dropdown("show")});const p=$("<button/>").addClass("btn btn-sm btn-secondary").append($("<i/>").addClass("far fa-times-circle"));return t.append(p),p.on("click",e=>{e.preventDefault(),e.stopPropagation();if(l.val().length>0){l.val("");let e=this.scatterGraph.datasets.map(e=>e.label);this.scatterGraph.updateLegends(e),e=e.map(e=>this.createDropdownItem(e,o,l,a)),d.children().remove(),d.append(e),o.dropdown("hide"),a.prop("checked",!1)}}),e}createDropdownItem(e,t,a,s){const n=$("<a/>").addClass("dropdown-item").attr("href","#").attr("data-value",e).append(e);return n.on("click",async e=>{e.preventDefault(),e.stopPropagation();const i=n.data("value");a.val(i),t.dropdown("hide");const o=this.scatterGraph.datasets.filter(e=>e.label===i).map(e=>e.label);this.scatterGraph.updateLegends(o),s.prop("checked",!1)}),n}}class CelebTab extends BaseRekognitionTab{constructor(e,t,a=!1){super(AnalysisTypes.Rekognition.Celeb,e,t,a)}}class LabelTab extends BaseRekognitionTab{constructor(e,t,a=!1){super(AnalysisTypes.Rekognition.Label,e,t,a)}}class FaceMatchTab extends BaseRekognitionTab{constructor(e,t,a=!1){super(AnalysisTypes.Rekognition.FaceMatch,e,t,a)}}class FaceTab extends BaseRekognitionTab{constructor(e,t,a=!1){super(AnalysisTypes.Rekognition.Face,e,t,a)}}class ModerationTab extends BaseRekognitionTab{constructor(e,t,a=!1){super(AnalysisTypes.Rekognition.Moderation,e,t,a)}}const NAMED_PREFIX="Person";class PersonTab extends BaseRekognitionTab{constructor(e,t,a=!1){super(AnalysisTypes.Rekognition.Person,e,t,a)}createBadges(e,t,a){return super.createBadges(e,t,"Person")}}class SegmentTab extends BaseRekognitionTab{constructor(e,t,a=!1){super(AnalysisTypes.Rekognition.Segment,e,t,a)}async createContent(){const e=await this.createButtonList(),t=$("<div/>").addClass("col-12 m-0 p-0 my-4"),a=await this.createEDLButton();if(a){const e=$("<p/>").addClass("lead-sm").append(Localization.Messages.DownloadEDLDesc);t.append(e).append(a)}return $("<div/>").addClass("col-9 m-0 p-0 max-h36r").append(e).append(t)}async createButtonList(){const e=$("<div/>").addClass("col-12 m-0 p-0 my-4"),t=await this.createTrackButtons(this.category);if(!(t||[]).length)return e.html(Localization.Messages.NoData);const a=this.createEnableAll(t);return e.append(a),t.forEach(t=>e.append(t)),e}async createEDLButton(){const e=(this.data||{}).edl;if(!e)return;const t=AnalysisTypes.Rekognition.Segment+".zip",a=this.media.getProxyBucket(),s=await this.media.getUrl(a,`${e}${t}`);return $("<a/>").addClass("btn btn-sm btn-success text-capitalize mb-1 ml-1").attr("href",s).attr("target","_blank").attr("download",`${this.media.basename}-${t}`).attr("role","button").append(Localization.Buttons.DownloadEDL)}}class TextTab extends BaseRekognitionTab{constructor(e,t,a=!1){super(AnalysisTypes.Rekognition.Text,e,t,a)}}const TITLE$2=Localization.Messages.ImageCaptionTab,DESC$2=Localization.Messages.ImageCaptionDesc,NO_DATA$1=Localization.Messages.NoData;class ImageCaptionTab extends BaseAnalysisTab{constructor(e,t=!1){super(TITLE$2,e,t)}async createContent(){const e=$("<div/>").addClass("col-9 my-4 max-h36r"),t=this.previewComponent.media.getImageAutoCaptioning()||NO_DATA$1,a=$("<p/>").addClass("lead-sm font-italic").append(DESC$2);e.append(a);const s=$("<p/>").addClass("lead").append(t);return e.append(s),e}}class CelebImageTab extends BaseRekognitionImageTab{constructor(e,t,a=!1){super(AnalysisTypes.Rekognition.Celeb,e,t,a)}}class LabelImageTab extends BaseRekognitionImageTab{constructor(e,t,a=!1){super(AnalysisTypes.Rekognition.Label,e,t,a)}}class FaceMatchImageTab extends BaseRekognitionImageTab{constructor(e,t,a=!1){super(AnalysisTypes.Rekognition.FaceMatch,e,t,a)}}class FaceImageTab extends BaseRekognitionImageTab{constructor(e,t,a=!1){super(AnalysisTypes.Rekognition.Face,e,t,a)}}class ModerationImageTab extends BaseRekognitionImageTab{constructor(e,t,a=!1){super(AnalysisTypes.Rekognition.Moderation,e,t,a)}}class TextImageTab extends BaseRekognitionImageTab{constructor(e,t,a=!1){super(AnalysisTypes.Rekognition.Text,e,t,a)}}class TranscribeTab extends BaseAnalysisTab{constructor(e,t=!1){super(Localization.Messages.TranscribeTab,e,t)}async createContent(){const e=$("<div/>").addClass("col-9 my-4 max-h36r"),t=this.previewComponent.trackIsEnabled(VideoPreview.Constants.Subtitle),a=$("<input/>").attr("type","checkbox").attr("data-category","transcribe").attr("data-type","subtitle").attr("checked",t);a.off("click").on("click",async e=>{const t=a.prop("checked");await this.previewComponent.trackToggle(VideoPreview.Constants.Subtitle,t)});const s=$("<div/>").addClass("form-group px-0 mt-2 mb-42").append($("<div/>").addClass("input-group").append($("<label/>").addClass("xs-switch").append(a).append($("<span/>").addClass("xs-slider round"))).append($("<span/>").addClass("lead ml-2").html(Localization.Messages.SubtitleSwitch))),n=this.previewComponent.getSubtitleView();return e.append(s).append(n)}}class BaseComprehendTab extends BaseAnalysisTab{constructor(e,t,a=!1){super(e,t,a)}async createTimelineButtons(e){const t=this.media.getComprehendResults();if(!(t[e]||{}).metadata)return[];const a=await this.download(t[e].metadata);if(!a)return[];const s=JSON.parse(a.Body),n=s[0].type?{}:void 0,i=[];for(;s.length;){const e=s.shift(),t=this.createButton(e);n?(n[e.type]=n[e.type]||[],n[e.type].push(t)):i.push(t)}return i.length>0||Object.keys(n).forEach(e=>{i.push(this.createCategory(e,n[e].length)),i.splice(i.length,0,...n[e])}),i}createButton(e){const t=`${e.text} (${Number.parseFloat(e.confidence).toFixed(2)})`,a=`${e.begin?BaseComprehendTab.readableDuration(e.begin):"--"} / ${e.end?BaseComprehendTab.readableDuration(e.end):"--"}`,s=$("<button/>").addClass("btn btn-sm btn-primary mb-1 ml-1").attr("type","button").attr("data-toggle","button").attr("aria-pressed",!1).attr("autocomplete","off").attr("data-mark-in",e.begin).attr("data-mark-out",e.end).attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",a).append(t).tooltip({trigger:"hover"});return s.off("click").on("click",async t=>{await this.previewComponent.seek(e.begin/1e3)}),s}createCategory(e,t){return $("<span/>").addClass("lead d-block p-0 mt-2 mb-2 ml-1 text-capitalize").append(`${e} (${t})`)}}class KeyphraseTab extends BaseComprehendTab{constructor(e,t=!1){super(Localization.Messages.KeyphraseTab,e,t)}async createContent(){const e=$("<div/>").addClass("col-9 my-4 max-h36r"),t=await this.createTimelineButtons(AnalysisTypes.Comprehend.Keyphrase);return(t||[]).length?(t.forEach(t=>e.append(t)),e):super.createContent()}}class EntityTab extends BaseComprehendTab{constructor(e,t=!1){super(Localization.Messages.EntityTab,e,t)}async createTimelineButtons(e){const t=await super.createTimelineButtons(e),a=await super.createTimelineButtons(AnalysisTypes.Comprehend.CustomEntity);return t.concat(a)}async createContent(){const e=$("<div/>").addClass("col-9 my-4 max-h36r"),t=await this.createTimelineButtons(AnalysisTypes.Comprehend.Entity);return(t||[]).length?(t.forEach(t=>e.append(t)),e):super.createContent()}}class SentimentTab extends BaseComprehendTab{constructor(e,t=!1){super(Localization.Messages.SentimentTab,e,t)}async createContent(){const e=$("<div/>").addClass("col-9 my-4 max-h36r"),t=await this.createTimelineButtons(AnalysisTypes.Comprehend.Sentiment);return(t||[]).length?(t.forEach(t=>e.append(t)),e):super.createContent()}}class TextractTab extends BaseAnalysisTab{constructor(e,t=!1){super(Localization.Messages.TextractTab,e,t)}async createContent(){const e=$("<div/>").addClass("col-12 my-4 max-h36r"),t=this.previewComponent.getPageControlContainer();return t?e.append(t):super.createContent()}}class CustomLabelTab extends BaseRekognitionTab{constructor(e,t,a=!1){super(AnalysisTypes.Rekognition.CustomLabel,e,t,a),this.title=`${this.title} (${t.customLabelModels.substring(0,6)}...)`}}const COL_TAB$2="col-11",INDEX_INGEST$2="ingest";class SearchResultTab extends BaseAnalysisTab{constructor(e,t=!1){super(Localization.Messages.SearchResultTab,e,t)}async createContent(){const e=$("<div/>").addClass("col-11 my-4 max-h36r");return setTimeout(async()=>(this.loading(!0),await this.refreshSearchResults(e),this.loading(!1)),10),e}async refreshSearchResults(e){e.children().remove();const t=this.previewComponent.searchResults;if(0===(t||{}.indices||[]).length)return e.append($("<span/>").addClass("lead").append(Localization.Messages.NoData));const a=$("<table/>").addClass("table lead-xs"),s=[Localization.Messages.Category,Localization.Messages.SearchResultDesc].map(e=>$("<th/>").addClass("align-middle text-left b-300").attr("scope","col").append(e));s[0].addClass("col-2"),a.append($("<thead/>").append($("<tr/>").append(s)));const n=$("<tbody/>");if(a.append(n),!t.indices.length)return e.append($("<span/>").addClass("lead").append(Localization.Messages.SearchQueryFailed));const i=t.indices.filter(e=>"ingest"!==e).reduce((e,t)=>({...e,[t]:!0}),{}),o=this.previewComponent.media.uuid,r=await ApiHelper.searchInDocument(o,{...i,query:t.query,exact:t.exact}).then(e=>e.indices).catch(()=>{})||{},l=this.makeTableRowItem([AnalysisTypes.Rekognition.Celeb,AnalysisTypes.Rekognition.FaceMatch],r,Localization.Messages.KnownFaces);n.append(l);const d=this.makeTableRowItem([AnalysisTypes.Rekognition.Label,AnalysisTypes.Rekognition.CustomLabel,AnalysisTypes.Rekognition.Moderation],r,Localization.Messages.LabelsModeration);n.append(d);const c=this.makeTableRowItemSpeechText([AnalysisTypes.Transcribe,AnalysisTypes.Comprehend.Keyphrase,AnalysisTypes.Comprehend.Entity,AnalysisTypes.Comprehend.CustomEntity],r,Localization.Messages.TranscriptPhrasesEntities);n.append(c);const p=this.makeTableRowItem([AnalysisTypes.Rekognition.Text],r,Localization.Messages.VisualText);n.append(p);const h=this.makeTableRowItemTextract(r[AnalysisTypes.Textract],Localization.Messages.VisualText);if(n.append(h),t.indices.indexOf("ingest")>=0){const e={basename:this.previewComponent.media.basename,...this.previewComponent.media.attributes},t=this.makeTableRowItemContentMetadata(e,Localization.Messages.ContentAttributes);n.append(t)}return e.append(a),e}makeTableRowItem(e,t,a){const s=this.mergeResults(e,t);if(!s.results.length)return;if(!s.timecodeBased)return this.makeTableRowItemNoTimecode(s,a);const n=s.results.map(e=>{const t=this.registerTimecodeTrack(e),a=$("<section/>").addClass("mb-2"),s=this.makeTrackToggle(t.label),n=e.timecodes.map(e=>this.makeTimecodeBtn(e));return a.append(s).append(n)});return $("<tr/>").append($("<td/>").addClass("h-100 align-center text-left lead-s").append(a)).append($("<td/>").addClass("h-100 align-middle text-left").append(n))}makeTrackToggle(e){const t="toggle-"+AppUtils.randomHexstring(),a=$("<input/>").addClass("custom-control-input").attr("type","checkbox").attr("id",t),s=$("<label/>").addClass("custom-control-label lead-xs b-300").attr("for",t).append(e),n=$("<div/>").addClass("custom-control custom-switch mr-2 mb-2").append(a).append(s);return a.off("click").on("click",async()=>{const t=a.prop("checked");this.previewComponent.trackToggle(e,t)}),n}registerTimecodeTrack(e){const t=e.timecodes.map(t=>{const a=new window.vttjs.VTTCue(t.begin/1e3,t.end/1e3,e.name);return a.line=0,a.position=100,a.align="start",a.size=50,a});return this.previewComponent.createTrackFromCues(e.name,t)}makeTimecodeBtn(e){const t=AppUtils.readableDuration(e.begin,!0),a=`${t} / ${AppUtils.readableDuration(e.end,!0)}`,s=$("<button/>").addClass("btn btn-sm btn-primary mb-1 ml-1").attr("type","button").attr("data-toggle","button").attr("aria-pressed",!1).attr("autocomplete","off").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",a).append(t).tooltip({trigger:"hover"});return s.off("click").on("click",async t=>{t.stopPropagation(),await this.previewComponent.seek(e.begin/1e3)}),s}mergeResults(e,t){const a={};let s=!1;for(let n of e){const e=Object.keys(t[n]||{});for(;e.length;){const i=e.shift();a[i]||(a[i]={});const o=t[n][i].timecodes;o&&(a[i].timecodes=[...a[i].timecodes||[],...o],s=!0)}}return{timecodeBased:s,results:Object.keys(a).map(e=>({name:e,timecodes:this.mergeTimecodes(a[e].timecodes)}))}}mergeTimecodes(e){if(!e)return;const t=e.map(e=>({begin:1e3*Math.round(e.begin/1e3),end:1e3*Math.round(e.end/1e3)})).sort((e,t)=>e.begin-t.begin),a=[];for(a.push(t.shift());t.length;){const e=a[a.length-1],s=t.shift();e.begin!==s.begin?s.begin>e.begin&&s.begin<e.end?e.end=Math.max(s.end,e.end):s.begin!==e.end?a.push(s):e.end=Math.max(s.end,e.end):s.end>e.end&&(e.end=s.end)}return a}makeTableRowItemNoTimecode(e,t){const a=e.results.map(e=>{const t="tag-"+AppUtils.randomHexstring(),a=$("<button/>").addClass("btn btn-sm btn-primary text-capitalize mb-1 ml-1").attr("type","button").attr("data-toggle","button").attr("data-tag",t).attr("aria-pressed",!1).attr("autocomplete","off").append(e.name);return a.off("click").on("click",async s=>{const n="false"===a.attr("aria-pressed"),i=this.previewComponent.getView();if(i){const a=i.parent();let s=a.children("div.search-layer");s.length||(s=$("<div/>").addClass("search-layer"),a.append(s)),n?s.append($("<span/>").addClass("badge badge-pill badge-secondary mr-1 mb-1 lead-xxs p-2 d-block").attr("data-tag",t).append(e.name)):(s.children(`[data-tag="${t}"]`).remove(),s.children().length||s.remove())}return!0}),a});return $("<tr/>").append($("<td/>").addClass("h-100 align-center text-left lead-s").append(t)).append($("<td/>").addClass("h-100 align-middle text-left").append(a))}makeTableRowItemSpeechText(e,t,a){const s=this.mergeResults(e,t);if(!s.results.length)return;if(!s.timecodeBased)return this.makeTableRowItemNoTimecode(s,a);const n=s.results.map(e=>e.timecodes.map(t=>{const a=this.makeTimecodeBtn(t),s=AppUtils.readableDuration(t.begin,!0);return a.html(`${e.name} (${s})`)})).flat();return $("<tr/>").append($("<td/>").addClass("h-100 align-center text-left lead-s").append(a)).append($("<td/>").addClass("h-100 align-middle text-left").append(n))}makeTableRowItemContentMetadata(e,t){const a=$("<table/>").addClass("lead-xs").attr("cellspacing",0).attr("cellpadding",0),s=$("<tbody/>");a.append(s);const n=Object.keys(e).map(t=>{const a=AppUtils.capitalize(t),s=e[t];return $("<tr/>").append($("<td/>").addClass("h-100 align-center text-left b-300 no-border").append(a)).append($("<td/>").addClass("h-100 align-middle text-left no-border").append(s))});s.append(n);return $("<tr/>").append($("<td/>").addClass("h-100 align-center text-left lead-s").append(t)).append($("<td/>").addClass("h-100 align-middle text-left").append(a))}makeTableRowItemTextract(e,t){if(!e)return;const a=Object.keys(e);let s=[];for(;a.length;){const t=a.shift();for(;e[t].pages.length;){const a=e[t].pages.shift();s.push({name:t,page:a})}}s=s.sort((e,t)=>e.page-t.page);const n=s.map(e=>{const t=e.page,a=`${e.name} (Pg. ${t})`,s=$("<button/>").addClass("btn btn-sm btn-primary mb-1 ml-1").attr("type","button").attr("data-toggle","button").attr("aria-pressed",!1).attr("autocomplete","off").append(a).tooltip({trigger:"hover"});return s.off("click").on("click",async e=>{e.stopPropagation(),await this.previewComponent.slideTo(t)}),s});return $("<tr/>").append($("<td/>").addClass("h-100 align-center text-left lead-s").append(t)).append($("<td/>").addClass("h-100 align-middle text-left").append(n))}}const ServiceNames={Rekognition:"rekognition",Transcribe:"transcribe",Comprehend:"comprehend",Textract:"textract"},SERVICE_AVAILABILITY="service-availability",EXPIRATION_IN_DAYS=6048e5,ALL_SERVICES=Object.values(ServiceNames);class ServiceAvailability{static createInstance(){return ServiceAvailability.getSingleton()}static getSingleton(){return(window.AWSomeNamespace||{}).ServiceAvailabilitySingleton||(window.AWSomeNamespace={...window.AWSomeNamespace,ServiceAvailabilitySingleton:new ServiceAvailability}),window.AWSomeNamespace.ServiceAvailabilitySingleton}async detectServices(e=SolutionManifest.Region){const t="service-availability-"+e,a=SettingStore.getSingleton();let s=await a.getItem(t);if(!s){s=(await Promise.all(ALL_SERVICES.map(t=>this.probe(t,e).then(e=>({[t]:e})).catch(()=>({[t]:!1}))))).reduce((e,t)=>({...e,...t}),{}),await a.putItem(t,s,6048e5).catch(e=>console.error(e))}return s}async probe(e,t){return new Promise((a,s)=>{const n=new XMLHttpRequest;n.open("HEAD",`https://${e}.${t}.amazonaws.com`,!0),n.onerror=()=>a(!1),n.onabort=e=>s(e),n.onreadystatechange=()=>{n.readyState===XMLHttpRequest.DONE&&0!==n.status&&a(!0)},n.send()})}}class FaceStore extends BaseStore{constructor(){super(StoreDefinitions.Stores.Faces)}static getSingleton(){return(window.AWSomeNamespace||{}).FaceStoreSingleton||(window.AWSomeNamespace={...window.AWSomeNamespace,FaceStoreSingleton:new FaceStore}),window.AWSomeNamespace.FaceStoreSingleton}}class FaceManager{static getSingleton(){return void 0===(window.AWSomeNamespace||{}).FaceManagerInstance&&(window.AWSomeNamespace={...window.AWSomeNamespace,FaceManagerInstance:new FaceManager}),window.AWSomeNamespace.FaceManagerInstance}constructor(){this.$faceStore=FaceStore.getSingleton(),this.$collections=[],this.$facesByCollection={}}get faceStore(){return this.$faceStore}get collections(){return this.$collections}set collections(e){this.$collections=e}get facesByCollection(){return this.$facesByCollection}set facesByCollection(e){this.$facesByCollection=e}async getCollections(){return this.collections.length||(this.collections=await ApiHelper.getFaceCollections()),this.collections}async refreshCollections(){return this.collections=await ApiHelper.getFaceCollections(),this.facesByCollection={},this.collections}async createCollection(e){const t=await ApiHelper.createFaceCollection(e);if(t&&t.name)return this.collections.push(t),t}async deleteCollection(e){if(await ApiHelper.deleteFaceCollection(e),this.collections.length){const t=this.collections.findIndex(t=>t.name===e);t>=0&&this.collections.splice(t,1)}delete this.facesByCollection[e]}async getFacesInCollection(e,t){if(!t&&this.facesByCollection[e]&&this.facesByCollection[e].faces.length)return this.facesByCollection[e];const a=await ApiHelper.getFacesInCollection(e,{token:t});return void 0===this.facesByCollection[e]&&(this.facesByCollection[e]={faces:[]}),this.facesByCollection[e].faces.splice(this.facesByCollection[e].faces.length,0,...a.faces),this.facesByCollection[e].token=a.token,a}async getFaceImage(e){let t;if(e&&(t=await this.faceStore.getItem(e),!t)){const a=SolutionManifest.Proxy.Bucket,s=S3Utils.signUrl(a,e);t=await AppUtils.downscale(s),t=await(await fetch(t)).blob(),await this.faceStore.putItem(e,t)}return t?URL.createObjectURL(t):void 0}async deleteFace(e,t){if(await ApiHelper.deleteFaceFromCollection(e,t),this.facesByCollection[e]){const a=this.facesByCollection[e].faces.findIndex(e=>e.faceId===t);a>=0&&this.facesByCollection[e].faces.splice(a,1)}}async indexFace(e,t,a){const s=t.replace(/\s/g,"_"),n=await ApiHelper.indexFaceToCollection(e,{externalImageId:s,blob:a});if(n.key){let e=await AppUtils.downscale(a);e=await(await fetch(e)).blob(),await this.faceStore.putItem(n.key,e)}return n}}const LanguageCodes=[{name:"Afrikaans (South Africa)",value:"af-ZA"},{name:"Arabic (U.A.E.)",value:"ar-AE"},{name:"Arabic (Saudi Arabia)",value:"ar-SA"},{name:"Chinese (PRC)",value:"zh-CN"},{name:"Chinese (Traditional)",value:"zh-TW"},{name:"Danish (Denmark)",value:"da-DK"},{name:"Dutch (Netherlands)",value:"nl-NL"},{name:"German (Switzerland)",value:"de-CH"},{name:"German (Germany)",value:"de-DE"},{name:"English (Scottish)",value:"en-AB"},{name:"English (Australia)",value:"en-AU"},{name:"English (Ireland)",value:"en-IE"},{name:"English (Indian)",value:"en-IN"},{name:"English (New Zealand)",value:"en-NZ"},{name:"English (South Africa)",value:"en-ZA"},{name:"English (United Kingdom)",value:"en-GB"},{name:"English (United States)",value:"en-US"},{name:"English (Welsh)",value:"en-WL"},{name:"Spanish (Spain)",value:"es-ES"},{name:"Spanish (United States)",value:"es-US"},{name:"Farsi (Iran)",value:"fa-IR"},{name:"French (Canada)",value:"fr-CA"},{name:"French (France)",value:"fr-FR"},{name:"Hebrew (Israel)",value:"he-IL"},{name:"Hindi (India)",value:"hi-IN"},{name:"Indonesian (Indonesia)",value:"id-ID"},{name:"Italian (Italy)",value:"it-IT"},{name:"Japanese (Japan)",value:"ja-JP"},{name:"Korean (Korea)",value:"ko-KR"},{name:"Malay (Malaysia)",value:"ms-MY"},{name:"Portuguese (Brazil)",value:"pt-BR"},{name:"Portuguese (Portugal)",value:"pt-PT"},{name:"Russian (Russia)",value:"ru-RU"},{name:"Tamil (India)",value:"ta-IN"},{name:"Thai (Thailand)",value:"th-TH"},{name:"Telugu (India)",value:"te-IN"},{name:"Turkish (Turkey)",value:"tr-TR"}],OPT_CELEB=SolutionManifest.AnalysisTypes.Rekognition.Celeb,OPT_FACE=SolutionManifest.AnalysisTypes.Rekognition.Face,OPT_FACEMATCH=SolutionManifest.AnalysisTypes.Rekognition.FaceMatch,OPT_LABEL=SolutionManifest.AnalysisTypes.Rekognition.Label,OPT_MODERATION=SolutionManifest.AnalysisTypes.Rekognition.Moderation,OPT_PERSON=SolutionManifest.AnalysisTypes.Rekognition.Person,OPT_TEXT=SolutionManifest.AnalysisTypes.Rekognition.Text,OPT_SEGMENT=SolutionManifest.AnalysisTypes.Rekognition.Segment,OPT_CUSTOMLABEL=SolutionManifest.AnalysisTypes.Rekognition.CustomLabel,OPT_MINCONFIDENCE="minConfidence",OPT_FACECOLLECTIONID="faceCollectionId",OPT_CUSTOMLABELMODELS="customLabelModels",OPT_FRAMECATPUREMODE="frameCaptureMode",OPT_TEXTROI="textROI",OPT_FRAMEBASED="framebased",OPT_ENTITY=SolutionManifest.AnalysisTypes.Comprehend.Entity,OPT_KEYPHRASE=SolutionManifest.AnalysisTypes.Comprehend.Keyphrase,OPT_SENTIMENT=SolutionManifest.AnalysisTypes.Comprehend.Sentiment,OPT_CUSTOMENTITY=SolutionManifest.AnalysisTypes.Comprehend.CustomEntity,OPT_CUSTOMENTITYRECOGNIZER="customEntityRecognizer",OPT_TRANSCRIBE=SolutionManifest.AnalysisTypes.Transcribe,OPT_LANGUAGECODE="languageCode",OPT_CUSTOMLANGUAGEMODEL="customLanguageModel",OPT_CUSTOMVOCABULARY="customVocabulary",OPT_TEXTRACT=SolutionManifest.AnalysisTypes.Textract,REKOGNITION_BASIC_OPTIONS=[OPT_CELEB,OPT_FACE,OPT_FACEMATCH,OPT_LABEL,OPT_MODERATION,OPT_PERSON,OPT_TEXT,OPT_SEGMENT],REKOGNITION_ADVANCED_OPTIONS=["minConfidence",OPT_FACECOLLECTIONID,OPT_CUSTOMLABELMODELS,OPT_FRAMECATPUREMODE,"textROI",OPT_CUSTOMLABEL,OPT_FRAMEBASED],COMPREHEND_BASIC_OPTIONS=[OPT_ENTITY,OPT_KEYPHRASE,OPT_SENTIMENT],COMPREHEND_ADVANCED_OPTIONS=[OPT_CUSTOMENTITY,OPT_CUSTOMENTITYRECOGNIZER],TRANSCRIBE_BASIC_OPTIONS=[OPT_TRANSCRIBE],TRANSCRIBE_ADVANCED_OPTIONS=[OPT_LANGUAGECODE,OPT_CUSTOMLANGUAGEMODEL,OPT_CUSTOMVOCABULARY],TEXTRACT_BASIC_OPTIONS=[OPT_TEXTRACT],TEXTROI_GRIDS=["TL","TC","TR","ML","C","MR","BL","BC","BR"],MAX_CUSTOMALBELMODELS=2,AVAILABLE_FRAMECAPTUREMODES=[{name:Localization.Messages.FrameCaptureModeNone,value:SolutionManifest.FrameCaptureMode.MODE_NONE},{name:Localization.Messages.FrameCaptureMode1FPS,value:SolutionManifest.FrameCaptureMode.MODE_1FPS},{name:Localization.Messages.FrameCaptureMode2FPS,value:SolutionManifest.FrameCaptureMode.MODE_2FPS},{name:Localization.Messages.FrameCaptureMode3FPS,value:SolutionManifest.FrameCaptureMode.MODE_3FPS},{name:Localization.Messages.FrameCaptureMode4FPS,value:SolutionManifest.FrameCaptureMode.MODE_4FPS},{name:Localization.Messages.FrameCaptureMode5FPS,value:SolutionManifest.FrameCaptureMode.MODE_5FPS},{name:Localization.Messages.FrameCaptureMode10FPS,value:SolutionManifest.FrameCaptureMode.MODE_10FPS},{name:Localization.Messages.FrameCaptureMode12FPS,value:SolutionManifest.FrameCaptureMode.MODE_12FPS},{name:Localization.Messages.FrameCaptureMode15FPS,value:SolutionManifest.FrameCaptureMode.MODE_15FPS},{name:Localization.Messages.FrameCaptureModeAllFrames,value:SolutionManifest.FrameCaptureMode.MODE_ALL},{name:Localization.Messages.FrameCaptureModeEveryOtherFrame,value:SolutionManifest.FrameCaptureMode.MODE_HALF_FPS},{name:Localization.Messages.FrameCaptureMode1FramePer2Seconds,value:SolutionManifest.FrameCaptureMode.MODE_1F_EVERY_2S},{name:Localization.Messages.FrameCaptureMode1FramePer5Seconds,value:SolutionManifest.FrameCaptureMode.MODE_1F_EVERY_5S},{name:Localization.Messages.FrameCaptureMode1FramePer10Seconds,value:SolutionManifest.FrameCaptureMode.MODE_1F_EVERY_10S},{name:Localization.Messages.FrameCaptureMode1FramePer30Seconds,value:SolutionManifest.FrameCaptureMode.MODE_1F_EVERY_30S},{name:Localization.Messages.FrameCaptureMode1FramePer1Minute,value:SolutionManifest.FrameCaptureMode.MODE_1F_EVERY_1MIN},{name:Localization.Messages.FrameCaptureMode1FramePer2Minutes,value:SolutionManifest.FrameCaptureMode.MODE_1F_EVERY_2MIN},{name:Localization.Messages.FrameCaptureMode1FramePer5Minutes,value:SolutionManifest.FrameCaptureMode.MODE_1F_EVERY_5MIN}],mxAnalysisSettings=e=>class extends(mxSpinner(e)){constructor(...e){super(...e),this.$settingStore=SettingStore.getSingleton(),this.$serviceAvailability={},this.$aiOptions=JSON.parse(JSON.stringify(SolutionManifest.AIML)),this.$availableFaceCollections=void 0,this.$availableCustomLabelModels=void 0,this.$availableLanguageCodes=LanguageCodes,this.$availableCustomVocabularies=void 0,this.$availableCustomLanguageModels=void 0,this.$availableCustomEntityRecognizers=void 0,this.$canModify=CognitoConnector.getSingleton().canModify()}get parentContainer(){throw new Error("dervied class to implement parentContainer getter")}get settingStore(){return this.$settingStore}get serviceAvailability(){return this.$serviceAvailability}set serviceAvailability(e){this.$serviceAvailability=e}get aiOptions(){return this.$aiOptions}set aiOptions(e){this.$aiOptions=e}get availableFaceCollections(){return this.$availableFaceCollections}set availableFaceCollections(e){this.$availableFaceCollections=e}get availableCustomLabelModels(){return this.$availableCustomLabelModels}set availableCustomLabelModels(e){this.$availableCustomLabelModels=e}get availableLanguageCodes(){return this.$availableLanguageCodes}get availableCustomVocabularies(){return this.$availableCustomVocabularies}set availableCustomVocabularies(e){this.$availableCustomVocabularies=e}get availableCustomLanguageModels(){return this.$availableCustomLanguageModels}set availableCustomLanguageModels(e){this.$availableCustomLanguageModels=e}get availableCustomEntityRecognizers(){return this.$availableCustomEntityRecognizers}set availableCustomEntityRecognizers(e){this.$availableCustomEntityRecognizers=e}get canModify(){return this.$canModify}async getItem(e){if(this.canModify)return this.settingStore.getItem(e)}async putItem(e,t){if(this.canModify)return this.settingStore.putItem(e,t)}async deleteItem(e){if(this.canModify)return this.settingStore.deleteItem(e)}async show(){return this.initialized?(await this.loadLocalSettings(),await this.refreshContent()):(this.parentContainer.append(this.createSkeleton()),setTimeout(async()=>(this.loading(!0),this.serviceAvailability=await this.checkServiceAvailability(),[this.availableFaceCollections,this.availableCustomLabelModels,this.availableCustomVocabularies,this.availableCustomLanguageModels,this.availableCustomEntityRecognizers]=await Promise.all([this.getAvailableFaceCollections(),this.getAvailableCustomLabelModels(),this.getAvailableCustomVocabulary(),this.getAvailableCustomLanguageModels(),this.getAvailableCustomEntityRecognizers()]),await this.loadLocalSettings(),this.loading(!1),this.refreshContent()))),super.show()}createSkeleton(){const e=this.createDescription(),t=this.createRekognitionFeaturesForm(),a=this.createTranscribeFeaturesForm(),s=this.createComprehendFeaturesForm(),n=this.createTextractFeaturesForm(),i=this.createControls();return $("<div/>").addClass("row no-gutters").append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(e)).append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(t)).append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(a)).append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(s)).append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(n)).append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(i)).append(this.createLoading())}createDescription(){return $("<p/>").addClass("lead").html(Localization.Messages.SettingsDesc)}createRekognitionFeaturesForm(){const e=$("<span/>").addClass("d-block p-2 bg-light text-black lead").html(Localization.Messages.RekognitionFeatures),t=$("<p/>").addClass("lead-s mt-4").html(Localization.Messages.RekognitionFeaturesDesc),a=$("<form/>").addClass("col-9 px-0 form-inline mt-4").attr("role","form"),s=this.createMinConfidenceRange();a.append(s);const n=REKOGNITION_BASIC_OPTIONS.map(e=>{const t=e.charAt(0).toUpperCase()+e.slice(1);return this.createToggle(ServiceNames.Rekognition,e,Localization.Messages[t],Localization.Tooltips[t])});a.append(n);const i=this.createFaceCollectionFormGroup();a.append(i);const o=this.createTextROIFormGroup();a.append(o);const r=this.createCustomLabelFormGroup();a.append(r);const l=this.createFrameBasedFormGroup();a.append(l);const d=this.createFrameCaptureModeFormGroup();return a.append(d),a.submit(e=>e.preventDefault()),$("<div/>").addClass("ai-group").addClass("overflow-auto my-auto align-content-start").append($("<div/>").addClass("mt-4").append(e).append(t).append(a))}createComprehendFeaturesForm(){const e=$("<span/>").addClass("d-block p-2 bg-light text-black lead").html(Localization.Messages.ComprehendFeatures),t=$("<p/>").addClass("lead-s mt-4").html(Localization.Messages.ComprehendFeaturesDesc),a=$("<form/>").addClass("col-9 px-0 form-inline mt-4").attr("role","form"),s=COMPREHEND_BASIC_OPTIONS.map(e=>{const t=e.charAt(0).toUpperCase()+e.slice(1);return this.createToggle(ServiceNames.Comprehend,e,Localization.Messages[t],Localization.Tooltips[t])});a.append(s);const n=this.createEntityRecognizerFormGroup();return a.append(n),a.submit(e=>e.preventDefault()),$("<div/>").addClass("ai-group").addClass("overflow-auto my-auto align-content-start").append($("<div/>").addClass("mt-4").append(e).append(t).append(a))}createTranscribeFeaturesForm(){const e=$("<span/>").addClass("d-block p-2 bg-light text-black lead").html(Localization.Messages.TranscribeFeatures),t=$("<p/>").addClass("lead-s mt-4").html(Localization.Messages.TranscribeFeaturesDesc),a=$("<form/>").addClass("col-9 px-0 form-inline mt-4").attr("role","form"),s=TRANSCRIBE_BASIC_OPTIONS.map(e=>{const t=e.charAt(0).toUpperCase()+e.slice(1);return this.createToggle(ServiceNames.Transcribe,e,Localization.Messages[t],Localization.Tooltips[t])});a.append(s);const n=this.createLanguageCodeFormGroup();a.append(n);const i=this.createCustomVocabularyFormGroup();a.append(i);const o=this.createCustomLanguageModelFormGroup();return a.append(o),a.submit(e=>e.preventDefault()),$("<div/>").addClass("ai-group").addClass("overflow-auto my-auto align-content-start").append($("<div/>").addClass("mt-4").append(e).append(t).append(a))}createTextractFeaturesForm(){const e=$("<span/>").addClass("d-block p-2 bg-light text-black lead").html(Localization.Messages.TextractFeatures),t=$("<p/>").addClass("lead-s mt-4").html(Localization.Messages.TextractFeaturesDesc),a=$("<form/>").addClass("col-9 px-0 form-inline mt-4").attr("role","form"),s=TEXTRACT_BASIC_OPTIONS.map(e=>{const t=e.charAt(0).toUpperCase()+e.slice(1);return this.createToggle(ServiceNames.Textract,e,Localization.Messages[t],Localization.Tooltips[t])});return a.append(s),a.submit(e=>e.preventDefault()),$("<div/>").addClass("ai-group").addClass("overflow-auto my-auto align-content-start").append($("<div/>").addClass("mt-4").append(e).append(t).append(a))}createControls(){if(!this.canModify)return;const e=$("<form/>").addClass("form-inline");e.submit(e=>e.preventDefault());const t=$("<div/>").addClass("ml-auto");e.append(t);const a=$("<button/>").addClass("btn btn-outline-success ml-1").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",Localization.Tooltips.ApplyToAllUsers).html(Localization.Buttons.ApplyToAllUsers).tooltip({trigger:"hover"});t.append(a);const s=$("<button/>").addClass("btn btn-secondary ml-1").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",Localization.Tooltips.RestoreOriginal).html(Localization.Buttons.RestoreOriginal).tooltip({trigger:"hover"});return t.append(s),a.off("click").on("click",async()=>this.storeGlobalSettings()),s.off("click").on("click",async()=>this.restoreFactorySettings()),e}createMinConfidenceRange(){const e="minConfidence-"+AppUtils.randomHexstring(),t=$("<label/>").addClass("col-4 px-0 justify-content-start").attr("for",e).attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",Localization.Tooltips.MinConfidence).html(Localization.Messages.MinConfidence);t.tooltip({trigger:"hover"});const a=$("<input/>").addClass("custom-range col-6").attr("data-type","minConfidence").attr("type","range").attr("min",0).attr("max",100).attr("value",this.aiOptions.minConfidence).attr("step",1).attr("id",e),s=$("<input/>").addClass("col-1 text-center text-muted ml-1").attr("data-type","minConfidence").attr("type","text").attr("value",this.aiOptions.minConfidence).attr("disabled","disabled").attr("id",e+"-text");return a.off("input").on("input",async()=>{this.aiOptions.minConfidence=Number.parseInt(a.val(),10),s.val(this.aiOptions.minConfidence),await this.putItem("minConfidence",this.aiOptions.minConfidence)}),$("<div/>").addClass("form-group col-10 px-0 mt-2 mb-2").append(t).append(a).append(s)}createToggle(e,t,a,s,n){const i=$("<input/>").attr("type","checkbox").attr("data-category",e).attr("data-type",t),o=$("<span/>").addClass("col-8 px-0").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",s).html(a);o.tooltip({trigger:"hover"});const r=$("<div/>").addClass("form-group col-5 px-0 mt-2 mb-2").append($("<div/>").addClass("input-group col-12 pl-0").append(o).append($("<label/>").addClass("xs-switch").append(i).append($("<span/>").addClass("xs-slider round"))));return this.checkDetectionSupported(t)?this.aiOptions[t]&&i.attr("checked","checked"):(i.attr("disabled","disabled"),r.addClass("text-muted")),i.off("click").on("click",async()=>{const e=i.prop("checked");this.aiOptions[t]=e,n&&await n(e),await this.putItem(t,this.aiOptions[t])}),r}createFrameBasedFormGroup(){return[$("<p/>").addClass("lead-s mt-4").html(Localization.Messages.FramebasedDesc),this.createToggle(ServiceNames.Rekognition,OPT_FRAMEBASED,Localization.Messages.Framebased,Localization.Tooltips.Framebased,this.onFramebasedChange.bind(this))]}createFaceCollectionFormGroup(){return this.createCustomFormGroup({name:OPT_FACECOLLECTIONID,label:Localization.Messages.FaceCollectionId,tooltip:Localization.Tooltips.FaceCollection,default:Localization.Messages.SelectCollection})}createCustomLabelFormGroup(){return[$("<p/>").addClass("lead-s mt-4").html(Localization.Messages.CustomlabelDesc.replace("{{MAX_CUSTOMALBELMODELS}}",2)),this.createMultiselectFormGroup({name:OPT_CUSTOMLABELMODELS,label:Localization.Messages.CustomLabelModels,tooltip:Localization.Tooltips.CustomLabelModels,default:Localization.Messages.SelectModels,beforeChange:this.onCustomLabelModelChange.bind(this)})]}createFrameCaptureModeFormGroup(){return this.createCustomFormGroup({name:OPT_FRAMECATPUREMODE,label:Localization.Messages.FrameCaptureMode,tooltip:Localization.Tooltips.FrameCaptureMode,default:Localization.Messages.SelectFrameCaptureMode})}createTextROIFormGroup(){const e="textROI-"+AppUtils.randomHexstring(),t=$("<label/>").addClass("col-4 px-0 justify-content-start mb-auto").attr("for",e).attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",Localization.Tooltips.TextROI).html(Localization.Messages.TextROI);t.tooltip({trigger:"hover"});const a=$("<div/>").addClass("row no-gutters text-roi-screen").attr("data-type","textROI");TEXTROI_GRIDS.forEach((e,t)=>{const s=$("<div/>").attr("data-index",t).addClass("d-flex text-roi-grid").append($("<div/>").addClass("mx-auto my-auto lead-sm").html(e));s.off("click").on("click",async()=>{s.hasClass("text-roi-grid-active")?(s.removeClass("text-roi-grid-active"),this.aiOptions.textROI[t]=!1):(s.addClass("text-roi-grid-active"),this.aiOptions.textROI[t]=!0),await this.putItem("textROI",this.aiOptions.textROI)}),a.append(s)});const s=$("<div/>").addClass("col-6 m-0 p-0").attr("id",e).append(a);return $("<div/>").addClass("form-group col-10 px-0 my-2").append(t).append(s)}createLanguageCodeFormGroup(){return this.createCustomFormGroup({name:OPT_LANGUAGECODE,label:Localization.Messages.LanguageCode,tooltip:Localization.Tooltips.LanguageCode,default:Localization.Messages.SelectLanguageCode})}createCustomVocabularyFormGroup(){return this.createCustomFormGroup({name:OPT_CUSTOMVOCABULARY,label:Localization.Messages.CustomVocabulary,tooltip:Localization.Tooltips.CustomVocabulary,default:Localization.Messages.SelectModel})}createCustomLanguageModelFormGroup(){return this.createCustomFormGroup({name:OPT_CUSTOMLANGUAGEMODEL,label:Localization.Messages.CustomLanguageModel,tooltip:Localization.Tooltips.CustomLanguageModel,default:Localization.Messages.SelectModel})}createEntityRecognizerFormGroup(){return this.createCustomFormGroup({name:OPT_CUSTOMENTITYRECOGNIZER,label:Localization.Messages.CustomEntityRecognizer,tooltip:Localization.Tooltips.CustomEntityRecognizer,default:Localization.Messages.SelectModel,onChange:this.onEntityRecognizerChange.bind(this)})}createCustomFormGroup(e){const t=`${e.name}-${AppUtils.randomHexstring()}`,a=$("<label/>").addClass("col-4 px-0 justify-content-start").attr("for",t).attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",e.tooltip).html(e.label);a.tooltip({trigger:"hover"});const s=$("<select/>").addClass("custom-select custom-select-sm col-7").attr("data-type",e.name).attr("id",t).append($("<option/>").attr("value","undefined").html(e.default));s.off("change").on("change",async()=>{const t=s.val();"undefined"===t?this.aiOptions[e.name]=void 0:/^\d+$/.test(t)?this.aiOptions[e.name]=Number.parseInt(t,10):this.aiOptions[e.name]=t,"function"==typeof e.onChange&&await e.onChange(e.name,this.aiOptions[e.name]),await this.putItem(e.name,this.aiOptions[e.name])});return $("<div/>").addClass("form-group col-10 px-0 my-2").append(a).append(s)}createMultiselectFormGroup(e){const t=`${e.name}-${AppUtils.randomHexstring()}`,a=$("<label/>").addClass("col-4 px-0 justify-content-start").attr("for",t).attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",e.tooltip).html(e.label);a.tooltip({trigger:"hover"});const s=$("<button/>").addClass("col-8 btn btn-sm btn-outline-dark dropdown-toggle overflow-auto").attr("type","button").attr("id",t).attr("data-toggle","dropdown").attr("aria-haspopup",!0).attr("aria-expanded",!1).html(e.default),n=$("<div/>").addClass("dropdown col-8").append(s),i=$("<div/>").addClass("dropdown-menu col-12 lead-xs").attr("data-type",e.name).attr("aria-labelledby",t),o=$("<a/>").addClass("dropdown-item").attr("href","#").attr("data-value","undefined").html(Localization.Messages.SelectNone);o.on("click",async t=>{t.preventDefault(),t.stopPropagation();(!e.beforeChange||await e.beforeChange("undefined",!0))&&(i.find("a.dropdown-item").removeClass("active"),s.html(e.default))}),i.append(o).append($("<div/>").addClass("dropdown-divider")),n.append(i);return $("<div/>").addClass("form-group col-10 px-0 my-2").append(a).append(n)}async onCustomLabelModelChange(e,t){const a=OPT_CUSTOMLABELMODELS;if("undefined"===e)return this.aiOptions[a].length=0,await Promise.all([this.putItem(a,this.aiOptions[a]),this.onCustomLabelChange()]),!0;const s=this.aiOptions[a].findIndex(t=>t===e);return t?this.aiOptions[a].length<2&&(s<0&&this.aiOptions[a].splice(this.aiOptions[a].length,0,e),await Promise.all([this.putItem(a,this.aiOptions[a]),this.onCustomLabelChange(),this.ensureFrameCaptureMode(SolutionManifest.FrameCaptureMode.MODE_1F_EVERY_2S)]),!0):(s>=0&&this.aiOptions[a].splice(s,1),await Promise.all([this.putItem(a,this.aiOptions[a]),this.onCustomLabelChange(),this.ensureFrameCaptureMode(SolutionManifest.FrameCaptureMode.MODE_1F_EVERY_2S)]),!0)}async onFramebasedChange(e){return e&&await this.ensureFrameCaptureMode(SolutionManifest.FrameCaptureMode.MODE_1F_EVERY_2S),!0}async onCustomLabelChange(){return this.aiOptions[OPT_CUSTOMLABEL]=this.aiOptions[OPT_CUSTOMLABELMODELS].length>0,this.putItem(OPT_CUSTOMLABEL,this.aiOptions[OPT_CUSTOMLABEL])}async onEntityRecognizerChange(e,t){if(e===OPT_CUSTOMENTITYRECOGNIZER)return this.aiOptions[OPT_CUSTOMENTITY]=!!t,this.putItem(OPT_CUSTOMENTITY,this.aiOptions[OPT_CUSTOMENTITY])}async ensureFrameCaptureMode(e){const t=this.parentContainer.find(`select[data-type=${OPT_FRAMECATPUREMODE}]`);t.children("option:selected").first().val()===""+SolutionManifest.FrameCaptureMode.MODE_NONE&&t.val(""+e).trigger("change")}checkDetectionSupported(e){return REKOGNITION_BASIC_OPTIONS.indexOf(e)>=0||OPT_FRAMEBASED===e?this.serviceAvailability[ServiceNames.Rekognition]:TRANSCRIBE_BASIC_OPTIONS.indexOf(e)>=0?this.serviceAvailability[ServiceNames.Transcribe]:COMPREHEND_BASIC_OPTIONS.indexOf(e)>=0?this.serviceAvailability[ServiceNames.Comprehend]:TEXTRACT_BASIC_OPTIONS.indexOf(e)>=0&&this.serviceAvailability[ServiceNames.Textract]}async checkServiceAvailability(){return ServiceAvailability.getSingleton().detectServices()}async getAvailableFaceCollections(){return this.serviceAvailability[ServiceNames.Rekognition]?FaceManager.getSingleton().getCollections():void 0}async getAvailableCustomLabelModels(){return this.serviceAvailability[ServiceNames.Rekognition]?ApiHelper.getRekognitionCustomLabelModels():void 0}async getAvailableCustomVocabulary(){return this.serviceAvailability[ServiceNames.Transcribe]?ApiHelper.getTranscribeCustomVocabulary():void 0}async getAvailableCustomLanguageModels(){return this.serviceAvailability[ServiceNames.Transcribe]?ApiHelper.getTranscribeCustomLanguageModels():void 0}async getAvailableCustomEntityRecognizers(){return this.serviceAvailability[ServiceNames.Transcribe]&&this.serviceAvailability[ServiceNames.Comprehend]?ApiHelper.getComprehendCustomEntityRecognizers():void 0}async refreshContent(){[OPT_FRAMEBASED,...REKOGNITION_BASIC_OPTIONS,...TRANSCRIBE_BASIC_OPTIONS,...COMPREHEND_BASIC_OPTIONS,...TEXTRACT_BASIC_OPTIONS].forEach(e=>this.refreshToggle(e)),[{name:OPT_FACECOLLECTIONID,options:(this.availableFaceCollections||[]).map(e=>({name:`${e.name} (${e.faces} faces)`,value:e.name,canUse:e.faces>0}))},{name:OPT_FRAMECATPUREMODE,options:AVAILABLE_FRAMECAPTUREMODES},{name:OPT_LANGUAGECODE,options:this.availableLanguageCodes||[]},{name:OPT_CUSTOMVOCABULARY,options:(this.availableCustomVocabularies||[]).map(e=>({name:`${e.name} (${e.languageCode})`,value:e.name,canUse:e.canUse}))},{name:OPT_CUSTOMLANGUAGEMODEL,options:(this.availableCustomLanguageModels||[]).map(e=>({name:`${e.name} (${e.languageCode})`,value:e.name,canUse:e.canUse}))},{name:OPT_CUSTOMENTITYRECOGNIZER,options:(this.availableCustomEntityRecognizers||[]).map(e=>({name:`${e.name} (${e.languageCode})`,value:e.name,canUse:e.canUse}))}].forEach(e=>this.refreshCustomFormOptions(e)),[{name:OPT_CUSTOMLABELMODELS,options:(this.availableCustomLabelModels||[]).map(e=>({name:e.name.split("/").shift(),value:e.name,canUse:e.canUse})),default:Localization.Messages.SelectModels,beforeChange:this.onCustomLabelModelChange.bind(this)}].forEach(e=>this.refreshMultiselectFormGroup(e)),this.refreshMinConfidenceRange(),this.refreshTextROIFormGroup()}refreshToggle(e){const t=this.parentContainer.find(`input[data-type=${e}]`),a=t.closest("div.form-group");this.checkDetectionSupported(e)?(a.removeClass("text-muted"),t.removeAttr("disabled"),t.prop("checked",this.aiOptions[e])):(a.addClass("text-muted"),t.attr("disabled","disabled")),this.canModify||t.attr("disabled","disabled")}refreshCustomFormOptions(e){const t=this.parentContainer.find(`select[data-type=${e.name}]`);t.children('option[value!="undefined"]').remove(),e.options.forEach(a=>{const s=$("<option/>").attr("value",a.value).html(a.name);!1===a.canUse?s.attr("disabled","disabled"):(s.removeAttr("disabled"),this.aiOptions[e.name]===a.value&&s.attr("selected","selected")),t.append(s)}),this.canModify||t.attr("disabled","disabled")}refreshMultiselectFormGroup(e){const t=this.parentContainer.find(`div.dropdown-menu[data-type=${e.name}]`),a=t.siblings("button.dropdown-toggle").first();t.children('a.dropdown-item[data-value!="undefined"]').remove(),e.options.forEach(s=>{const n=$("<a/>").addClass("dropdown-item").attr("href","#").attr("data-value",s.value).html(s.name);!1===s.canUse?n.attr("disabled","disabled"):(n.removeAttr("disabled"),this.aiOptions[e.name].findIndex(e=>e===s.value)>=0&&n.addClass("active")),n.on("click",async t=>{t.preventDefault(),t.stopPropagation();const i=n.hasClass("active"),o=!e.beforeChange||await e.beforeChange(s.value,!i);o&&i?n.removeClass("active"):o&&!i&&n.addClass("active");let r=this.aiOptions[e.name].map(e=>e.substring(0,5)+"...");r=r.length?r:e.default,a.text(r),await this.putItem(e.name,this.aiOptions[e.name])}),t.append(n)});let s=this.aiOptions[e.name].map(e=>e.substring(0,5)+"...");s=s.length?s:e.default,a.text(s),this.canModify||a.attr("disabled","disabled")}refreshMinConfidenceRange(){const e=this.parentContainer.find("input[data-type=minConfidence]");e.val(this.aiOptions.minConfidence),this.canModify||e.attr("disabled","disabled")}refreshTextROIFormGroup(){this.parentContainer.find("div[data-type=textROI]").children().each((e,t)=>{const a=$(t),s=Number.parseInt(a.data("index"),10);this.aiOptions.textROI[s]?a.addClass("text-roi-grid-active"):a.removeClass("text-roi-grid-active")})}async loadLocalSettings(){const e=await this.getGlobalAIOptions();return void 0!==e&&(this.aiOptions=e),await Promise.all([...REKOGNITION_BASIC_OPTIONS,...REKOGNITION_ADVANCED_OPTIONS,...TRANSCRIBE_BASIC_OPTIONS,...TRANSCRIBE_ADVANCED_OPTIONS,...COMPREHEND_BASIC_OPTIONS,...COMPREHEND_ADVANCED_OPTIONS,...TEXTRACT_BASIC_OPTIONS].map(e=>this.getItem(e).then(t=>this.aiOptions[e]=void 0===t?this.aiOptions[e]:t))),this.aiOptions}async restoreFactorySettings(){try{return this.loading(!0),await Promise.all([...REKOGNITION_BASIC_OPTIONS,...REKOGNITION_ADVANCED_OPTIONS,...TRANSCRIBE_BASIC_OPTIONS,...TRANSCRIBE_ADVANCED_OPTIONS,...COMPREHEND_BASIC_OPTIONS,...COMPREHEND_ADVANCED_OPTIONS,...TEXTRACT_BASIC_OPTIONS].map(e=>this.deleteItem(e))),await this.removeGlobalAIOptions(),this.aiOptions=JSON.parse(JSON.stringify(SolutionManifest.AIML)),this.refreshContent()}catch(e){return void console.error(e)}finally{this.loading(!1)}}async storeGlobalSettings(){try{return this.loading(!0),ApiHelper.setGlobalAIOptions(this.aiOptions)}catch(e){return void console.error(e)}finally{this.loading(!1)}}async getGlobalAIOptions(){return ApiHelper.getGlobalAIOptions()}async removeGlobalAIOptions(){return ApiHelper.deleteGlobalAIOptions()}},COL_TAB$1="col-11";class ReAnalyzeTab extends(mxAnalysisSettings(mxAlert(BaseAnalysisTab))){constructor(e,t=!1){super(Localization.Messages.ReAnalyzeTab,e,t),this.$parentContainer=$("<div/>").addClass("col-11 my-4 max-h36r")}get parentContainer(){return this.$parentContainer}async createContent(){return this.parentContainer}createSkeleton(){const e=super.createSkeleton();return e.children().first().remove(),e.children().first().removeClass("mt-4"),e.children("div.col-9").removeClass("col-9").addClass("col-12"),e.find("span.bg-light").removeClass("p-2"),e}createControls(){const e=$("<button/>").addClass("btn btn-success ml-1").html(Localization.Buttons.ReAnalyzeContent);e.off("click").on("click",async t=>{t.preventDefault(),t.stopPropagation();try{this.loading(!0);const t=this.previewComponent.media.uuid,a={input:{aiOptions:await this.loadLocalSettings()}};await ApiHelper.startAnalysisWorkflow(t,a),this.loading(!1);const s=Localization.Alerts.ReAnalyzeSubmitted.replace("{{BASENAME}}",this.previewComponent.media.basename);return await this.showConfirm(s),!1}catch(e){const t=Localization.Alerts.ReAnalzyeFailed.replace("{{BASENAME}}",this.previewComponent.media.basename);return await this.showAlert(t),!1}finally{e.addClass("disabled").attr("disabled","disabled"),this.loading(!1)}});const t=$("<form/>").addClass("form-inline").append($("<div/>").addClass("ml-auto").append(e));return t.submit(e=>e.preventDefault()),t}async showAlert(e,t=2e3){return super.showMessage(this.tabContent,"danger",Localization.Alerts.Oops,e,t)}async showConfirm(e,t=2e3){return super.showMessage(this.tabContent,"success",Localization.Alerts.Confirmed,e,t)}}const NODE_VIDEO$1="Video",NODE_CELEBRITY$1="celebrity",NODE_INDUSTRY$1="industry",NODE_PRODUCTS$1="products",NODE_SERVICES$1="services",NODE_EVENT_TYPE$1="event_type",NODESIZE_BY_TYPE$1={Video:45,event_type:20,industry:20,celebrity:20,products:20,services:20},GRAPH_MAPPING=Object.keys(NODESIZE_BY_TYPE$1).map(e=>({name:e})),PAGESIZE$1=10;class KnowledgeGraph extends(mxReadable(class{})){constructor(e,t,a){super(),this.$parent=a,this.$mediaManager=MediaManager.getSingleton(),this.$imageStore=ImageStore.getSingleton(),this.$media=t,this.$graphContainer=$("<div/>").addClass("knowledge-graph").attr("id","knowledge-"+AppUtils.randomHexstring()),e.append(this.$graphContainer),this.$graph=void 0,this.$graphContainer.ready(async()=>{console.log("graphContainer ready"),this.$graph=await this.buildGraph(this.$graphContainer)})}get parent(){return this.$parent}get mediaManager(){return this.$mediaManager}get imageStore(){return this.$imageStore}get graphContainer(){return this.$graphContainer}set graphContainer(e){this.$graphContainer=e}get graph(){return this.$graph}set graph(e){this.$graph=e}get graphId(){return this.graphContainer.prop("id")}get media(){return this.$media}loading(e){return this.parent.loading(e)}getGraphContainer(){return this.graphContainer}async buildGraph(e){const t=Math.max(Math.round(e.height()),800),a=Math.max(Math.round(e.width()),800),s=echarts.init(e[0],null,{renderer:"canvas",useDirtyRect:!1,height:t,width:a});s.on("dblclick",async e=>{if(2===e.event.event.detail)try{this.loading(!0);const t=e.name,a=e.data,s=a.value[0];if(console.log("dblclick",e,s),!0!==s.traversed){const n=await this.getConnectedNodes(t,s.id,s.token);if(void 0===n)return;0===n.length?s.traversed=!0:(s.traversed=!1,s.token=(s.token||0)+n.length);const i=this.graph.getOption().series[e.seriesIndex];for(;n.length;){const e=n.shift();let t,o;e.IN.id===s.id?(t=a,o=await this.createAdjacentNode(e.OUT,i)):e.OUT.id===s.id&&(o=a,t=await this.createAdjacentNode(e.IN,i)),void 0!==t&&void 0!==o&&this.createRelationship(t,o,e,i)}this.graph.setOption({series:[i]})}}catch(e){console.error(e)}finally{this.loading(!1)}});try{this.loading(!0);const e=await this.getConnectedNodes("Video",this.media.uuid),t={nodes:[],links:[],categories:GRAPH_MAPPING};let a=e.find(e=>e.OUT.id===this.media.uuid);for(a=await this.createNode({...a.OUT,token:e.length,traversed:!1},0),t.nodes.push(a);e.length;){const s=e.shift();let n,i;s.IN.id===a.value[0].id?(n=a,i=await this.createAdjacentNode(s.OUT,t)):s.OUT.id===a.value[0].id&&(i=a,n=await this.createAdjacentNode(s.IN,t)),void 0!==n&&void 0!==i&&this.createRelationship(n,i,s,t)}const n=this.makeGraphOptions(t);return s.setOption(n),s}catch(e){return console.error(e),s}finally{this.loading(!1)}}async getConnectedNodes(e,t,a=0){return this.graphApi({op:"query",type:"vertice",label:e,id:t,token:a,pagesize:10}).then(e=>{if(!e)return;const t=[];for(;e.length;){const a=e.shift(),s=a.findIndex(e=>void 0!==e.IN);if(s<0)continue;const n=a.splice(s,1).shift();let i=(a.find(e=>e.id===n.IN.id)||{}).name;n.IN.name=i,i=(a.find(e=>e.id===n.OUT.id)||{}).name,n.OUT.name=i,t.push(n)}return t})}async graphApi(e){const t=new URL(SolutionManifest.KnowledgeGraph.Endpoint);Object.keys(e).forEach(a=>{t.searchParams.append(a,e[a])});const a={method:"GET",mode:"cors",cache:"no-cache",headers:{"Content-Type":"application/json","x-api-key":SolutionManifest.KnowledgeGraph.ApiKey}};let s=4;for(;s--;){const e=fetch(t,a).then(e=>e.ok?e.json():new Error);if(!(e instanceof Error))return e}}async createNode(e,t){let a,s=e.name;if("Video"===e.label){const t=await this.mediaManager.lazyGetByUuid(e.id);void 0!==t&&(a=await t.getThumbnail(),s=t.basename)}else{const t=e.label.trim().replace(/[^a-zA-Z0-9-]/g,"-").replace(/-{2,}/g,"-").toLowerCase(),s=e.name.split("-")[0].trim().replace(/[^a-zA-Z0-9-]/g,"-").replace(/-{2,}/g,"-").toLowerCase(),n="celebrity"===e.label?".png":".svg";a=await this.imageStore.getBlob(`./images/kg/${t}/${s}${n}`)}return this.parseNode({...e,name:s,image:a},t)}parseNode(e,t){const a=e.label;return{id:t,name:a,symbolSize:NODESIZE_BY_TYPE$1[a]||10,...this.computeXYCoord(),value:[e],category:GRAPH_MAPPING.findIndex(e=>e.name===a)}}async createAdjacentNode(e,t){const a=t.nodes||t.data;let s=a.findIndex(t=>t.value[0].id===e.id);if(s>=0)return a[s];s=a.length;const n=await this.createNode(e,s);return a.push(n),n}createRelationship(e,t,a,s){const n=s.links.findIndex(e=>e.value[0].id===a.id);if(n>=0)return s.links[n];const i={source:e.id,target:t.id,value:[{id:a.id,desc:`${AppUtils.shorten(e.value[0].name,32)} > ${AppUtils.shorten(t.value[0].name,32)}`}]};return s.links.push(i),i}computeXYCoord(){return{x:Math.floor(2410*Math.random()-1200),y:Math.floor(2410*Math.random()-1200)}}makeGraphOptions(e){return{title:{},tooltip:{show:!0,trigger:"item",enterable:!0,alwaysShowContent:!1,padding:0,extraCssText:"border-radius: 0",formatter:e=>{if("edge"===e.dataType){const t=$("<div/>").addClass("my-2"),a=$("<p/>").addClass("text-truncate").append(e.value[0].desc||e.name);return t.append(a),t.prop("outerHTML")}if("node"===e.dataType){const t=e.value[0],a=$("<div/>");if("Video"===e.name){a.addClass("graph-tooltip");const e=$("<img/>").attr("src",t.image);a.append(e);const s=$("<p/>").addClass("mx-2 my-2 text-truncate").append(t.name);return a.append(s),a.prop("outerHTML")}a.addClass("row no-gutters");let s=$("<i/>").addClass("ml-2 my-2").addClass("far fa-question-circle").addClass("graph-avatar");t.image&&(s=$("<img/>").addClass("mx-2 my-auto").addClass("graph-avatar").attr("src",t.image)),a.append(s);const n=$("<p/>").addClass("my-auto mr-2 text-truncate").append(t.name);return a.append(n),a.prop("outerHTML")}return e.value}},legend:[{data:e.categories.map(e=>e.name)}],animationDuration:1500,animationEasingUpdate:"quinticInOut",series:[{name:"Graph database",type:"graph",layout:"none",data:e.nodes,links:e.links,categories:e.categories,roam:"move",label:{show:!0,position:"right",formatter:e=>AppUtils.shorten(e.value[0].name,32)},lineStyle:{color:"source",curveness:.3},emphasis:{focus:"adjacency",lineStyle:{width:10}}}]}}destroy(){this.graph&&this.graph.dispose(),this.graph=void 0,this.graphContainer&&this.graphContainer.remove(),this.graphContainer=void 0,this.datasets&&(this.datasets.length=0)}resize(){return this.graph.resize()}on(e,t){return this.graphContainer.on(e,t)}off(e){return this.graphContainer.off(e)}}const TITLE$1="Knowledge Graph",DESC$1="Demonstrates a graph representation of the content and how it is related to other contents in your archive library",NO_DATA=Localization.Messages.NoData,COL_TAB="col-11";class KnowledgeGraphTab extends BaseAnalysisTab{constructor(e,t=!1){super(TITLE$1,e,t)}static canSupport(){return SolutionManifest.KnowledgeGraph&&SolutionManifest.KnowledgeGraph.Endpoint&&SolutionManifest.KnowledgeGraph.ApiKey}async createContent(){const e=$("<div/>").addClass("col-11 my-4 max-h56r");return this.delayContentLoad(e),e}delayContentLoad(e){e.ready(async()=>{let t;try{this.loading(!0);const a=$("<section/>").addClass("col-9 mx-auto");e.append(a);const s=$("<p/>").addClass("lead-sm").append(DESC$1);a.append(s),t=$("<section/>").addClass("mt-4"),e.append(t);if(!await this.createKnowledgeGraph(t))return void t.append(NO_DATA)}catch(e){console.error(e),t&&t.append(e.message)}finally{this.loading(!1)}})}async createKnowledgeGraph(e){return new KnowledgeGraph(e,this.media,this)}async graphApi(e){const t=new URL(SolutionManifest.KnowledgeGraph.Endpoint);return Object.keys(e).forEach(a=>{void 0!==e[a]&&t.searchParams.append(a,e[a])}),fetch(t,{method:"GET",mode:"cors",cache:"no-cache",headers:{"Content-Type":"application/json","x-api-key":SolutionManifest.KnowledgeGraph.ApiKey}}).then(e=>{if(e.ok)return e.json()})}}class AnalysisComponent{constructor(e){let t=!0;this.$tabControllers=[],e.searchResults&&(this.$tabControllers.push(new SearchResultTab(e,!0)),t=!1),this.$tabControllers.push(new StatisticsTab(e,t)),KnowledgeGraphTab.canSupport()&&this.$tabControllers.push(new KnowledgeGraphTab(e)),e.media.getTranscribeResults()&&this.$tabControllers.push(new TranscribeTab(e));const a=e.media.getRekognitionResults();let s=Object.keys(a||{});s.forEach(t=>{[].concat(a[t]).forEach(a=>{let s;switch(t){case AnalysisTypes.Rekognition.Celeb:s=new CelebTab(e,a);break;case AnalysisTypes.Rekognition.Label:s=new LabelTab(e,a);break;case AnalysisTypes.Rekognition.FaceMatch:s=new FaceMatchTab(e,a);break;case AnalysisTypes.Rekognition.Face:s=new FaceTab(e,a);break;case AnalysisTypes.Rekognition.Person:s=new PersonTab(e,a);break;case AnalysisTypes.Rekognition.Moderation:s=new ModerationTab(e,a);break;case AnalysisTypes.Rekognition.Segment:s=new SegmentTab(e,a);break;case AnalysisTypes.Rekognition.CustomLabel:s=new CustomLabelTab(e,a);break;case AnalysisTypes.Rekognition.Text:s=new TextTab(e,a);break;default:s=void 0}s&&this.$tabControllers.push(s)})});e.media.getImageAutoCaptioning()&&this.$tabControllers.push(new ImageCaptionTab(e));const n=e.media.getRekognitionImageResults();s=Object.keys(n||{}),s.forEach(t=>{[].concat(n[t]).forEach(a=>{let s;switch(t){case AnalysisTypes.Rekognition.Celeb:s=new CelebImageTab(e,a);break;case AnalysisTypes.Rekognition.Label:s=new LabelImageTab(e,a);break;case AnalysisTypes.Rekognition.FaceMatch:s=new FaceMatchImageTab(e,a);break;case AnalysisTypes.Rekognition.Face:s=new FaceImageTab(e,a);break;case AnalysisTypes.Rekognition.Text:s=new TextImageTab(e,a);break;case AnalysisTypes.Rekognition.Moderation:s=new ModerationImageTab(e,a);break;default:s=void 0}s&&this.$tabControllers.push(s)})});const i=e.media.getComprehendResults();Object.keys(i||{}).forEach(t=>{let a;switch(t){case AnalysisTypes.Comprehend.Keyphrase:a=new KeyphraseTab(e);break;case AnalysisTypes.Comprehend.Entity:a=new EntityTab(e);break;case AnalysisTypes.Comprehend.Sentiment:a=new SentimentTab(e);break;default:a=void 0}a&&this.$tabControllers.push(a)});e.media.getTextractResults()&&this.$tabControllers.push(new TextractTab(e));CognitoConnector.getSingleton().canWrite()&&this.$tabControllers.push(new ReAnalyzeTab(e))}get previewComponent(){return this.$previewComponent}get media(){return(this.$previewComponent||{}).media}get tabControllers(){return this.$tabControllers}set tabControllers(e){this.$tabControllers=e}async show(){const e=this.tabControllers.find(e=>e.tabContent.hasClass("active"));return e?e.show():this}async hide(){return Promise.all(this.tabControllers.map(e=>e.hide()))}createTabsAndContents(){const e=$("<ul/>").addClass("nav flex-column ml-2 my-4").attr("role","tablist");this.tabControllers.forEach(t=>e.append(t.tabLink));const t=this.tabControllers.map(e=>e.tabContent);return[e,t]}createContents(){const[e,t]=this.createTabsAndContents(),a=$("<nav/>").addClass("col-2 d-none d-md-block sidebar").css("min-height",300).append(e),s=$("<div/>").addClass("tab-content").addClass("col-10 p-0 m-0").append(t);return $("<div/>").addClass("col-12 p-0 m-0").append($("<div/>").addClass("row no-gutters").append(a).append(s))}}class CropUtils{constructor(){this.$cropper=void 0,this.$canvas=void 0}get cropper(){return this.$cropper}set cropper(e){this.$cropper=e}get canvas(){return this.$canvas}set canvas(e){this.$canvas=e}async load(e){await this.unload(),e.is("video")&&(this.canvas=this.createCanvas(e),e.before(this.canvas));const t=this.canvas||e;return this.cropper=new Cropper(t[0],{aspectRatio:1,autoCropArea:.5,zoomOnWheel:!1}),this}async unload(){return this.canvas&&this.canvas.remove(),this.canvas=void 0,this.cropper&&this.cropper.destroy(),this.cropper=void 0,this}createCanvas(e){let{width:t,height:a}=e[0].getBoundingClientRect();t=Math.floor(t+.5),a=Math.floor(a+.5);const s=$("<canvas/>").addClass("collapse").attr("width",t).attr("height",a).css("position","absolute").css("top",0).css("left",0);return s[0].getContext("2d").drawImage(e[0],0,0,s[0].width,s[0].height),s}async snapshot(){if(!this.cropper)throw new Error("cropper not loaded");return this.cropper.getCroppedCanvas().toDataURL("image/png")}}class SnapshotComponent extends(mxAlert(mxSpinner(class{}))){constructor(e){super(),this.$previewComponent=e,this.$faceManager=FaceManager.getSingleton(),this.$cropUtils=new CropUtils,this.$ids={container:"snapshot-"+AppUtils.randomHexstring(),toggleSnapshot:"toggle-"+AppUtils.randomHexstring(),selectCollection:"select-"+AppUtils.randomHexstring()},this.$container=$("<div/>").addClass("col-12 p-0 m-0 my-2 bg-white").attr("id",this.$ids.container)}get ids(){return this.$ids}get container(){return this.$container}get previewComponent(){return this.$previewComponent}get faceManager(){return this.$faceManager}get cropUtils(){return this.$cropUtils}async hide(){await this.cropUtils.unload(),this.container.children().remove()}createComponent(){this.container.children().remove();const e=$("<div/>").addClass("row no-gutters"),t=this.createFaceIndexForm();e.append($("<div/>").addClass("col-lg-9 col-md-12 col-sm-12 p-0 m-0").append(t));const a=this.createSnapshotToggle(t);e.append($("<div/>").addClass("col-lg-3 col-md-12 col-sm-12 p-0 m-0 my-auto text-right").append(a));const s=this.createLoading();return e.append(s),this.container.append(e)}createFaceIndexForm(){const e=$("<form/>").addClass("form-inline needs-validation my-2").attr("novalidate","novalidate");e.submit(e=>e.preventDefault());const t=this.ids.selectCollection,a=$("<select/>").addClass("custom-select custom-select-sm col-4 disabled").attr("id",t).attr("disabled","disabled").append($("<option/>").attr("value","undefined").html(Localization.Messages.SelectFaceCollection));this.delayLoadFaceCollections(a);const s=$("<span/>").addClass("lead-s mx-2").html(Localization.Messages.Name),n=$("<input/>").addClass("form-control form-control-sm col-4 disabled").attr("pattern","^[a-zA-Z0-9 _.-]{0,255}$").attr("placeholder","(Blank)").attr("disabled","disabled"),i=$("<button/>").addClass("btn btn-sm btn-success disabled").attr("disabled","disabled").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",Localization.Tooltips.IndexFace).html(Localization.Buttons.IndexFace).tooltip({trigger:"hover"});return i.off("click").on("click",async t=>{try{this.loading(!0),i.tooltip("hide");const s=a.val(),o=n.val();if("undefined"===s)throw this.shake(e),new Error(Localization.Alerts.InvalidFaceCollectionSelection);if(!this.validateForm(t,e)||!o)throw this.shake(e),n.focus(),new Error(Localization.Alerts.InvalidIndexedName);const r=await this.cropUtils.snapshot();await this.faceManager.indexFace(s,o,r),this.container.find("input#"+this.ids.toggleSnapshot).trigger("click");const l=Localization.Alerts.ConfirmFaceIndexed.replace("{{NAME}}",o).replace("{{FACECOLLECTION}}",s);return await this.showConfirm(l,2e3),!0}catch(e){return await this.showAlert(e.message,5e3),!1}finally{this.loading(!1)}}),e.append(s).append(n).append(a).append(i)}createSnapshotToggle(e){const t=this.ids.toggleSnapshot,a=$("<input/>").addClass("custom-control-input").attr("type","checkbox").attr("id",t),s=$("<label/>").addClass("custom-control-label").attr("for",t).append(Localization.Messages.EnableSnapshotMode),n=$("<div/>").addClass("custom-control custom-switch mr-2").append(a).append(s);return a.off("click").on("click",async()=>{if(a.prop("checked")){await this.previewComponent.pause();const t=this.previewComponent.getView();await this.cropUtils.load(t),e.children().removeAttr("disabled").removeClass("disabled")}else await this.cropUtils.unload(),await this.previewComponent.unpause(),e.children().attr("disabled","disabled").addClass("disabled")}),n}delayLoadFaceCollections(e){setTimeout(async()=>{const t=(await this.faceManager.getCollections()||[]).map(e=>$("<option/>").attr("value",e.name).html(e.name));e.append(t)},10)}validateForm(e,t){return e.preventDefault(),!1!==t[0].checkValidity()||(e.stopPropagation(),!1)}async showAlert(e,t){if(this.previewComponent){const a=this.previewComponent.container;return super.showMessage(a,"danger",Localization.Alerts.Oops,e,t)}}async showConfirm(e,t){if(this.previewComponent){const a=this.previewComponent.container;return super.showMessage(a,"success",Localization.Alerts.Confirmed,e,t)}}}const BKGD_PREVIEW="bg-white",BKGD_TECHVIEW="bg-f0",BKGD_ANALYSISVIEW="bg-light",DATA_VIEW="data-view",VIEW_PREVIEW="preview",VIEW_TECH="technical",VIEW_ANALYSIS="analysis";class BasePreviewSlideComponent extends BaseSlideComponent{constructor(){super(),this.$previewComponent=void 0,this.$analysisComponent=void 0,this.$snapshotComponent=void 0,this.$canWrite=CognitoConnector.getSingleton().canWrite()}static get Events(){return PreviewSlideComponentEvents}get previewComponent(){return this.$previewComponent}set previewComponent(e){this.$previewComponent=e}get analysisComponent(){return this.$analysisComponent}set analysisComponent(e){this.$analysisComponent=e}get snapshotComponent(){return this.$snapshotComponent}set snapshotComponent(e){this.$snapshotComponent=e}get media(){return(this.$previewComponent||{}).media}get canWrite(){return this.$canWrite}async setMedia(e,t){void 0===t&&this.media===e||(await this.hide(),this.previewComponent=await MediaFactory.createPreviewComponent(e,t),this.analysisComponent=new AnalysisComponent(this.previewComponent)),e.type!==MediaTypes.Video&&e.type!==MediaTypes.Photo||this.canWrite&&!this.snapshotComponent&&(this.snapshotComponent=new SnapshotComponent(this.previewComponent))}async show(){return this.initialized||(this.slide.append(this.createSkeleton()),setTimeout(async()=>(await this.previewComponent.load(),await this.analysisComponent.show(),this.recalculateViewDimensions()))),this.slide[0].scrollIntoView({behavior:"smooth"}),super.show()}async hide(){return this.snapshotComponent&&await this.snapshotComponent.hide(),this.snapshotComponent=void 0,this.previewComponent&&await this.previewComponent.unload(),this.previewComponent=void 0,this.analysisComponent&&await this.analysisComponent.hide(),this.analysisComponent=void 0,super.hide()}createSkeleton(){const e=this.createPreview(),t=this.createTechnicalView(),a=this.createAnalysisView(),s=this.createCloseButton();return $("<div/>").addClass("row no-gutters").append($("<div/>").addClass("col-6 p-0 overflow-auto maxh-600 bg-white").attr(DATA_VIEW,"preview").append(e)).append($("<div/>").addClass("col-6 p-0 m-0 overflow-auto maxh-600 bg-f0").attr(DATA_VIEW,VIEW_TECH).append(t)).append($("<div/>").addClass("col-12 p-0 m-0 overflow-auto bg-light").attr(DATA_VIEW,"analysis").append(a)).append(s)}createPreview(){const e=$("<div/>").addClass("col-12 p-0 m-0").append(this.previewComponent.container);let t;return this.snapshotComponent&&(t=this.snapshotComponent.createComponent()),[e,t]}createTechnicalView(){return TechnicalComponentHelper.createContents(this.media)}createAnalysisView(){return this.analysisComponent.createContents()}createCloseButton(){const e=$("<i/>").addClass("far fa-times-circle text-secondary").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",Localization.Buttons.ClosePreview).css("font-size","3rem").tooltip({trigger:"hover"}),t=$("<div/>").addClass("close-preview").append($("<button/>").addClass("btn btn-sm btn-link").attr("type","button").append(e));return t.off("click").on("click",async e=>{e.preventDefault(),await this.previewComponent.beforeViewHide(),this.slide.trigger(BasePreviewSlideComponent.Events.Preview.Close,[this.media])}),t}recalculateViewDimensions(){return this.previewComponent.getContainerDimensions(),this.slide.find('div[data-view="technical"]'),this}}class VideoPreviewSlideComponent extends BasePreviewSlideComponent{}class BaseTabPlugins extends BaseTab{constructor(e,t,a){super(e,t),this.$plugins=a;this.$tabLink.children(".nav-link").on("shown.bs.tab",()=>{this.toggleAddonPlugins(this.tabId)})}get plugins(){return this.$plugins}toggleAddonPlugins(e){this.plugins&&this.plugins.find("[data-tab-id]").each((t,a)=>{const s=$(a);s.data("tab-id")===e?s.removeClass("collapse"):s.addClass("collapse")})}}const ERR_DELETE_MEDIA_NOT_ALLOWED=Localization.Alerts.DeleteMediaNotAllowed;class BaseMediaTab extends(mxSpinner(BaseTabPlugins)){constructor(e,t,a){super(t,{selected:!!e,fontSize:"1.1rem"},a),this.$ids={...super.ids,carousel:{container:"media-"+AppUtils.randomHexstring()}},this.$categorySlideComponent=void 0,this.$previewSlideComponent=void 0,this.$canWrite=CognitoConnector.getSingleton().canWrite()}get categorySlideComponent(){return this.$categorySlideComponent}get previewSlideComponent(){return this.$previewSlideComponent}get canWrite(){return this.$canWrite}async show(){if(!this.initialized){const e=await this.createCarousel(),t=$("<div/>").addClass("row no-gutters").append(e).append(this.createLoading());this.tabContent.append(t)}return await this.categorySlideComponent.show(),super.show()}async createCarousel(){this.categorySlideComponent.on(BaseCategorySlideComponent.Events.Media.Removing,async(e,t)=>{if(!this.canWrite)return this.showPermissionErrorDialog(t);if(t.overallStatus===SolutionManifest.Statuses.Processing)return this.showProcessingDialog(t);await this.showRemoveMediaDialog(t)&&(this.loading(!0),await this.categorySlideComponent.onMediaRemoved(t),this.loading(!1))}),this.categorySlideComponent.on(BaseCategorySlideComponent.Events.Media.Selected,async(e,t,a)=>{switch(t.overallStatus){case SolutionManifest.Statuses.Processing:return this.showProcessingDialog(t);case SolutionManifest.Statuses.Error:return this.showErrorDialog(t)}return this.loading(!0),await this.previewSlideComponent.setMedia(t,a),this.loading(!1),this.slideTo(this.previewSlideComponent.slideId)}),this.previewSlideComponent.on(BasePreviewSlideComponent.Events.Preview.Close,async()=>{this.slideTo(this.categorySlideComponent.slideId)});const e=[{id:this.categorySlideComponent.slideId,el:this.categorySlideComponent.getSlide()},{id:this.previewSlideComponent.slideId,el:this.previewSlideComponent.getSlide()}],t=$("<div/>").addClass("carousel-inner");for(let a=0;a<e.length;a++){const s=0===a?"carousel-item active":"carousel-item";t.append($("<div/>").addClass(s).attr("id",e[a].id).append(e[a].el))}const a=$("<div/>").addClass("carousel slide w-100").attr("data-ride",!1).attr("data-interval",!1).attr("id",this.ids.carousel.container).append(t);return a.on("slide.bs.carousel",async e=>{switch($(e.relatedTarget).prop("id")){case this.previewSlideComponent.slideId:return this.previewSlideComponent.show();case this.categorySlideComponent.slideId:return this.categorySlideComponent.show();default:return}}),a}async showPermissionErrorDialog(e){return this.showDialog(e.basename,ERR_DELETE_MEDIA_NOT_ALLOWED)}async showProcessingDialog(e){const t=Localization.Messages.MediaInProcess.replace("{{BASENAME}}",e.basename).replace("{{PROCESSINGTAB}}",Localization.Messages.ProcessingTab);return this.showDialog(e.basename,t)}async showErrorDialog(e){const t=Localization.Messages.MediaError.replace("{{BASENAME}}",e.basename).replace("{{PROCESSINGTAB}}",Localization.Messages.ProcessingTab);return this.showDialog(e.basename,t)}async showRemoveMediaDialog(e){let t=!1;const a=Localization.Messages.RemoveMedia.replace("{{BASENAME}}",e.basename),s=$("<button/>").addClass("btn btn-sm btn-outline-danger").append("Yes, remove it");return s.off("click").on("click",async e=>{e.stopPropagation(),e.preventDefault(),t=!0;$(e.currentTarget).parents('div[role="dialog"]').modal("hide")}),await this.showDialog(e.basename,a,[s]),t}async showDialog(e,t,a){return new Promise(s=>{const n=$("<button/>").addClass("btn btn-sm btn-primary").attr("type","button").attr("data-dismiss","modal").append(Localization.Buttons.Close),i=$("<div/>").addClass("modal-dialog").attr("role","document").append($("<div/>").addClass("modal-content").append($("<div/>").addClass("modal-header").append($("<h5/>").addClass("modal-title lead").html(e))).append($("<div/>").addClass("modal-body").append(t)).append($("<div/>").addClass("modal-footer").append(a).append(n))),o=$("<div/>").addClass("modal fade").attr("tabindex",-1).attr("role","dialog").append(i);o.off("hidden.bs.modal").on("hidden.bs.modal",()=>s(o.remove())),this.tabContent.append(o),o.modal({backdrop:"static",keyboard:!1,show:!0})})}slideTo(e){const t=this.tabContent.find("#"+this.ids.carousel.container).first(),a=t.find("#"+e).index();t.carousel(a)}}class VideoTab extends BaseMediaTab{constructor(e,t){super(e,Localization.Messages.VideoTab,t),this.$categorySlideComponent=new VideoCategorySlideComponent,this.$previewSlideComponent=new VideoPreviewSlideComponent}}class PhotoCategorySlideComponent extends BaseCategorySlideComponent{constructor(){super(MediaTypes.Photo,{objectFit:"cover"})}}class PhotoPreviewSlideComponent extends BasePreviewSlideComponent{}class PhotoTab extends BaseMediaTab{constructor(e,t){super(e,Localization.Messages.PhotoTab,t),this.$categorySlideComponent=new PhotoCategorySlideComponent,this.$previewSlideComponent=new PhotoPreviewSlideComponent}}class PodcastCategorySlideComponent extends BaseCategorySlideComponent{constructor(){super(MediaTypes.Podcast,{objectFit:"cover"})}}class PodcastPreviewSlideComponent extends BasePreviewSlideComponent{}class PodcastTab extends BaseMediaTab{constructor(e,t){super(e,Localization.Messages.PodcastTab,t),this.$categorySlideComponent=new PodcastCategorySlideComponent,this.$previewSlideComponent=new PodcastPreviewSlideComponent}}class DocumentCategorySlideComponent extends BaseCategorySlideComponent{constructor(){super(MediaTypes.Document,{objectFit:"cover"})}}class DocumentPreviewSlideComponent extends BasePreviewSlideComponent{}class DocumentTab extends BaseMediaTab{constructor(e,t){super(e,Localization.Messages.DocumentTab,t),this.$categorySlideComponent=new DocumentCategorySlideComponent,this.$previewSlideComponent=new DocumentPreviewSlideComponent}}const ID_SEARCHRESULT_LIST="results-list-"+AppUtils.randomHexstring(),ID_SEARCHRESULT_CONTAINER="results-container-"+AppUtils.randomHexstring(),KEY_SEARCHOPTIONS="search-options",OPTKEY_EXACT$1="exact",OPTKEY_QUERY$1="query",OPTKEY_PAGESIZE$1="pageSize",OPTVAL_PAGESIZE10$1=10,OPTVAL_PAGESIZE30=30,OPTVAL_PAGESIZE50=50,INDEX_INGEST$1="ingest",DEFAULT_OPTIONS={[MediaTypes.Video]:!0,[MediaTypes.Photo]:!0,[MediaTypes.Podcast]:!0,[MediaTypes.Document]:!0,exact:!1,pageSize:OPTVAL_PAGESIZE10$1,query:void 0,[AnalysisTypes.Transcribe]:!0,[AnalysisTypes.Rekognition.Celeb]:!0,[AnalysisTypes.Rekognition.FaceMatch]:!0,[AnalysisTypes.Rekognition.Label]:!0,[AnalysisTypes.Rekognition.CustomLabel]:!0,[AnalysisTypes.Rekognition.Moderation]:!0,[AnalysisTypes.Rekognition.Text]:!0,[AnalysisTypes.Textract]:!0,[AnalysisTypes.Comprehend.Keyphrase]:!0,[AnalysisTypes.Comprehend.Entity]:!0,[AnalysisTypes.Comprehend.CustomEntity]:!0,[INDEX_INGEST$1]:!0},DATA_UUID$1="data-uuid",DATA_SEARCHTOKEN="data-token",UNICODE_CHARACTER_SETS$1="[0-9A-Za-zA-Za-z------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- ,.'-]{1,}",NUM_SEARCH_ITEM_SHOW=2;class SearchCategorySlideComponent extends BaseSlideComponent{constructor(){super(),this.$searchOptions={},this.$mediaManager=MediaManager.getSingleton(),this.$settingStore=SettingStore.getSingleton()}get searchOptions(){return this.$searchOptions}set searchOptions(e){this.$searchOptions=e}get mediaManager(){return this.$mediaManager}get settingStore(){return this.$settingStore}async show(){if(!this.initialized){await this.loadSettings();const e=this.createDescription(),t=this.createCriteriaForm(),a=this.createSearchResults(),s=$("<div/>").addClass("row no-gutters").append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(e)).append($("<div/>").addClass("col-9 p-0 mx-auto").append(t)).append($("<div/>").addClass("col-12 p-0 mx-auto mt-4 bg-light").append(a)).append(this.createLoading());this.slide.append(s)}return super.show()}createDescription(){return $("<p/>").addClass("lead").html(Localization.Messages.SearchDesc)}createCriteriaForm(){const e=$("<form/>").addClass("col-12 px-0 form-inline needs-validation").attr("novalidate","novalidate").attr("role","form"),t=this.createSearchInput(e),a=this.createSubmitButton(e),s=this.createPageSizeSelection(),n=$("<div/>").addClass("form-group col-12 p-0 mt-2").append(t).append(a).append(s),i=this.createMediaTypeCheckboxes(),o=this.createExactOption(),r=$("<div/>").addClass("form-group col-12 p-0 mt-2").append(i).append(o),l=this.createAIOptionCheckboxes(),d=$("<div/>").addClass("form-group col-12 p-0 mt-2").append(l);return e.append(r).append(d).append(n)}createMediaTypeCheckboxes(){return[[MediaTypes.Video,Localization.Messages.VideoTab],[MediaTypes.Photo,Localization.Messages.PhotoTab],[MediaTypes.Podcast,Localization.Messages.PodcastTab],[MediaTypes.Document,Localization.Messages.DocumentTab]].map(e=>this.createCheckbox(...e))}createAIOptionCheckboxes(){return[[[AnalysisTypes.Rekognition.Celeb,AnalysisTypes.Rekognition.FaceMatch],Localization.Messages.KnownFaces],[[AnalysisTypes.Rekognition.Label,AnalysisTypes.Rekognition.CustomLabel],Localization.Messages.Labels],[AnalysisTypes.Rekognition.Moderation,Localization.Messages.ModerationTab],[[AnalysisTypes.Rekognition.Text,AnalysisTypes.Textract],Localization.Messages.VisualText],[AnalysisTypes.Transcribe,Localization.Messages.Transcript],[AnalysisTypes.Comprehend.Keyphrase,Localization.Messages.Keyphrases],[[AnalysisTypes.Comprehend.Entity,AnalysisTypes.Comprehend.CustomEntity],Localization.Messages.Entities],[INDEX_INGEST$1,Localization.Messages.ContentAttributes]].map(e=>this.createCheckbox(...e))}createSearchInput(e){const t=$("<input/>").addClass("form-control mr-2 col-6").attr("type","search").attr("pattern",UNICODE_CHARACTER_SETS$1).attr("placeholder",Localization.Messages.Search);return t.focusout(async e=>(this.searchOptions.query=t.val()||void 0,!0)),t.keypress(async e=>{if(13===e.which){e.preventDefault(),this.searchOptions.query=t.val()||void 0;return t.siblings('button[type="submit"]').trigger("click")}return!0}),t}createSubmitButton(e){const t=$("<button/>").addClass("btn btn-outline-success my-2").attr("type","submit").append(Localization.Messages.Submit);return t.off("click").on("click",async a=>{if(a.preventDefault(),!this.validateForm(a,e)){this.shake(e),await this.showAlert(Localization.Alerts.InvalidGroupName);return t.siblings('input[type="search"]').focus(),!1}return!!this.searchOptions.query&&(this.loading(!0),this.resetSearchResults(),await this.saveSettings(this.searchOptions),await this.startSearch(this.searchOptions),this.loading(!1),!1)}),t}createExactOption(){const e=this.createCheckbox("exact",Localization.Messages.ExactMatch);return e.find("input").addClass("ml-4"),e.removeClass("mr-4").addClass("mx-2 search-border-l"),e}createPageSizeSelection(){const e=[[OPTVAL_PAGESIZE10$1,Localization.Messages.PageSize10],[OPTVAL_PAGESIZE30,Localization.Messages.PageSize30],[OPTVAL_PAGESIZE50,Localization.Messages.PageSize50]].map(e=>{const t=$("<option/>").attr("value",e[0]).html(e[1]);return e[0]===this.searchOptions.pageSize&&t.attr("selected","selected"),t}),t="select-"+AppUtils.randomHexstring(),a=$("<select/>").addClass("custom-select mx-2").attr("id",t).append(e);return a.off("change").on("change",e=>(this.searchOptions.pageSize=Number.parseInt(a.val(),10),!0)),a}createCheckbox(e,t){const a=Array.isArray(e)?e:[e],s=a.reduce((e,t)=>e||this.searchOptions[t],!1),n="checkbox-"+AppUtils.randomHexstring(),i=$("<input/>").addClass("form-check-input").attr("type","checkbox").attr("id",n).attr("value",a.join(",")).prop("checked",s);return i.off("click").on("click",e=>{const t=i.is(":checked");return a.forEach(e=>this.searchOptions[e]=t),!0}),$("<div/>").addClass("form-check form-check-inline mr-2").append(i).append($("<label/>").addClass("form-check-label mx-1").attr("for",n).append(t))}validateForm(e,t){return e.preventDefault(),!1!==t[0].checkValidity()||(e.stopPropagation(),!1)}createSearchResults(){const e=$("<p/>").addClass("lead").html(Localization.Messages.SearchResultDesc),t=this.makeSearchResultTableHeaders(),a=$("<table/>").addClass("table table-hover lead-xs");a.append($("<thead/>").append(t)),a.append($("<tbody/>").attr("id",ID_SEARCHRESULT_LIST));const s=$("<button/>").addClass("btn btn-outline-dark").html(Localization.Messages.LoadMore);s.off("click").on("click",async()=>this.scanMoreResults(s));const n=$("<form/>").addClass("form-inline collapse").append($("<div/>").addClass("mx-auto").append(s));return n.submit(e=>e.preventDefault()),$("<div/>").addClass("col-12 p-0 m-0 pb-4").attr("id",ID_SEARCHRESULT_CONTAINER).append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(e)).append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(a)).append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(n))}makeSearchResultTableHeaders(){const e=["#",Localization.Messages.FileType,Localization.Messages.Name,Localization.Messages.KnownFaces,Localization.Messages.LabelsModeration,Localization.Messages.TranscriptPhrasesEntities,Localization.Messages.VisualText,Localization.Messages.ContentAttributes].map(e=>$("<th/>").addClass("align-middle text-center b-300").attr("scope","col").append(e));return $("<tr/>").append(e)}searchResultContainer(){return this.slide.find("#"+ID_SEARCHRESULT_CONTAINER)}async refreshSearchResults(e){const t=this.searchResultContainer().find("#"+ID_SEARCHRESULT_LIST);if(e&&e.hits)for(;e.hits.length;){const a=e.hits.shift(),s=a.uuid;let n=t.find(`tr[data-uuid="${s}"]`);if(n.length>0)continue;const i=this.mediaManager.findMediaByUuid(s)||await this.mediaManager.insertMedia({uuid:s});i&&(n=await this.createMediaListItem(i,a),t.append(n))}return this.refreshLoadButton(e.nextToken)}async createMediaListItem(e,t){const a=$("<tr/>").attr("data-uuid",e.uuid);a.off("click").on("click",a=>{a.preventDefault();const s={indices:Object.keys(t.indices),query:this.searchOptions.query,exact:this.searchOptions.exact};return this.slide.trigger(CategorySlideComponentEvents.Media.Selected,[e,s])});const s=this.createThumbnail(e),n=this.makeTableRowItemByMediaType(e.type),i=this.makeTableRowItem(AppUtils.shorten(e.basename,34)),o=this.makeTableRowItemByIndexTypes([AnalysisTypes.Rekognition.Celeb,AnalysisTypes.Rekognition.FaceMatch],t.indices),r=this.makeTableRowItemByIndexTypes([AnalysisTypes.Rekognition.Label,AnalysisTypes.Rekognition.CustomLabel,AnalysisTypes.Rekognition.Moderation],t.indices),l=this.makeTableRowItemByIndexTypes([AnalysisTypes.Transcribe,AnalysisTypes.Comprehend.Keyphrase,AnalysisTypes.Comprehend.Entity,AnalysisTypes.Comprehend.CustomEntity],t.indices),d=this.makeTableRowItemByIndexTypes([AnalysisTypes.Rekognition.Text,AnalysisTypes.Textract],t.indices),c=this.makeTableRowItemContentMetadata(t.indices.ingest);return a.append(await s).append(n).append(i).append(o).append(r).append(l).append(d).append(c)}makeTableRowItemByIndexTypes(e,t){let a=e.map(e=>Object.keys(t[e]||{})).flat();a=[...new Set(a)];const s=a.slice(0,2).map(e=>$("<span/>").addClass("badge badge-pill badge-secondary mr-1 mb-1 lead-xxs p-2 b-300").append(e));return a.length>2&&s.push($("<span/>").addClass("badge badge-pill badge-light mr-1 mb-1 lead-xxs p-2 b-300").append(Localization.Messages.More)),this.makeTableRowItem(s)}makeTableRowItem(e){const t=$("<td/>").addClass("w-96min align-middle text-center b-300");if(e&&e.length)return t.append(e);const a=$("<i/>").addClass("far fa-times-circle lead text-secondary");return t.append(a)}makeTableRowItemByMediaType(e){let t;switch(e){case MediaTypes.Video:t="bg-success";break;case MediaTypes.Podcast:t="bg-primary";break;case MediaTypes.Photo:t="bg-secondary";break;case MediaTypes.Document:t="bg-warning";break;default:t=void 0}return this.makeTableRowItem(e).addClass(t).addClass("text-white")}makeTableRowItemContentMetadata(e){const t=this.searchOptions.query.split(" ").map(e=>e.toLowerCase());if(!e)return this.makeTableRowItem();const a=[e.basename,...Object.values(e.attributes||{})].filter(e=>{for(let a of t)if(String(e).toLowerCase().indexOf(a)>=0)return!0;return!1}),s=$("<p/>").addClass("p-overflow").append(a);return this.makeTableRowItem(s)}async createThumbnail(e){const t=await e.getThumbnail();return $("<td/>").addClass("align-middle text-center bg-light p-0 m-0").append($("<img/>").addClass("search-thumbnail").attr("src",t))}refreshLoadButton(e){const t=this.searchResultContainer().find("form");t.removeClass("collapse");const a=t.find("button");return a.prop("data-token",e),void 0===e?a.addClass("disabled").attr("disabled","disabled").html(Localization.Messages.NoMoreData):a.removeClass("disabled").removeAttr("disabled").html(Localization.Messages.LoadMore),a}resetSearchResults(){const e=this.searchResultContainer();return e.find("#"+ID_SEARCHRESULT_LIST).children().remove(),e.find("form").addClass("collapse")}async scanMoreResults(e){const t=e.prop("data-token");this.searchOptions.query&&t&&(this.loading(!0),await this.startSearch({...this.searchOptions,token:Number.parseInt(t,10)}),this.loading(!1))}async loadSettings(){return this.searchOptions=await this.settingStore.getItem("search-options")||DEFAULT_OPTIONS,this.searchOptions}async saveSettings(e){const t={...e};return delete t.query,this.settingStore.putItem("search-options",t)}async startSearch(e){const t=await ApiHelper.search(e);return this.refreshSearchResults(t)}}class SearchPreviewSlideComponent extends BasePreviewSlideComponent{}class SearchTab extends BaseMediaTab{constructor(e,t){super(e,Localization.Messages.Search,t),this.$categorySlideComponent=new SearchCategorySlideComponent,this.$previewSlideComponent=new SearchPreviewSlideComponent,this.$tabLink.addClass("ml-auto"),this.$tabLink.find("a").addClass("search-border")}}const DESC=['Search similar items using Amazon Neptune and <a href="https://aws.amazon.com/neptune/machine-learning/" target="_blank">Amazon Neptune ML</a> that creates embeddings from the graph database. The embeddings are then indexed into an Amazon OpenSearch Service along with the K-nearest neighbors (KNN) plugin.',"Or, traverse the knowledge graph to find items based on genre, category, keyword, topic, and so forth."].map(e=>`<p>${e}</p>`),ID_SIMILARITY_LIST="similarity-list-"+AppUtils.randomHexstring(),ID_GRAPH="graph-"+AppUtils.randomHexstring(),ID_RELEVANT_ITEMS="relevant-items-"+AppUtils.randomHexstring(),ID_LESS_RELEVANT_ITEMS="less-relevant-items-"+AppUtils.randomHexstring(),GRAPH_NODE_TYPES="graph-node-types",NODE_VIDEO="Video",NODE_CELEBRITY="celebrity",NODE_INDUSTRY="industry",NODE_PRODUCTS="products",NODE_SERVICES="services",NODE_EVENT_TYPE="event_type",NODESIZE_BY_TYPE={event_type:50,Video:45,industry:40,celebrity:35,products:30,services:25},PAGESIZE=10,SIMILARITY_SIZE=5;AppUtils.randomHexstring(),AppUtils.randomHexstring();const OPTKEY_EXACT="exact",OPTKEY_QUERY="query",OPTKEY_PAGESIZE="pageSize",OPTVAL_PAGESIZE10=10,INDEX_INGEST="ingest";MediaTypes.Video,MediaTypes.Photo,MediaTypes.Podcast,MediaTypes.Document,AnalysisTypes.Transcribe,AnalysisTypes.Rekognition.Celeb,AnalysisTypes.Rekognition.FaceMatch,AnalysisTypes.Rekognition.Label,AnalysisTypes.Rekognition.CustomLabel,AnalysisTypes.Rekognition.Moderation,AnalysisTypes.Rekognition.Text,AnalysisTypes.Textract,AnalysisTypes.Comprehend.Keyphrase,AnalysisTypes.Comprehend.Entity,AnalysisTypes.Comprehend.CustomEntity;const UNICODE_CHARACTER_SETS="[0-9A-Za-zA-Za-z------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- ,.'-]{1,}";class RecommendCategorySlideComponent extends BaseSlideComponent{constructor(){super(),this.$mediaManager=MediaManager.getSingleton(),this.$settingStore=SettingStore.getSingleton(),this.$imageStore=ImageStore.getSingleton(),this.$graph=void 0,this.$graphMapping=void 0}get mediaManager(){return this.$mediaManager}get settingStore(){return this.$settingStore}get imageStore(){return this.$imageStore}get graph(){return this.$graph}set graph(e){this.$graph=e}get graphMapping(){return this.$graphMapping}set graphMapping(e){this.$graphMapping=e}async show(){if(!this.initialized){const e=$("<div/>").addClass("row no-gutters");this.slide.append(e);const t=this.createDescription();e.append(t);const a=this.createSimilaritySearchForm();e.append(a);const s=this.createInteractiveGraphSearch();e.append(s);const n=this.createLoading();e.append(n)}return super.show()}createDescription(){const e=$("<section/>").addClass("col-9 p-0 mx-auto mt-4"),t=$("<p/>").addClass("lead").html(DESC);return e.append(t),e}createSimilaritySearchForm(){const e=$("<section/>").addClass("col-12 bg-light"),t=$("<div/>").addClass("col-9 p-0 mx-auto my-4");e.append(t);const a=$("<p/>").addClass("lead-m").append("Search similar items (Amazon Neptune ML embeddings)");t.append(a);const s=$("<form/>").addClass("px-0 form-inline needs-validation").attr("novalidate","novalidate").attr("role","form");t.append(s);const n=this.createSearchInput(s);s.append(n);const i=this.createSubmitButton(s);s.append(i);const o=$("<section/>").attr("id",ID_SIMILARITY_LIST);return t.append(o),e}createSearchInput(e){const t=$("<input/>").addClass("form-control mr-2 col-4").attr("type","search").attr("pattern",UNICODE_CHARACTER_SETS).attr("placeholder",Localization.Messages.Search);return t.keypress(async e=>{if(13===e.which){e.preventDefault();return t.siblings('button[type="submit"]').trigger("click")}return!0}),t}createSubmitButton(e){const t=$("<button/>").addClass("btn btn-outline-success my-2").attr("type","submit").append(Localization.Messages.Submit);return t.on("click",async t=>{t.preventDefault();const a=this.slide.find("section#"+ID_SIMILARITY_LIST),s=e.find("input").val();s?await this.searchSimilarity(a,s):a.children().remove()}),t}async searchSimilarity(e,t,a=5){try{this.loading(!0);const s=await this.graphApi({op:"opensearch",term:t,size:a});await this.refreshSimilaritySearchResult(e,t,s)}catch(e){console.error(e)}finally{this.loading(!1)}}async refreshSimilaritySearchResult(e,t,a){e.children().remove();let s=ID_RELEVANT_ITEMS;const n=await Promise.all(a.map(e=>this.mediaManager.lazyGetByUuid(e.id)));let i=$("<span/>").addClass("lead-s").html(`Most relevant contents related to <strong>${t}</strong> (${n.length})`),o=await this.createSearchResultDetails(i,s,n,!0);for(e.append(o),s=ID_LESS_RELEVANT_ITEMS;a.length;){const t=a.shift();if(!t.similarItems||t.similarItems.length<=0)continue;const r=n.find(e=>e.uuid===t.id);if(!r)continue;const l=await Promise.all(t.similarItems.map(e=>this.mediaManager.lazyGetByUuid(e.id)));i=$("<span/>").addClass("lead-s").html(`Contents similar to <strong>${AppUtils.shorten(r.basename,96)}</strong> (${l.length})`),o=await this.createSearchResultDetails(i,s,l,!1),e.append(o)}}async createSearchResultDetails(e,t,a,s=!1){const n=$("<details/>");s&&n.attr("open",!0);const i=$("<summary/>").addClass("my-2");n.append(i),i.append(e);const o=$("<div/>").addClass("row no-gutters mt-4").attr("id",t);return n.append(o),await Promise.all(a.map(e=>this.createMediaListItem(e,o))),n}async createMediaListItem(e,t){const a=$("<div/>").addClass("col-2 p-0 m-0").attr("data-uuid",e.uuid);t.append(a);const s=$("<table/>").addClass("table table-sm lead-xxs text-center no-border");a.append(s);const n=$("<tbody/>");s.append(n);const i=await this.makeItemThumbnail(e);i.on("click",async t=>{t.preventDefault();let a=this.mediaManager.findMediaByUuid(e.uuid);void 0===a&&(a=await this.mediaManager.insertMedia({uuid:e.uuid}),this.mediaManager.addMediaToCollection(a)),a&&this.slide.trigger(CategorySlideComponentEvents.Media.Selected,[a])}),n.append(i);const o=this.makeItemCaption(e.basename);n.append(o)}async makeItemThumbnail(e){const t=await e.getThumbnail(),a=$("<tr/>"),s=$("<td/>");a.append(s);const n=$("<div/>").addClass("image-container");s.append(n);const i=$("<div/>").addClass("overlay");n.append(i);const o=$("<i/>").addClass("far fa-image lead-xxl text-white");i.append(o);const r=$("<img/>").addClass("w-100").css("background-color","#aaa");n.append(r),void 0!==t&&(r.attr("src",t),i.addClass("collapse"));const l=$("<div/>").addClass("preview");n.append(l);const d=$("<i/>").addClass("far fa-play-circle center lead-xxl text-white");return l.append(d),a}makeItemCaption(e){const t=$("<tr/>"),a=$("<td/>").addClass("lead-xxs");t.append(a);const s=$("<span/>").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",e).html(AppUtils.shorten(e,32)).tooltip({trigger:"hover"});return a.append(s),t}createInteractiveGraphSearch(){const e=$("<section/>").addClass("col-12"),t=$("<div/>").addClass("col-9 p-0 mx-auto my-4");e.append(t);const a=$("<p/>").addClass("lead-m").append("Traverse knowledge graph (Amazon Neptune) interactively");t.append(a);const s=$("<form/>").addClass("px-0 form-inline needs-validation").attr("novalidate","novalidate").attr("role","form");t.append(s);const n=this.createSelectOptions(s);s.append(n);const i=this.createLoadMoreButton(s);s.append(i);const o=$("<section/>").addClass("mt-4").addClass("knowledge-graph").attr("id",ID_GRAPH);return t.append(o),e}createSelectOptions(e){const t=$("<select/>").addClass("custom-select col-4 mr-2");return t.ready(async()=>{try{this.loading(!0),t.prop("disabled","disabled"),t.children().remove();const e=$("<option/>").attr("value","undefined").append("Choose a node type to start...");t.append(e);const a=await this.getNodeTypes(),s=Object.keys(a);this.graphMapping=s.reduce((e,t,a)=>({...e,[t]:{categoryId:a,nodes:{}}}),{});const n=s.map(e=>{const t=`${e} (${a[e]})`;return $("<option/>").attr("value",e).data("items",a[e]).data("next-token",0).append(t)});t.append(n)}catch(e){console.error(e)}finally{t.prop("disabled",!1),this.loading(!1)}}),t.on("change",async()=>{try{this.loading(!0);const e=t.val();if("undefined"===e){if(console.log("EmptyGraph()"),this.graph){const e=this.graph.getOption().series[0];e.data=[],e.links=[],this.graph.setOption({series:[e]})}}else{console.log(`RenderGraph(${e})`);const a=this.slide.find("section#"+ID_GRAPH),s=t.children("option:selected").first();let n,i=s.data("next-token");"celebrity"===e&&(n=["Andy Jassy","Werner Vogels","Jeff Bezos"].join(","));const o=await this.queryNodesBy(e,i,n);i+=o.length,s.data("next-token",i),await this.buildGraph(a,o);t.children("option:not(:selected)").data("next-token",0)}}catch(e){console.error(e)}finally{this.loading(!1)}}),t}async graphApi(e){const t=new URL(SolutionManifest.KnowledgeGraph.Endpoint);Object.keys(e).forEach(a=>{void 0!==e[a]&&t.searchParams.append(a,e[a])});const a={method:"GET",mode:"cors",cache:"no-cache",headers:{"Content-Type":"application/json","x-api-key":SolutionManifest.KnowledgeGraph.ApiKey}};let s=4;for(;s--;){const e=fetch(t,a).then(e=>e.ok?e.json():new Error);if(!(e instanceof Error))return e}}async getNodeTypes(){let e=await this.settingStore.getItem(GRAPH_NODE_TYPES);return void 0===e&&(e=await this.graphApi({op:"vertices"}).then(e=>e[0]),await this.settingStore.putItem(GRAPH_NODE_TYPES,e)),e}async queryNodesBy(e,t,a){return this.graphApi({op:"query",type:"vertice",label:e,token:t,names:a,pagesize:10}).then(e=>e.map(e=>Object.keys(e).reduce((t,a)=>({...t,..."object"==typeof e[a]?e[a]:{[a]:e[a]}}),{})))}async getConnectedNodes(e,t,a=0){return this.graphApi({op:"query",type:"vertice",label:e,id:t,token:a,pagesize:10}).then(e=>{if(!e)return;const t=[];for(;e.length;){const a=e.shift(),s=a.findIndex(e=>void 0!==e.IN);if(s<0)continue;const n=a.splice(s,1).shift();let i=(a.find(e=>e.id===n.IN.id)||{}).name;n.IN.name=i,i=(a.find(e=>e.id===n.OUT.id)||{}).name,n.OUT.name=i,t.push(n)}return t})}async buildGraph(e,t){const a=Math.max(Math.round(e.height()),800),s=Math.max(Math.round(e.width()),800),n=this.graph||echarts.init(e[0],null,{renderer:"canvas",useDirtyRect:!1,width:s,height:a});let i;n.on("click",e=>{1===e.event.event.detail&&(i=setTimeout(async()=>{const t=e.data.value[0];if(console.log("click",e,t),"Video"===e.data.name&&void 0!==t.id){let e=this.mediaManager.findMediaByUuid(t.id);void 0===e&&(e=await this.mediaManager.insertMedia({uuid:t.id}),this.mediaManager.addMediaToCollection(e),this.slide.trigger(CategorySlideComponentEvents.Media.Selected,[e]))}},300))}),n.on("dblclick",async e=>{if(2===e.event.event.detail){clearTimeout(i);try{this.loading(!0);const t=e.name,a=e.data,s=a.value[0];if(console.log("dblclick",e,s),!0!==s.traversed){const n=await this.getConnectedNodes(t,s.id,s.token);if(void 0===n)return;0===n.length?s.traversed=!0:(s.traversed=!1,s.token=(s.token||0)+n.length);const i=this.graph.getOption().series[e.seriesIndex];for(;n.length;){const e=n.shift();let t,o;e.IN.id===s.id?(t=a,o=await this.createAdjacentNode(e.OUT,i)):e.OUT.id===s.id&&(o=a,t=await this.createAdjacentNode(e.IN,i)),void 0!==t&&void 0!==o&&this.createRelationship(t,o,e,i)}this.graph.setOption({series:[i]})}}catch(e){console.error(e)}finally{this.loading(!1)}}});const o=await Promise.all(t.map((e,t)=>this.createNode(e,t))),r=this.makeGraphOptions({nodes:o,links:[],categories:Object.keys(this.graphMapping).map(e=>({name:e}))});return n.setOption(r),this.graph=n,n}async createNode(e,t){let a,s=e.name;if("Video"===e.label){const t=await this.mediaManager.lazyGetByUuid(e.id);void 0!==t&&(a=await t.getThumbnail(),s=t.basename)}else{const t=e.label.trim().replace(/[^a-zA-Z0-9-]/g,"-").replace(/-{2,}/g,"-").toLowerCase(),s=e.name.split("-")[0].trim().replace(/[^a-zA-Z0-9-]/g,"-").replace(/-{2,}/g,"-").toLowerCase(),n="celebrity"===e.label?".png":".svg";a=await this.imageStore.getBlob(`./images/kg/${t}/${s}${n}`)}return this.parseNode({...e,name:s,image:a},t)}async createAdjacentNode(e,t){let a=t.data.findIndex(t=>t.value[0].id===e.id);if(a>=0)return t.data[a];a=t.data.length;const s=await this.createNode(e,a);return t.data.push(s),s}createRelationship(e,t,a,s){const n=s.links.findIndex(e=>e.value[0].id===a.id);if(n>=0)return s.links[n];const i={source:e.id,target:t.id,value:[{id:a.id,desc:`${AppUtils.shorten(e.value[0].name,32)} > ${AppUtils.shorten(t.value[0].name,32)}`}]};return s.links.push(i),i}makeGraphOptions(e){return{title:{},tooltip:{show:!0,trigger:"item",enterable:!0,alwaysShowContent:!1,padding:0,extraCssText:"border-radius: 0",formatter:e=>{if("edge"===e.dataType){const t=$("<div/>").addClass("my-2"),a=$("<p/>").addClass("text-truncate").append(e.value[0].desc||e.name);return t.append(a),t.prop("outerHTML")}if("node"===e.dataType){const t=e.value[0],a=$("<div/>");if("Video"===e.name){a.addClass("graph-tooltip");const e=$("<img/>").attr("src",t.image);a.append(e);const s=$("<p/>").addClass("mx-2 my-2 text-truncate").append(t.name);return a.append(s),a.prop("outerHTML")}a.addClass("row no-gutters");let s=$("<i/>").addClass("ml-2 my-2").addClass("far fa-question-circle").addClass("graph-avatar");t.image&&(s=$("<img/>").addClass("mx-2 my-auto").addClass("graph-avatar").attr("src",t.image)),a.append(s);const n=$("<p/>").addClass("my-auto mr-2 text-truncate").append(t.name);return a.append(n),a.prop("outerHTML")}return e.value}},legend:[{data:e.categories.map(e=>e.name)}],animationDuration:1500,animationEasingUpdate:"quinticInOut",series:[{name:"Graph database",type:"graph",layout:"none",data:e.nodes,links:e.links,categories:e.categories,roam:"move",label:{show:!0,position:"right",formatter:e=>AppUtils.shorten(e.value[0].name,32)},lineStyle:{color:"source",curveness:.3},emphasis:{focus:"adjacency",lineStyle:{width:10}}}]}}parseNode(e,t){const a=e.label;return{id:t,name:a,symbolSize:NODESIZE_BY_TYPE[a]||10,...this.computeXYCoord(),value:[e],category:this.graphMapping[a].categoryId}}computeXYCoord(){return{x:Math.floor(2410*Math.random()-1200),y:Math.floor(2410*Math.random()-1200)}}createLoadMoreButton(e){const t=$("<button/>").addClass("btn btn-outline-success my-2").attr("type","submit").append("Load more");return t.on("click",async t=>{try{this.loading(!0),t.preventDefault();const a=e.find("select"),s=a.val();if("undefined"===s)return!1;const n=a.children("option:selected").first();let i=n.data("next-token");const o=await this.queryNodesBy(s,i);i+=o.length,n.data("next-token",i);const r=this.graph.getOption().series[0];for(;o.length;){const e=o.shift();let t=r.data.find(t=>t.value[0].id===e.id);void 0===t&&(t=await this.createNode(e,r.data.length),r.data.push(t))}return this.graph.setOption({series:[r]}),!0}catch(e){return console.error(e),!1}finally{this.loading(!1)}}),t}}class RecommendPreviewSlideComponent extends BasePreviewSlideComponent{}const TABNAME="Search Knowledge Graph";class RecommendTab extends BaseMediaTab{constructor(e,t){super(e,TABNAME,t),this.$categorySlideComponent=new RecommendCategorySlideComponent,this.$previewSlideComponent=new RecommendPreviewSlideComponent,this.$tabLink.addClass("ml-2"),this.$tabLink.find("a").addClass("search-border bg-dark text-white")}static canSupport(){return SolutionManifest.KnowledgeGraph&&SolutionManifest.KnowledgeGraph.Endpoint&&SolutionManifest.KnowledgeGraph.ApiKey}}class CollectionTab extends BaseTab{constructor(e=!1){super(Localization.Messages.CollectionTab,{selected:e}),this.$ids={...super.ids,plugins:"plugins-"+AppUtils.randomHexstring(),tablist:"tablist-"+AppUtils.randomHexstring(),tabcontent:"tabcontent-"+AppUtils.randomHexstring()};const t=$("<div/>").attr("id",this.$ids.plugins);this.$tabControllers=[new VideoTab(!0,t),new PhotoTab(!1,t),new PodcastTab(!1,t),new DocumentTab(!1,t),new SearchTab(!1,t)],RecommendTab.canSupport()&&this.$tabControllers.push(new RecommendTab(!1,t)),this.$tabControllers=this.$tabControllers.reduce((e,t)=>({...e,[t.tabId]:t}),{}),this.$plugins=t}get ids(){return this.$ids}get plugins(){return this.$plugins}get tabControllers(){return this.$tabControllers}async show(){if(!this.initialized){const e=$("<nav/>").addClass("navbar navbar-expand-lg navbar-light bg-light").append(this.createTabToggle()).append(this.createTabItems()).append(this.plugins);this.tabContent.append(e),this.tabContent.append(this.createTabContents());const t=this.tabContent.find(".tab-pane.active.show").first().attr("aria-labelledby");this.tabControllers[t].show()}return super.show()}createTabToggle(){const e=this.ids.tablist;return $("<button/>").addClass("navbar-toggler").attr("type","button").attr("data-toggle","collapse").attr("data-target","#"+e).attr("aria-controls",e).attr("aria-expanded","false").attr("aria-label","Collection tabs").append($("<span/>").addClass("navbar-toggler-icon"))}createTabItems(){const e=this.ids.tablist,t=$("<div/>").addClass("navbar-nav w-100").attr("role","tablist");return Object.values(this.tabControllers).forEach(e=>{t.append(e.tabLink)}),$("<div/>").addClass("collapse navbar-collapse").attr("id",e).append(t)}createTabContents(){const e=$("<div/>").addClass("tab-content").attr("id",this.ids.tabcontent);return Object.values(this.tabControllers).forEach(t=>{e.append(t.tabContent)}),e}}class BaseFile extends(mxReadable(class{})){constructor(e,t,a=!0){super(),this.$displayName=e,this.$canSupport=!!a,this.$file=t,this.$mime=AppUtils.Mime.getMime(t),this.$fileId="file-"+AppUtils.randomHexstring()}static get Events(){return{File:{Remove:"file:remove"}}}get file(){return this.$file}get mime(){return this.$mime}get displayName(){return this.$displayName}get canSupport(){return this.$canSupport}get fileId(){return this.$fileId}async createItem(){const e=$("<li/>").addClass("list-group-item d-flex").attr("data-file-id",this.fileId).attr("data-display-name",this.displayName),t=$("<i/>").addClass(this.getIcon()+" align-self-center").css("font-size","3rem").css("font-weight",300).css("color","#888"),a=$("<dl/>").addClass("row lead-xs ml-2 col-9 no-gutters").append($("<dt/>").addClass("text-left col-sm-1").append(Localization.Messages.FileName)).append($("<dd/>").addClass("col-sm-11 my-0").append(this.displayName)).append($("<dt/>").addClass("text-left col-sm-1 my-0").append(Localization.Messages.FileSize)).append($("<dd/>").addClass("col-sm-11 my-0").append(BaseFile.readableFileSize(this.file.size))).append($("<dt/>").addClass("text-left col-sm-1 my-0").append(Localization.Messages.FileType)).append($("<dd/>").addClass("col-sm-11 my-0").append(this.mime||"--")),s=$("<button/>").addClass("btn btn-sm btn-secondary text-capitalize mb-1 ml-1").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",Localization.Tooltips.RemoveFromList).append(Localization.Buttons.Remove).tooltip({trigger:"hover",boundary:"window"});s.off("click").on("click",t=>{e.trigger(BaseFile.Events.File.Remove,[this])});const n=$("<i/>").addClass("fas fa-exclamation-circle mr-2").css("font-size","1.2rem").css("color","#dc3545").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",Localization.Tooltips.UploadOnly).tooltip({trigger:"hover",boundary:"window"});this.canSupport&&n.addClass("collapse");const i=$("<div/>").addClass("ml-auto align-self-center").append(n).append(s);return e.append(t).append(a).append(i)}getIcon(){const[e,t]=(this.mime||"").split("/");switch(e){case"video":return"far fa-file-video";case"audio":return"far fa-file-audio";case"image":return"far fa-file-image"}return"pdf"===t?"far fa-file-pdf":"msword"===t||"vnd.openxmlformats-officedocument.wordprocessingml.document"===t?"far fa-file-word":"vnd.ms-powerpoint"===t||"vnd.openxmlformats-officedocument.presentationml.presentation"===t?"far fa-file-powerpoint":"vnd.ms-excel"===t||"vnd.openxmlformats-officedocument.spreadsheetml.sheet"===t?"far fa-file-excel":"zip"===t||"x-7z-compressed"===t||"vnd.rar"===t||"gzip"===t?"far fa-file-archive":"csv"===t?"fas fa-file-csv":"json"===t||"xml"===t?"far fa-file-code":"far fa-file-alt"}}class FileItem extends BaseFile{constructor(e,t,a){super(e,t,a),this.$uuid=void 0,this.$checksum=void 0,this.$attributes=void 0,this.$analysis=void 0}get uuid(){return this.$uuid}get checksum(){return this.$checksum}get attributes(){return this.$attributes}get analysis(){return this.$analysis}get group(){return(this.attributes||{}).group}setUuid(e){this.$uuid=e}setChecksum(e){this.$checksum=e}setAttributes(e){this.$attributes={...e}}setAnalysis(e){this.$analysis={...e}}resolveKey(){const e=(this.attributes||{}).group,t=this.displayName,a="/"===t.charAt(0)?t.slice(1):t;if(e)return`${e}/${a}`;if(a.indexOf("/")>0)return a;const s=a.lastIndexOf(".");return`${a.substring(0,s<0?a.length:s)}/${a}`}}var mxDropzone=e=>class extends e{fileEntrySupported(){return"function"==typeof DataTransferItem.prototype.webkitGetAsEntry}canSupport(e){return!0}createDropzone(e){const t=$("<div/>").addClass("d-flex justify-content-center dropzone-bg").append($("<span/>").addClass("align-self-center").html(e)),a=$("<div/>").addClass("dropzone").append($("<p>").addClass("lead m-auto").append(t));return["dragenter","dragover","dragleave","drop"].forEach(e=>{a.off(e).on(e,e=>{e.preventDefault(),e.stopPropagation()})}),a.on("dragenter",async e=>{}),a.on("dragleave",async e=>{}),a.on("drop",async e=>this.processDropEvent(e)),a}async processDropEvent(e){try{"function"==typeof this.loading&&this.loading(!0);const t=await this.processDropItems(e.originalEvent.dataTransfer);return Promise.all(t.map(e=>this.processEachFileItem(e)))}catch(e){return}finally{"function"==typeof this.loading&&this.loading(!1)}}async processDropItems(e){return this.fileEntrySupported()?this.useGetAsEntry(e):this.useFileReader(e)}async useGetAsEntry(e){const t=[],a=[];for(let s of e.items){const e=s.webkitGetAsEntry();e.isFile?t.push(this.readFileEntry(e)):a.push(this.readDirectoryEntry(e))}const s=await Promise.all(t);return(await Promise.all(a)).reduce((e,t)=>e.concat(t),s).filter(e=>e)}async readFileEntry(e){return new Promise((t,a)=>{e.file(a=>t(new FileItem(e.fullPath,a,this.canSupport(a))),()=>t(void 0))})}async readEntries(e){return new Promise(t=>{e.readEntries(e=>{if(0===e.length)return t(void 0);const a=[],s=[];for(;e.length;){const t=e.shift();t.isFile?a.push(this.readFileEntry(t)):s.push(this.readDirectoryEntry(t))}return t({files:a,dirs:s})})})}async readDirectoryEntry(e){const t=e.createReader(),a=[],s=[];let n;do{n=await this.readEntries(t),n&&(a.splice(a.length,0,...n.files),s.splice(s.length,0,...n.dirs))}while(void 0!==n);const i=await Promise.all(a);return(await Promise.all(s)).reduce((e,t)=>e.concat(t),i)}async useFileReader(e){const t=[];for(let a of e.files)t.push(this.readFile(a));return await Promise.all(t)}async readFile(e){return new FileItem(e.name,e,this.canSupport(e))}async processEachFileItem(e){throw new Error("subclass to implement")}};class BaseUploadSlideComponent extends BaseSlideComponent{static get Controls(){return{Back:"slide:control:back",Next:"slide:control:next",Cancel:"slide:control:cancel",Done:"slide:control:done",StartOver:"slide:control:startover",QuickUpload:"slide:control:quickupload",StartNow:"slide:control:startnow"}}}class DropzoneSlideComponent extends(mxDropzone(BaseUploadSlideComponent)){constructor(){super(),this.$ids={...this.$ids,uploadList:"upload-list"},this.$fileList=[]}static get Events(){return{Dropzone:{Item:{Added:"dropzone:file:added",Empty:"dropzone:file:empty"}}}}get fileList(){return this.$fileList}canSupport(e){const t=AppUtils.Mime.getKind(e);return t===MediaTypes.Video||t===MediaTypes.Audio||t===MediaTypes.Image||t===MediaTypes.Document}async processDropEvent(e){const t=await super.processDropEvent(e);return t&&(this.fileList.splice(this.fileList.length,0,...t),this.slide.trigger(DropzoneSlideComponent.Events.Dropzone.Item.Added)),t}async processEachFileItem(e){const t=await e.createItem();return t.on(FileItem.Events.File.Remove,()=>this.onFileRemove(t)),this.slide.find("."+this.ids.uploadList).find(".list-group").append(t),e}async clearData(){return this.slide.find("."+this.ids.uploadList).find(".list-group").children().remove(),this.fileList.length=0,this.slide.trigger(DropzoneSlideComponent.Events.Dropzone.Item.Empty),this}async getData(){return this.fileList}async createSlide(){const e=this.createDescription(),t=this.createDropzone(Localization.Messages.DropFileHere),a=this.createUploadList(),s=this.createControls(),n=$("<div/>").addClass("row no-gutters").append($("<div/>").addClass("col-12 p-0 m-0").append(e)).append($("<div/>").addClass("col-12 p-0 m-0 mt-4").append(t)).append($("<div/>").addClass("col-12 p-0 m-0 mt-4").append(a)).append($("<div/>").addClass("col-12 p-0 m-0 mt-4").append(s));return this.slide.append(n),super.createSlide()}createDescription(){return $("<p/>").addClass("lead").html(Localization.Messages.DropzoneDesc)}createControls(){const e=$("<input/>").attr("type","file").attr("multiple","multiple").attr("accept","*").css("display","none"),t=$("<button/>").addClass("btn btn-secondary").html(Localization.Buttons.BrowseFiles),a=$("<div/>").addClass("mr-auto").append(t).append(e),s=$("<button/>").addClass("btn btn-light ml-1").html(Localization.Buttons.Startover),n=$("<button/>").addClass("btn btn-success ml-1").attr("disabled","disabled").html(Localization.Buttons.QuickUpload),i=$("<button/>").addClass("btn btn-primary ml-1").attr("disabled","disabled").html(Localization.Buttons.Next);this.slide.on(DropzoneSlideComponent.Events.Dropzone.Item.Empty,()=>{n.attr("disabled","disabled"),i.attr("disabled","disabled")}),this.slide.on(DropzoneSlideComponent.Events.Dropzone.Item.Added,()=>{this.slide.find("."+this.ids.uploadList).attr("open",""),n.removeAttr("disabled"),i.removeAttr("disabled")}),t.off("click").on("click",()=>e.click()),e.off("change").on("change",async()=>{await this.processInputEvent(event.currentTarget),e.val("")}),s.off("click").on("click",async e=>this.slide.trigger(DropzoneSlideComponent.Controls.StartOver)),n.off("click").on("click",async e=>this.slide.trigger(DropzoneSlideComponent.Controls.QuickUpload,[this.fileList])),i.off("click").on("click",async e=>this.slide.trigger(DropzoneSlideComponent.Controls.Next,[this.fileList]));const o=$("<form/>").addClass("form-inline").append(a).append($("<div/>").addClass("ml-auto").append(s).append(n).append(i));return o.submit(e=>e.preventDefault()),o}async processInputEvent(e){try{this.loading(!0);let t=await this.useFileReader(e);return t=await Promise.all((t||[]).map(e=>this.processEachFileItem(e))),t.length>0&&(this.fileList.splice(this.fileList.length,0,...t),this.slide.trigger(DropzoneSlideComponent.Events.Dropzone.Item.Added)),t}catch(e){return}finally{this.loading(!1)}}createUploadList(){const e=$("<details/>").addClass("my-2 "+this.ids.uploadList).append($("<summary/>").addClass("mb-2").append(Localization.Messages.FileToBeProcessed)),t=$("<ul/>").addClass("list-group");return e.append(t)}onFileRemove(e){const t=e.data("file-id"),a=this.fileList.findIndex(e=>e.fileId===t);a>=0&&this.fileList.splice(a,1),this.fileList.length||this.slide.trigger(DropzoneSlideComponent.Events.Dropzone.Item.Empty),setTimeout(()=>e.remove(),300)}}class AttributeSlideComponent extends BaseUploadSlideComponent{constructor(){super(),this.$ids={...this.$ids,groupName:"attr-"+AppUtils.randomHexstring(),attributeForm:"attr-"+AppUtils.randomHexstring()},this.$group="",this.$attributeList=[]}static get Constants(){return{Attribute:{Max:20}}}get group(){return this.$group}set group(e){this.$group=e}get attributeList(){return this.$attributeList}async saveData(){const e=this.slide.find("#"+this.ids.groupName);this.group=e.val(),this.attributeList.length=0;this.slide.find("#"+this.ids.attributeForm).children(".input-group").each((e,t)=>{const a=$(t).find('[data-attr-type="key"]').val(),s=$(t).find('[data-attr-type="value"]').val();a&&s&&this.attributeList.push({key:a,value:s})})}async getData(){const e=this.attributeList.reduce((e,t)=>({...e,[t.key]:t.value}),{});return this.group&&(e.group=this.group),e}async clearData(){this.slide.find("#"+this.ids.attributeForm).children(".input-group").remove(),this.slide.find("#"+this.ids.groupName).val(""),this.attributeList.length=0,this.group=""}async createSlide(){const e=this.createDescription(),t=this.createGroupName(),a=this.createAttributes(),s=$("<div/>").addClass("attr-group").addClass("overflow-auto my-auto align-content-start").append(t).append(a),n=this.createControls(),i=$("<div/>").addClass("row no-gutters").append($("<div/>").addClass("col-12 p-0 m-0 mt-4").append(e)).append($("<div/>").addClass("col-12 p-0 m-0 mt-4").append(s)).append($("<div/>").addClass("col-12 p-0 m-0 mt-4").append(n));return this.slide.append(i),super.createSlide()}createDescription(){return $("<p/>").addClass("lead").html(Localization.Messages.AttributeDesc)}createControls(){const e=$("<button/>").addClass("btn btn-light ml-1").html(Localization.Buttons.Back),t=$("<button/>").addClass("btn btn-success ml-1").html(Localization.Buttons.QuickUpload),a=$("<button/>").addClass("btn btn-primary ml-1").html(Localization.Buttons.Next);e.off("click").on("click",async e=>this.slide.trigger(AttributeSlideComponent.Controls.Back)),t.off("click").on("click",async e=>{await this.saveData(),this.slide.trigger(AttributeSlideComponent.Controls.QuickUpload)}),a.off("click").on("click",async e=>{let t=!0;if(this.slide.find("form.needs-validation").each((e,a)=>(t=a[0].checkValidity(),t)),!1===t)return e.preventDefault(),void e.stopPropagation();await this.saveData(),this.slide.trigger(AttributeSlideComponent.Controls.Next)});const s=$("<form/>").addClass("form-inline").append($("<div/>").addClass("ml-auto").append(e).append(t).append(a));return s.submit(e=>e.preventDefault()),s}createGroupName(){const e=$("<span/>").addClass("d-block p-2 bg-light text-black lead").html("Group Name"),t=$("<p/>").addClass("mt-2").html(Localization.Messages.GroupDesc),a=$("<input/>").addClass("form-control mr-2").attr("id",this.ids.groupName).attr("pattern","^[a-zA-Z0-9_-]{0,128}$").attr("placeholder","(Blank)"),s=$("<form/>").addClass("col-4 px-0 needs-validation").attr("novalidate","novalidate").append($("<label/>").addClass("mr-2 sr-only").attr("for",this.ids.groupName).html(Localization.Messages.GroupName)).append(a);return a.focusout(async e=>!!this.validateForm(e,s)||(this.shake(s),await this.showAlert(Localization.Alerts.InvalidGroupName),a.focus(),!1)),a.keypress(async e=>!(13===e.which&&!this.validateForm(e,s))||(this.shake(s),await this.showAlert(Localization.Alerts.InvalidGroupName),a.focus(),!1)),$("<div/>").addClass("mt-0").append(e).append(t).append(s)}createAttributes(){const e=$("<span/>").addClass("d-block p-2 bg-light text-black lead").html("Additional attributes"),t=$("<p/>").addClass("mt-2").html(Localization.Messages.AttrDesc),a=$("<button/>").addClass("btn btn-success mb-2").attr("type","button").html("Add attribute"),s=$("<form/>").addClass("col-9 px-0 needs-validation").attr("id",this.ids.attributeForm).attr("novalidate","novalidate").append(a);return a.off("click").on("click",async e=>(e.preventDefault(),s.children(".input-group").length>=AttributeSlideComponent.Constants.Attribute.Max?(e.stopPropagation(),this.shake(s),await this.showAlert(Localization.Alerts.MaxNumOfAttrs),!1):(s.append(this.createKeyValue()),!0))),$("<div/>").addClass("mt-4").append(e).append(t).append(s)}createKeyValue(){const e=$("<div/>").addClass("input-group mb-2 mr-sm-2"),t=$("<input/>").addClass("form-control col-3").attr("data-attr-type","key").attr("type","text").attr("placeholder","(Key)").attr("pattern","^[a-zA-Z0-9_-]{0,128}$"),a=$("<input/>").addClass("form-control").attr("data-attr-type","value").attr("type","text").attr("placeholder","(Value)").attr("pattern","^[a-zA-Z0-9_%., -]{0,255}$"),s=$("<button/>").addClass("btn btn-secondary ml-1").append($("<i/>").addClass("far fa-times-circle"));return s.off("click").on("click",t=>{t.preventDefault(),e.remove()}),[t,a].forEach(t=>{t.focusout(async a=>{const s=e.parent("form").first();return!(!this.validateForm(a,s)&&!t[0].validity.valid)||(this.shake(s),await this.showAlert(Localization.Alerts.InvalidKeyValue),t.focus(),!1)}),t.keypress(async a=>{if(13===a.which){const s=e.parent("form").first();if(!this.validateForm(a,s)&&!t[0].validity.valid)return this.shake(s),await this.showAlert(Localization.Alerts.InvalidKeyValue),t.focus(),!1}return!0})}),e.append(t).append(a).append(s),e}validateForm(e,t){return e.preventDefault(),!1!==t[0].checkValidity()||(e.stopPropagation(),!1)}}const DATATYPE_SLIDE_CONTROLS="slide-controls";class AnalysisSlideComponent extends(mxAnalysisSettings(BaseUploadSlideComponent)){get parentContainer(){return this.slide}createDescription(){return $("<p/>").addClass("lead").html(Localization.Messages.ReviewAnalysisSettings)}createControls(){const e=$("<button/>").addClass("btn btn-light ml-1").html(Localization.Buttons.Back),t=$("<button/>").addClass("btn btn-primary ml-1").html(Localization.Buttons.Next);e.off("click").on("click",async e=>this.slide.trigger(AnalysisSlideComponent.Controls.Back)),t.off("click").on("click",async e=>this.slide.trigger(AnalysisSlideComponent.Controls.Next));const a=$("<form/>").addClass("form-inline").attr("data-type","slide-controls").append($("<div/>").addClass("ml-auto").append(e).append(t));return a.submit(e=>e.preventDefault()),a}async createSlide(){return await this.show(),this.slide.find("form.col-9").removeClass("col-9").addClass("col-12"),this.slide.find("form[data-type=slide-controls]").parent().removeClass("col-9").addClass("col-12"),super.createSlide()}async getData(){return this.loadLocalSettings()}}class FinalizeSlideComponent extends BaseUploadSlideComponent{constructor(){super(),this.$ids={...this.$ids,tablist:"finalize-"+AppUtils.randomHexstring(),tabcontent:"finalize-"+AppUtils.randomHexstring()},this.$report=[],this.$fileList=[],this.$bucket=SolutionManifest.Ingest.Bucket}static get Constants(){return{Md5:{ChunkSize:8388608},Multipart:{PartSize:8388608,MaxConcurrentUpload:4}}}static get Events(){return{Overall:{Started:"finalize:overall:started",Progress:"finalize:overall:progress",Completed:"finalize:overall:completed"},Process:{Uuid:"finalize:process:uuid",Checksum:"finalize:process:checksum",UploadS3:"finalize:process:uploads3",Statuses:{Started:"finalize:process:started",Completed:"finalize:process:completed",Error:"finalize:process:error"}}}}get bucket(){return this.$bucket}get fileList(){return this.$fileList}set fileList(e){this.$fileList=e}get report(){return this.$report}set report(e){this.$report=e}async getData(){const{elapsed:e,bytes:t}=this.report.reduce((e,t)=>({elapsed:e.elapsed+t.elapsed,bytes:e.bytes+t.src.bytes}),{elapsed:0,bytes:0}),a=this.report.filter(e=>e.error);return{completed:this.report.length-a.length,errors:a.length,elapsed:e,bytes:t,items:this.report}}async clearData(){this.report.length=0,this.slide.find("#"+this.ids.tablist).children().remove(),this.slide.find("#"+this.ids.tabcontent).children().remove(),this.fileList.length=0}async createSlide(){const e=this.createDescription(),t=this.createControls(),a=this.createFinalizedList(),s=$("<div/>").addClass("row no-gutters").append($("<div/>").addClass("col-12 p-0 m-0 mt-4").append(e)).append($("<div/>").addClass("col-12 p-0 m-0 mt-4").append(a)).append($("<div/>").addClass("col-12 p-0 m-0 mt-4").append(t));return this.slide.append(s),super.createSlide()}createDescription(){const e=$("<a/>").attr("href",AWSConsoleS3.getLink(this.bucket)).attr("target","_blank").html(this.bucket),t=Localization.Messages.FinalizeUploadDesc.replace("{{BUCKET}}",e.prop("outerHTML"));return $("<p/>").addClass("lead").html(t)}createControls(){const e=$("<button/>").addClass("btn btn-light ml-1").html(Localization.Buttons.Cancel),t=$("<button/>").addClass("btn btn-success ml-1").html(Localization.Buttons.StartNow),a=$("<button/>").addClass("btn btn-success ml-1 collapse").html(Localization.Buttons.Done),s=$("<span/>").addClass("lead collapse").html(Localization.Statuses.NotStarted),n=$("<a/>").addClass("btn btn-light ml-1 collapse").attr("role","button").attr("href","").attr("download","").attr("target","_blank").html(Localization.Buttons.DownloadSummary),i=()=>{n.addClass("collapse"),a.addClass("collapse"),t.removeClass("collapse"),e.removeClass("collapse"),s.addClass("collapse").removeClass("text-success text-danger").html(Localization.Statuses.NotStarted)};let o;e.off("click").on("click",async e=>{i(),this.slide.trigger(FinalizeSlideComponent.Controls.Cancel)}),t.off("click").on("click",async e=>this.startNow()),a.off("click").on("click",async e=>{i(),this.slide.trigger(FinalizeSlideComponent.Controls.Done)}),this.slide.on(FinalizeSlideComponent.Events.Overall.Started,async(a,s)=>{o=s,t.attr("disabled","disabled"),e.attr("disabled","disabled")}),this.slide.on(FinalizeSlideComponent.Events.Overall.Progress,async(e,t)=>{s.removeClass("collapse").html(`${Localization.Statuses.Processing} (${t+1} / ${o})...`)}),this.slide.on(FinalizeSlideComponent.Events.Overall.Completed,async(i,r)=>{const l=URL.createObjectURL(new Blob([JSON.stringify(r,null,2)],{type:"application/json"}));n.prop("href",l).prop("download","summary.json"),t.addClass("collapse").removeAttr("disabled"),e.addClass("collapse").removeAttr("disabled"),n.removeClass("collapse"),a.removeClass("collapse");const d=`${Localization.Statuses.Completed} / ${Localization.Statuses.Error} / ${Localization.Statuses.Total}: (${r.completed} / ${r.errors} / ${o})`;s.addClass("text-dark").html(d)});const r=$("<form/>").addClass("form-inline").append($("<div/>").addClass("ml-auto").append(s)).append($("<div/>").addClass("ml-auto").append(e).append(t).append(n).append(a));return r.submit(e=>e.preventDefault()),r}createFinalizedList(){const e=$("<div/>").addClass("col-4 px-0 mx-0 overflow-auto h-96").append($("<div/>").addClass("list-group").attr("role","tablist").attr("id",this.ids.tablist)),t=$("<div/>").addClass("col-8 px-0 mx-2 overflow-auto my-auto h-96").append($("<div/>").addClass("tab-content ml-2").attr("id",this.ids.tabcontent));return $("<div/>").addClass("finalize-contaniner").append(e).append(t)}addList(e){const t=this.slide.find("#"+this.ids.tablist).first(),a=this.slide.find("#"+this.ids.tabcontent).first();e.forEach(e=>{const s="tab-"+e.fileId;t.append(this.createItemTab(s,e.file.name,Localization.Statuses.NotStarted)),a.append(this.createItemContent(s,e))}),this.fileList=e}createItemTab(e,t,a){return $("<a/>").addClass("list-group-item list-group-item-action").attr("data-toggle","list").attr("role","tab").attr("href","#"+e).append($("<div/>").addClass("marquee").append($("<span/>").addClass("marquee-target").append(t))).append($("<span/>").addClass("badge badge-light badge-custom").attr("data-status",a).html(a))}createItemContent(e,t){const a=$("<div/>").addClass("tab-pane fade").attr("id",e).attr("role","tabpanel"),s=$("<div/>").addClass("mx-auto"),n=this.createContentSummary(e,t),i=this.createContentStatus(e,t);return s.append(n).append(i),a.append(s)}createContentSummary(e,t){const a=Localization.Messages,s=$("<div/>").attr("data-type","summary"),n=$("<span/>").addClass("d-block p-2 text-black bg-light lead my-2").html(a.Summary);s.append(n);const i=t.resolveKey(),o={[a.Source]:{[a.FileName]:t.displayName,[a.FileSize]:`${AppUtils.readableFileSize(t.file.size)} (${t.file.size} bytes)`,[a.FileType]:t.file.type,[a.LastModified]:new Date(t.file.lastModified).toISOString()},[a.Destination]:{[a.Bucket]:this.bucket,[a.Key]:i},[a.Attributes]:t.attributes};return Object.keys(o).forEach(e=>{const t=$("<details/>").addClass("p-2 my-1").append($("<summary/>").append($("<span/>").addClass("lead").html(e))),a=$("<form/>").addClass("form-inline mt-2");Object.keys(o[e]).forEach(t=>{a.append($("<label/>").addClass("col-3 justify-content-start").html(t)).append($("<input/>").addClass("form-control form-control-sm col-9").attr("type","text").attr("disabled","disabled").attr("value",o[e][t]))}),s.append(t.append(a))}),s}createContentStatus(e,t){const a=$("<div/>").addClass("p-2 my-1").attr("data-file-id",t.fileId),s=$("<div/>").addClass("d-block p-2 text-black bg-light lead my-2").append($("<span/>").addClass("d-inline-flex mr-1").html(Localization.Messages.UploadStatus)).append($("<span/>").addClass("badge badge-light badge-custom").attr("data-status",Localization.Statuses.NotStarted).html(""+Localization.Statuses.NotStarted)),n=this.createUuidFlow(a,t.fileId),i=this.createChecksumFlow(a,t.fileId),o=this.createUploadS3Flow(a,t.fileId);return a.append(s).append(n).append(i).append(o)}createUuidFlow(e,t){const a=this.createFlow("uuid",Localization.Messages.ValidateUuid),s=`${FinalizeSlideComponent.Events.Process.Uuid}:${t}`;return e.on(s,async(s,n)=>{const i={fileId:n.fileId,elapsed:0,src:{name:n.displayName,bytes:n.file.size,type:AppUtils.Mime.getMime(n),lastModified:new Date(n.file.lastModified).getTime()},metrics:{uuid:{startTime:(new Date).getTime()}}},o=`${FinalizeSlideComponent.Events.Process.Statuses.Started}:${n.fileId}`,r=`${FinalizeSlideComponent.Events.Process.Statuses.Error}:${n.fileId}`;if(this.slide.trigger(o,[n.fileId]),i.uuid=await this.createValidUuid(a),i.metrics.uuid.endTime=(new Date).getTime(),i.elapsed+=i.metrics.uuid.endTime-i.metrics.uuid.startTime,!i.uuid)return i.error=Localization.Alerts.CreateUuidError,this.slide.trigger(r,[n.fileId,i.error,i]);n.setUuid(i.uuid);const l=`${FinalizeSlideComponent.Events.Process.Checksum}:${t}`;return e.trigger(l,[n,i])}),a}createChecksumFlow(e,t){const a=this.createFlow("checksum",Localization.Messages.ComputeChecksum),s=`${FinalizeSlideComponent.Events.Process.Checksum}:${t}`;return e.on(s,async(s,n,i)=>{const o={...i,metrics:{...i.metrics,checksum:{type:"md5",startTime:(new Date).getTime()}}};if(o.checksum=await this.computeChecksum(a,n),o.metrics.checksum.endTime=(new Date).getTime(),o.elapsed+=o.metrics.checksum.endTime-o.metrics.checksum.startTime,!o.checksum){o.error=Localization.Alerts.ComputeChecksumError;const e=`${FinalizeSlideComponent.Events.Process.Statuses.Error}:${n.fileId}`;return this.slide.trigger(e,[n.fileId,o.error,o])}n.setChecksum(o.checksum);const r=`${FinalizeSlideComponent.Events.Process.UploadS3}:${t}`;return e.trigger(r,[n,o])}),a}createUploadS3Flow(e,t){const a=this.createFlow("uploads3",Localization.Messages.UploadS3),s=`${FinalizeSlideComponent.Events.Process.UploadS3}:${t}`;return e.on(s,async(e,t,s)=>{const n={...s,dst:{bucket:this.bucket,key:t.resolveKey(),attrs:t.attributes},metrics:{...s.metrics,uploads3:{startTime:(new Date).getTime()}}};let i=await this.uploadS3(a,t,n.dst.bucket,n.dst.key);if(n.metrics.uploads3.endTime=(new Date).getTime(),n.elapsed+=n.metrics.uploads3.endTime-n.metrics.uploads3.startTime,!i){n.error=Localization.Alerts.UploadS3Error;const e=`${FinalizeSlideComponent.Events.Process.Statuses.Error}:${t.fileId}`;return this.slide.trigger(e,[t.fileId,n.error,n])}if(t.canSupport&&(i=await this.startWorkflow(t),!i)){n.error=Localization.Alerts.StartWorkflowError;const e=`${FinalizeSlideComponent.Events.Process.Statuses.Error}:${t.fileId}`;return this.slide.trigger(e,[t.fileId,n.error,n])}const o=`${FinalizeSlideComponent.Events.Process.Statuses.Completed}:${t.fileId}`;return this.slide.trigger(o,[t.fileId,n])}),a}createFlow(e,t){return $("<div/>").addClass("col-12 px-0 d-flex").append($("<div/>").addClass("col-3 justify-content-start my-2").html(t)).append($("<div/>").addClass("col-9 p-0 m-0 d-flex").attr("data-process",e).append($("<div/>").addClass("col-12 justify-content-start px-0 my-2 collapse").attr("data-field","result").html("result goes here")).append(this.createUploadProgressBar()).append($("<div/>").addClass("col-2 align-self-center").attr("data-field","progress").append(this.createUploadProgressInput())))}createUploadProgressBar(){return $("<div/>").addClass("col-10 progress px-0 align-self-center").attr("data-field","progress").css("height","3px").append($("<div/>").addClass("progress-bar bg-success").attr("role","progressbar").attr("aria-valuemin",0).attr("aria-valuemax",100).attr("aria-valuenow",0).css("width","0%"))}createUploadProgressInput(){return $("<input/>").addClass("col-12 px-0 text-center text-muted ml-1").attr("type","text").attr("value","0%").attr("disabled","disabled")}async createValidUuid(e){const t=e.find('[role="progressbar"]'),a=e.find("input"),s=e.find('[data-field="result"]');let n,i,o=10;let r=0;this.updateProgress(t,a,o);do{n=AppUtils.uuid4(),i=await ApiHelper.getRecord(n).catch(()=>({})),o+=10,this.updateProgress(t,a,o)}while(i.uuid&&r++<4);if(!i.uuid)return this.updateProgress(t,a,100),this.showResult(t,a,s,"success",n),n;this.showResult(t,a,s,"danger",Localization.Alerts.CreateUuidError)}async computeChecksum(e,t){const a=e.find('[role="progressbar"]'),s=e.find("input"),n=e.find('[data-field="result"]');let i=1;this.updateProgress(a,s,i);const o=this.getChunkSize(t.file.size);let r;for(let e=0;e<o;e++){if(r=await this.computeChunkChecksum(t.file,e,r).catch(e=>e),r instanceof Error)return void this.showResult(a,s,n,"danger",r.message);i=Math.ceil(r.end/t.file.size*100),this.updateProgress(a,s,i)}const l=this.finalizeChecksum(r);return this.showResult(a,s,n,"success",l),l}getChunkSize(e){return Math.ceil(e/FinalizeSlideComponent.Constants.Md5.ChunkSize)}computeChunkChecksum(e,t,a){return new Promise((s,n)=>{const i=t*FinalizeSlideComponent.Constants.Md5.ChunkSize,o=Math.min(i+FinalizeSlideComponent.Constants.Md5.ChunkSize,e.size),r=new SparkMD5.ArrayBuffer;a&&r.setState(a.state);const l=new FileReader;l.onload=e=>{r.append(e.target.result);const t=r.getState();s({state:t,start:i,end:o})},l.onerror=e=>n(e),l.readAsArrayBuffer(e.slice(i,o))})}finalizeChecksum(e){const t=new SparkMD5.ArrayBuffer;return t.setState(e.state),t.end()}resolvePath(e,t){const a="/"===t.charAt(0)?t.slice(1):t;if(e)return`${e}/${a}`;if(a.indexOf("/")>0)return a;const s=a.lastIndexOf(".");return`${a.substring(0,s<0?a.length:s)}/${a}`}async uploadS3(e,t,a,s){const n=e.find('[role="progressbar"]'),i=e.find("input"),o=e.find('[data-field="result"]');let r=1;this.updateProgress(n,i,r);const l=this.requestMultipartUpload(a,s,t);l.on("httpUploadProgress",e=>{r=Math.ceil(e.loaded/e.total*100),this.updateProgress(n,i,r)});let d=await l.promise().catch(e=>e);if(!(d instanceof Error))return d=$("<a/>").attr("href",`https://s3.console.aws.amazon.com/s3/object/${a}/${s}?region=${SolutionManifest.Region}`).attr("target","_blank").html(`s3://${a}/${s}`).prop("outerHTML"),this.showResult(n,i,o,"success",d),d;this.showResult(n,i,o,"danger",Localization.Alerts.UploadS3Error)}requestMultipartUpload(e,t,a){return S3Utils.getInstance().upload({Bucket:e,Key:t,ContentType:a.mime,Metadata:{...a.attributes,uuid:a.uuid,md5:a.checksum,webupload:(new Date).toISOString()},Body:a.file,ExpectedBucketOwner:SolutionManifest.S3.ExpectedBucketOwner},{partSize:FinalizeSlideComponent.Constants.Multipart.PartSize,queueSize:FinalizeSlideComponent.Constants.Multipart.MaxConcurrentUpload})}updateProgress(e,t,a){e.css("width",a+"%").attr("aria-valuenow",a),t.val(a+"%")}async startWorkflow(e){return ApiHelper.startWorkflow({input:{bucket:this.bucket,key:e.resolveKey(),uuid:e.uuid,group:e.group,aiOptions:e.analysis,attributes:e.attributes,destination:{bucket:SolutionManifest.Proxy.Bucket}}})}showResult(e,t,a,s,n){a.html("").append($("<span/>").addClass("text-"+s).html(n)),e.parent().addClass("collapse"),t.parent().addClass("collapse"),a.removeClass("collapse")}async startNow(){let e=0;const t=this.fileList;for(this.slide.trigger(FinalizeSlideComponent.Events.Overall.Started,[t.length]);t.length;)this.slide.trigger(FinalizeSlideComponent.Events.Overall.Progress,[e++]),await this.processFile(t.shift());const a=await this.getData();this.slide.trigger(FinalizeSlideComponent.Events.Overall.Completed,[a])}async processFile(e){return new Promise((t,a)=>{const s=`${FinalizeSlideComponent.Events.Process.Statuses.Started}:${e.fileId}`,n=`${FinalizeSlideComponent.Events.Process.Statuses.Completed}:${e.fileId}`,i=`${FinalizeSlideComponent.Events.Process.Statuses.Error}:${e.fileId}`;this.slide.on(s,async(e,t)=>{this.updateBadge(Localization.Statuses.Processing,t);this.slide.find(`a[href="#tab-${t}"]`).tab("show"),this.slide.off(s)}),this.slide.on(n,async(e,a,s)=>{this.report.push(s),this.updateBadge(Localization.Statuses.Completed,a),this.slide.off(n),t(a)}),this.slide.on(i,async(e,a,s,n)=>{this.report.push(n),this.slide.off(i),this.updateBadge(Localization.Statuses.Error,a),t(a)});const o=this.slide.find(`[data-file-id="${e.fileId}"]`),r=`${FinalizeSlideComponent.Events.Process.Uuid}:${e.fileId}`;o.trigger(r,[e])})}updateBadge(e,t){let a,s;t?(a=this.slide.find(`a[href="#tab-${t}"]`).find("[data-status]"),s=this.slide.find("#tab-"+t).find("[data-status]")):(a=this.slide.find("#"+this.ids.tablist).find("[data-status]"),s=this.slide.find("#"+this.ids.tabcontent).find("[data-status]"));const n="badge-primary badge-secondary badge-success badge-danger badge-light";switch(e){case Localization.Statuses.NotStarting:a.removeClass(n).addClass("badge-light").html(e),s.removeClass(n).addClass("badge-light").html(e);break;case Localization.Statuses.Waiting:a.removeClass(n).addClass("badge-secondary").html(e),s.removeClass(n).addClass("badge-secondary").html(e);break;case Localization.Statuses.Processing:a.removeClass(n).addClass("badge-primary").html(e),s.removeClass(n).addClass("badge-primary").html(e);break;case Localization.Statuses.Completed:a.removeClass(n).addClass("badge-success").html(e),s.removeClass(n).addClass("badge-success").html(e);break;case Localization.Statuses.Error:a.removeClass(n).addClass("badge-danger").html(e),s.removeClass(n).addClass("badge-danger").html(e)}}}class UploadTab extends(mxAlert(BaseTab)){constructor(e=!1){super(Localization.Messages.UploadTab,{selected:e}),this.$ids={...super.ids,carousel:{container:"upload-"+AppUtils.randomHexstring(),slides:{dropzone:"upload-slide-"+AppUtils.randomHexstring(),attributes:"upload-slide-"+AppUtils.randomHexstring(),analysis:"upload-slide-"+AppUtils.randomHexstring(),finalize:"upload-slide-"+AppUtils.randomHexstring()}}},this.$dropzoneComponent=new DropzoneSlideComponent,this.$attributeComponent=new AttributeSlideComponent,this.$analysisComponent=new AnalysisSlideComponent,this.$finalizeComponent=new FinalizeSlideComponent}get ids(){return this.$ids}get dropzoneComponent(){return this.$dropzoneComponent}get attributeComponent(){return this.$attributeComponent}get analysisComponent(){return this.$analysisComponent}get finalizeComponent(){return this.$finalizeComponent}async show(){if(!this.initialized){const e=$("<div/>").addClass("row no-gutters").append(await this.createCarousel());this.tabContent.append(e)}return super.show()}async hide(){return await this.clearComponentData(),super.hide()}async createCarousel(){const e=[await this.createDropzoneSlide(),await this.createAttributeSlide(),await this.createAnalysisSlide(),await this.createFinalizeSlide()],t=$("<div/>").addClass("carousel-inner");for(let a=0;a<e.length;a++){const[s,n]=e[a],i=0===a?"carousel-item active":"carousel-item";t.append($("<div/>").addClass(i).attr("id",s).append(n))}const a=$("<div/>").addClass("carousel slide").attr("data-ride",!1).attr("data-interval",!1).attr("id",this.ids.carousel.container).append(t);return $("<div/>").addClass("col-9 col-sm-9 col-md-9 mx-auto mt-4").append(a)}async createDropzoneSlide(){const e=await this.dropzoneComponent.createSlide();return e.on(DropzoneSlideComponent.Controls.StartOver,async e=>(await this.clearComponentData(),!0)),e.on(DropzoneSlideComponent.Controls.QuickUpload,async e=>(await this.dropzoneComponent.saveData(),await this.slideToFinalize(),!0)),e.on(DropzoneSlideComponent.Controls.Next,async e=>(await this.dropzoneComponent.saveData(),this.slideTo(this.attributeComponent.slideId),!0)),[this.dropzoneComponent.slideId,e]}async createAttributeSlide(){const e=await this.attributeComponent.createSlide();return e.on(AttributeSlideComponent.Controls.Back,async e=>(this.slideTo(this.dropzoneComponent.slideId),!0)),e.on(AttributeSlideComponent.Controls.QuickUpload,async e=>(await this.slideToFinalize(),!0)),e.on(AttributeSlideComponent.Controls.Next,async e=>(this.slideTo(this.analysisComponent.slideId),!0)),[this.attributeComponent.slideId,e]}async createAnalysisSlide(){const e=await this.analysisComponent.createSlide();return e.on(AnalysisSlideComponent.Controls.Back,async e=>(this.slideTo(this.attributeComponent.slideId),!0)),e.on(AnalysisSlideComponent.Controls.Next,async e=>(await this.slideToFinalize(),!0)),[this.analysisComponent.slideId,e]}async createFinalizeSlide(){const e=await this.finalizeComponent.createSlide();return e.on(FinalizeSlideComponent.Controls.Cancel,async e=>(await this.clearComponentData(),this.slideTo(this.dropzoneComponent.slideId),!0)),e.on(FinalizeSlideComponent.Controls.Done,async e=>(await this.clearComponentData(),this.slideTo(this.dropzoneComponent.slideId),!0)),[this.finalizeComponent.slideId,e]}async slideToFinalize(){const e=await this.dropzoneComponent.getData(),t=await this.attributeComponent.getData(),a=await this.analysisComponent.getData();return e.forEach(e=>{e.setAttributes(t),e.setAnalysis(a)}),this.finalizeComponent.addList(e),this.slideTo(this.finalizeComponent.slideId)}slideTo(e){const t=this.tabContent.find("#"+this.ids.carousel.container).first(),a=t.find("#"+e).index();t.carousel(a)}async showAlert(e,t){return super.showMessage(this.tabContent,"danger",Localization.Alerts.Oops,e,t)}async clearComponentData(){return Promise.all([this.dropzoneComponent.clearData(),this.attributeComponent.clearData(),this.analysisComponent.clearData(),this.finalizeComponent.clearData()])}}const ID_PROCESSINGLIST="processing-"+AppUtils.randomHexstring(),ID_ERRORLIST="error-"+AppUtils.randomHexstring(),DATA_UUID="data-uuid",INFO_BASIC="info-basic",CSS_DESCRIPTIONLIST={dl:"row lead-xs ml-2 my-auto col-9 no-gutters",dt:"col-sm-2 my-0 text-left",dd:"col-sm-10 my-0"};class ProcessingTab extends(mxSpinner(BaseTab)){constructor(e,t){super(Localization.Messages.ProcessingTab,{selected:e,fontSize:"1.1rem"},t),this.$mediaManager=MediaManager.getSingleton(),this.registerMediaManagerEvents()}get mediaManager(){return this.$mediaManager}registerMediaManagerEvents(){this.mediaManager.eventSource.on(MediaManager.Event.Media.Added,async(e,t)=>this.onMediaAdded(t)),this.mediaManager.eventSource.on(MediaManager.Event.Media.Updated,async(e,t)=>this.onMediaUpdated(t)),this.mediaManager.eventSource.on(MediaManager.Event.Media.Error,async(e,t)=>this.onMediaError(t))}async onMediaAdded(e){const t=this.tabContent.find("#"+ID_PROCESSINGLIST);let a=t.find(`li[data-uuid="${e.uuid}"]`);return 0===a.length&&(a=await this.createMediaListItem(e),t.append(a)),a}async onMediaUpdated(e){const t=this.tabContent.find("#"+ID_PROCESSINGLIST).find(`li[data-uuid="${e.uuid}"]`);if(e.overallStatus===SolutionManifest.Statuses.Completed)return t.remove();let a;return t.length>0&&(a=await this.createMediaListItem(e),t.replaceWith(a)),a}async onMediaError(e){let t=this.tabContent.find("#"+ID_PROCESSINGLIST),a=t.find(`li[data-uuid="${e.uuid}"]`);return a.remove(),t=this.tabContent.find("#"+ID_ERRORLIST),a=t.find(`li[data-uuid="${e.uuid}"]`),0===a.length&&(a=await this.createMediaListItem(e),t.append(a)),a}async show(){return this.initialized?await this.refreshContent():(this.tabContent.append(this.createSkeleton()),setTimeout(async()=>(this.loading(!0),await Promise.all([this.mediaManager.scanProcessingRecords(),this.mediaManager.scanErrorRecords()]),this.loading(!1),this.refreshContent()),10)),super.show()}createSkeleton(){const e=this.createProcessingSection(),t=this.createErrorSection();return $("<div/>").addClass("row no-gutters").append(e).append(t).append(this.createLoading())}createProcessingSection(){const e=this.createProcessingDescription(),t=this.createProcessingList(),a=this.createProcessingControls();return $("<div/>").addClass("col-12 p-0 m-0 pb-4").append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(e)).append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(t)).append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(a))}createProcessingDescription(){return $("<p/>").addClass("lead").html(Localization.Messages.ProcessingDesc)}createProcessingList(){return $("<ul/>").addClass("list-group").attr("id",ID_PROCESSINGLIST)}createProcessingControls(){const[e,t]=this.createControls();return t.off("click").on("click",()=>this.scanMoreProcessingJobs(t)),e}async scanMoreProcessingJobs(e){this.loading(!0);const t=await this.mediaManager.scanProcessingRecords();if(t){const e=this.tabContent.find("#"+ID_PROCESSINGLIST),a=(await Promise.all(t.map(e=>this.createMediaListItem(e)))).filter(e=>e);e.append(a)}this.mediaManager.noMoreProccessingJob()?e.addClass("disabled").attr("disabled","disabled").html(Localization.Messages.NoMoreData):e.removeClass("disabled").removeAttr("disabled").html(Localization.Messages.LoadMore),this.loading(!1)}createErrorSection(){const e=this.createErrorDescription(),t=this.createErrorList(),a=this.createErrorControls();return $("<div/>").addClass("col-12 p-0 m-0 pb-4 bg-light").append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(e)).append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(t)).append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(a))}createErrorDescription(){return $("<p/>").addClass("lead").html(Localization.Messages.ErrorDesc)}createErrorList(){return $("<ul/>").addClass("list-group").attr("id",ID_ERRORLIST)}createErrorControls(){const[e,t]=this.createControls();return t.off("click").on("click",()=>this.scanMoreErrorJobs(t)),e}async scanMoreErrorJobs(e){this.loading(!0);const t=await this.mediaManager.scanErrorRecords();if(t){const e=this.tabContent.find("#"+ID_ERRORLIST),a=(await Promise.all(t.map(e=>this.createMediaListItem(e)))).filter(e=>e);e.append(a)}this.mediaManager.noMoreErrorJob()?e.addClass("disabled").attr("disabled","disabled").html(Localization.Messages.NoMoreData):e.removeClass("disabled").removeAttr("disabled").html(Localization.Messages.LoadMore),this.loading(!1)}createControls(){const e=$("<button/>").addClass("btn btn-outline-dark").html(Localization.Messages.LoadMore),t=$("<form/>").addClass("form-inline").append($("<div/>").addClass("mx-auto").append(e));return t.submit(e=>e.preventDefault()),[t,e]}async refreshContent(){let e;this.loading(!0);let t=this.mediaManager.findProcessingMedias();if(t){e=this.tabContent.find("#"+ID_PROCESSINGLIST),e.children().remove();const a=(await Promise.all(t.map(e=>this.createMediaListItem(e)))).filter(e=>e);e.append(a)}if(t=this.mediaManager.findErrorMedias(),t){e=this.tabContent.find("#"+ID_ERRORLIST),e.children().remove();const a=(await Promise.all(t.map(e=>this.createMediaListItem(e)))).filter(e=>e);e.append(a)}this.loading(!1)}async createMediaListItem(e){const t=await this.createThumbnail(e),a=new DescriptionList(CSS_DESCRIPTIONLIST),s=a.createTableList();let n;switch(["basename","timestamp","status"].forEach(t=>a.appendTableList(s,e,t)),e.overallStatus){case SolutionManifest.Statuses.Error:n="bg-danger";break;case SolutionManifest.Statuses.Processing:n="bg-primary";break;default:n="bg-success"}const i=$("<span/>").addClass("lead-xxs mx-auto my-auto text-white").html(e.overallStatus),o=$("<div/>").addClass("row no-gutters").attr("data-type",INFO_BASIC).append($("<div/>").addClass("col-2").append(t)).append($("<div/>").addClass("col-1 d-flex").addClass(n).append(i)).append($("<div/>").addClass("col-9 d-flex").append(s)),r=$("<li/>").addClass("list-group-item list-group-item-action no-gutters p-0").css("cursor","pointer").attr(DATA_UUID,e.uuid).attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",Localization.Tooltips.ViewJobOnAWSConsole).append(o).tooltip({trigger:"hover"});return r.off("click").on("click",()=>{const t=AWSConsoleStepFunctions.getExecutionLink(e.executionArn);return window.open(t,"_blank"),!1}),r}async createThumbnail(e){const t=await e.getThumbnail();return $("<img/>").addClass("btn-bkgd w-100 h-96px").attr("src",t).css("object-fit","cover")}}class PieGraph extends(mxReadable(class{})){constructor(e,t,a){super(),this.$graphContainer=$("<div/>").addClass("pie-graph mx-auto").attr("id","pie-"+AppUtils.randomHexstring()),this.$dataset=t.sort((e,t)=>e.value-t.value);const s=this.makeGraphOptions(e,this.$dataset,a),n=echarts.init(this.$graphContainer[0]),i=this.onRenderedEvent.bind(this,n);n.on("rendered",async()=>i()),n.setOption(s),this.$graph=n}get graphContainer(){return this.$graphContainer}set graphContainer(e){this.$graphContainer=e}get graph(){return this.$graph}set graph(e){this.$graph=e}get datasets(){return this.$datasets}set datasets(e){this.$datasets=e}get graphId(){return this.graphContainer.prop("id")}getGraphContainer(){return this.graphContainer}makeGraphOptions(e,t,a={}){return{title:{text:e,left:"center",top:20,textStyle:{fontSize:16,fontWeight:200}},tooltip:{trigger:"item",formatter:a.formatter||"{b} : {c} files ({d}%)"},series:[{type:"pie",radius:"60%",center:["50%","50%"],data:t,roseType:"radius",label:{fontSize:12},labelLine:{smooth:.2,length:15,length2:15},itemStyle:{shadowBlur:20,shadowColor:"rgba(91, 12, 10, 0.5)"},animationType:"scale",animationEasing:"elasticOut",animationDelay:()=>{const e=new Uint32Array(1);return(window.crypto||window.msCrypto).getRandomValues(e),e[0]%200+1}}]}}destroy(){this.graph&&this.graph.dispose(),this.graph=void 0,this.graphContainer&&this.graphContainer.remove(),this.graphContainer=void 0,this.datasets&&(this.datasets.length=0)}onRenderedEvent(e){e.getWidth()<=0||e.getHeight()<=0?setTimeout(()=>e.resize(),200):e.off("rendered")}resize(){return this.graph.resize()}}const ID_OVERALLGRAPH="pie-"+AppUtils.randomHexstring(),ID_AGGREGATIONGRAPH="aggs-"+AppUtils.randomHexstring(),MOST_RECENT_ITEMS=20,AGGREGATED_KNOWN_FACE_SIZE=20,AGGREGATED_LABEL_SIZE=20,AGGREGATED_MODERATION_SIZE=20,AGGREGATED_KEYPHRASE_SIZE=20,AGGREGATED_ENTITY_SIZE=20,AGGS_TYPE_KNOWNFACES="knownFaces",AGGS_TYPE_LABELS="labels",AGGS_TYPE_MODERATIONS="moderations",AGGS_TYPE_KEYPHRASES="keyphrases",AGGS_TYPE_ENTITIES="entities";class StatsTab extends(mxSpinner(BaseTab)){constructor(e=!1){super(Localization.Messages.StatsTab,{selected:e}),this.$pieGraphs={overall:{totalCount:void 0,totalSize:void 0,status:void 0,recents:void 0},aggs:{knownFaces:void 0,labels:void 0,moderations:void 0,keyphrases:void 0,entities:void 0}}}get overallCountGraph(){return this.$pieGraphs.overall.totalCount}set overallCountGraph(e){this.$pieGraphs.overall.totalCount=e}get overallSizeGraph(){return this.$pieGraphs.overall.totalSize}set overallSizeGraph(e){this.$pieGraphs.overall.totalSize=e}get overallStatusGraph(){return this.$pieGraphs.overall.status}set overallStatusGraph(e){this.$pieGraphs.overall.status=e}get mostRecentGraph(){return this.$pieGraphs.overall.recents}set mostRecentGraph(e){this.$pieGraphs.overall.recents=e}get aggsGraphs(){return this.$pieGraphs.aggs}get knownFacesGraph(){return this.$pieGraphs.aggs.knownFaces}set knownFacesGraph(e){this.$pieGraphs.aggs.knownFaces=e}get labelsGraph(){return this.$pieGraphs.aggs.labels}set labelsGraph(e){this.$pieGraphs.aggs.labels=e}get moderationsGraph(){return this.$pieGraphs.aggs.moderations}set moderationsGraph(e){this.$pieGraphs.aggs.moderations=e}get keyphrasesGraph(){return this.$pieGraphs.aggs.keyphrases}set keyphrasesGraph(e){this.$pieGraphs.aggs.keyphrases=e}get entitiesGraph(){return this.$pieGraphs.aggs.entities}set entitiesGraph(e){this.$pieGraphs.aggs.entities=e}async show(){return this.initialized?await this.refreshContent():(this.tabContent.append(this.createSkeleton()),this.delayContentLoad()),super.show()}createSkeleton(){const e=this.createDescription(),t=this.createOverallStatus(),a=this.createAggregations(),s=this.createControls();return $("<div/>").addClass("row no-gutters").append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(e)).append($("<div/>").addClass("col-9 p-0 mx-auto").append(t)).append($("<div/>").addClass("col-12 p-0 m-0 p-0 bg-light").append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(a))).append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(s)).append(this.createLoading())}createDescription(){return $("<p/>").addClass("lead").html(Localization.Messages.StatsDesc)}createOverallStatus(){const e=$("<span/>").addClass("d-block p-0 lead").html(Localization.Messages.OverallStats),t=$("<div/>").addClass("row no-gutters").attr("id",ID_OVERALLGRAPH);return $("<div/>").addClass("col-12 p-0 m-0").append(e).append(t)}createAggregations(){const e=$("<span/>").addClass("d-block p-0 lead").html(Localization.Messages.Aggregations),t=$("<div/>").addClass("row no-gutters").attr("id",ID_AGGREGATIONGRAPH);return $("<div/>").addClass("col-12 p-0 m-0 mb-4").append(e).append(t)}createControls(){const e=$("<button/>").addClass("btn btn-success").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",Localization.Tooltips.RefreshStats).html(Localization.Buttons.Refresh).tooltip({trigger:"hover"});e.off("click").on("click",()=>this.refreshContent());const t=$("<form/>").addClass("form-inline").append($("<div/>").addClass("mx-auto").append(e));return t.submit(e=>e.preventDefault()),t}delayContentLoad(){return setTimeout(async()=>{this.loading(!0),await this.refreshContent(),this.loading(!1)})}async refreshContent(){const e=await ApiHelper.getStats({size:20}),[t,a,s,n,i]=await Promise.all([this.aggregateKnownFaces(),this.aggregateLabels(),this.aggregateModerations(),this.aggregateKeyphrases(),this.aggregateEntities()]);await this.refreshOverallStats(e),await this.refreshAggregations({knownFaces:t.aggregations,labels:a.aggregations,moderations:s.aggregations,keyphrases:n.aggregations,entities:i.aggregations})}async aggregateKnownFaces(){return ApiHelper.getStats({size:20,aggregate:[AnalysisTypes.Rekognition.Celeb,AnalysisTypes.Rekognition.FaceMatch].join(",")})}async aggregateLabels(){return ApiHelper.getStats({size:20,aggregate:[AnalysisTypes.Rekognition.Label,AnalysisTypes.Rekognition.CustomLabel].join(",")})}async aggregateModerations(){return ApiHelper.getStats({size:20,aggregate:[AnalysisTypes.Rekognition.Moderation].join(",")})}async aggregateKeyphrases(){return ApiHelper.getStats({size:20,aggregate:[AnalysisTypes.Comprehend.Keyphrase].join(",")})}async aggregateEntities(){return ApiHelper.getStats({size:20,aggregate:[AnalysisTypes.Comprehend.Entity,AnalysisTypes.Comprehend.CustomEntity].join(",")})}async refreshOverallStats(e){const t=this.tabContent.find("#"+ID_OVERALLGRAPH);return t.children().remove(),e.stats.types?t.append(await this.refreshOverallCountStats(e.stats.types)).append(await this.refreshOverallSizeStats(e.stats.types)).append(await this.refreshOverallStatusStats(e.stats.overallStatuses)).append(await this.refreshMostRecentStats(e.recents)):t.append($("<p/>").addClass("text-center text-muted").append(Localization.Messages.NoData))}async refreshOverallCountStats(e){this.overallCountGraph&&this.overallCountGraph.destroy();const t=e.reduce((e,t)=>e.concat({name:t.type,value:t.count}),[]),a=t.reduce((e,t)=>e+t.value,0),s=`${Localization.Messages.TotalCount} (${a} files)`,n=new PieGraph(s,t,{formatter:"<strong>{b}</strong>: {c} files ({d}%)"});return this.overallCountGraph=n,$("<div/>").addClass("col-6 m-0 p-0").append(n.getGraphContainer())}async refreshOverallSizeStats(e){this.overallSizeGraph&&this.overallSizeGraph.destroy();const t=e.reduce((e,t)=>e.concat({name:t.type,value:t.fileSize.total}),[]),a=t.reduce((e,t)=>e+t.value,0),s=`${Localization.Messages.TotalSize} (${AppUtils.readableFileSize(a)})`,n=new PieGraph(s,t,{formatter:e=>`<strong>${e.data.name}:</strong> ${AppUtils.readableFileSize(e.data.value)}`});return this.overallSizeGraph=n,$("<div/>").addClass("col-6 m-0 p-0").append(n.getGraphContainer())}async refreshOverallStatusStats(e){this.overallStatusGraph&&this.overallStatusGraph.destroy();const t=e.reduce((e,t)=>e.concat({name:t.overallStatus,value:t.count}),[]),a=t.reduce((e,t)=>e+t.value,0),s=`${Localization.Messages.WorkflowStatuses} (${a} processes)`,n=new PieGraph(s,t,{formatter:"<strong>{b}</strong>: {c} counts ({d}%)"});return this.overallStatusGraph=n,$("<div/>").addClass("col-6 m-0 p-0").append(n.getGraphContainer())}async refreshMostRecentStats(e){if(this.mostRecentGraph&&this.mostRecentGraph.destroy(),!e||!e.length)return;const t=e.map(e=>({...e,name:e.basename,value:e.fileSize})),a=`${Localization.Messages.MostRecentStats} (${e.length})`,s=new PieGraph(a,t,{formatter:e=>["<strong>name:</strong> "+e.data.basename,"<strong>uuid:</strong>: "+e.data.uuid,"<strong>duration:</strong>: "+AppUtils.readableDuration(e.data.duration),"<strong>filesize:</strong>: "+AppUtils.readableFileSize(e.data.fileSize),"<strong>lastmodified:</strong>: "+AppUtils.isoDateTime(e.data.lastModified),"<strong>type:</strong>: "+e.data.type].join("<br/>")});return this.mostRecentGraph=s,$("<div/>").addClass("col-6 m-0 p-0").append(s.getGraphContainer())}async refreshAggregations(e){const t=this.tabContent.find("#"+ID_AGGREGATIONGRAPH);if(t.children().remove(),!e)return t.append($("<p/>").addClass("text-center text-muted").append(Localization.Messages.NoData));const a=await Promise.all(Object.keys(e).map(t=>this.refreshAggregateByType(e[t],t)));return t.append(a)}async refreshAggregateByType(e,t){this.aggsGraphs[t]&&this.aggsGraphs[t].destroy();const a=e.reduce((e,t)=>e.concat({name:t.name,value:t.count}),[]);let s;switch(t){case"knownFaces":s=Localization.Messages.TopKnownFaces;break;case"labels":s=Localization.Messages.TopLabels;break;case"moderations":s=Localization.Messages.TopModerations;break;case"keyphrases":s=Localization.Messages.TopKeyphrases;break;case"entities":s=Localization.Messages.TopEntities;break;default:s=void 0}const n=new PieGraph(s,a,{formatter:"<strong>{b}</strong>: {c} documents"});return this.aggsGraphs[t]=n,$("<div/>").addClass("col-6 m-0 p-0").append(n.getGraphContainer())}}const ID_FACECOLLECTION_CONTAINER="faceCollectionContainer-"+AppUtils.randomHexstring(),ID_INDEXED_FACE_CONTAINER="indexedFaceContainer-"+AppUtils.randomHexstring();class FaceCollectionTab extends(mxAlert(mxSpinner(BaseTab))){constructor(e=!1){super(Localization.Messages.FaceCollectionTab,{selected:e}),this.$faceManager=FaceManager.getSingleton()}get faceManager(){return this.$faceManager}async show(){if(!this.initialized){const e=await this.createContent();this.tabContent.append(e)}return super.show()}async createContent(){const e=this.createDescription(),t=await this.createCollectionList(),a=this.createLoading();return $("<div/>").addClass("row no-gutters").append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(e)).append($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(t)).append($("<div/>").addClass("col-12 p-0 m-0 p-0 bg-light").append($("<div/>").addClass("col-9 p-0 mx-auto mt-4 collapse").attr("id",ID_INDEXED_FACE_CONTAINER))).append(a)}createDescription(){return $("<p/>").addClass("lead").html(Localization.Messages.FaceCollectionDesc)}async createCollectionList(){const e=await this.faceManager.getCollections(),t=$("<span/>").addClass("d-block p-0 lead").html(Localization.Messages.AvailableFaceCollections),a=$("<form/>").addClass("form-inline needs-validation my-4").attr("novalidate","novalidate");a.submit(e=>e.preventDefault());const s=$("<select/>").addClass("custom-select custom-select-sm col-3").attr("id",ID_FACECOLLECTION_CONTAINER).append($("<option/>").attr("value","undefined").html(Localization.Messages.SelectFaceCollection));s.off("change").on("change",async()=>{const e=this.tabContent.find("#"+ID_INDEXED_FACE_CONTAINER),t=s.val();return"undefined"===t?e.addClass("collapse"):this.renderIndexedFaces(t,e)});const n=(e||[]).map(e=>$("<option/>").attr("value",e.name).html(`${e.name} (${e.faces} faces)`));s.append(n),a.append(s);const i=$("<button/>").addClass("btn btn-sm btn-outline-dark").append($("<i/>").addClass("fas fa-sync-alt"));i.off("click").on("click",async()=>(await this.refreshCollectionList(s),!1)),a.append(i);const o=$("<span/>").addClass("lead ml-4 mr-1").html(Localization.Messages.Alternatively),r=$("<input/>").addClass("form-control form-control-sm col-3").attr("pattern","^[a-zA-Z0-9_.-]{0,255}$").attr("placeholder","(Blank)"),l=$("<button/>").addClass("btn btn-sm btn-success").append(Localization.Buttons.CreateNewCollection);return l.off("click").on("click",async e=>{if(!this.validateForm(e,a))return this.shake(a),await this.showAlert(Localization.Alerts.InvalidFaceCollectionName),r.focus(),!1;if(!r.val())return!1;this.loading(!0);const t=await this.faceManager.createCollection(r.val());if(t){const e=$("<option/>").attr("value",t.name).html(`${t.name} (${t.faces} faces)`);s.append(e),s.val(t.name).trigger("change")}return r.val(""),this.loading(!1),!0}),a.append(o).append(r).append(l),$("<div/>").addClass("col-12 p-0 m-0").append(t).append(a)}validateForm(e,t){return e.preventDefault(),!1!==t[0].checkValidity()||(e.stopPropagation(),!1)}async renderIndexedFaces(e,t){this.loading(!0),t.children().remove();const a=await this.faceManager.getFacesInCollection(e),s=$("<div/>").addClass("row no-gutters"),n=Localization.Messages.IndexedFacesInCollection.replace("{{FACE_COLLECTION}}",e);s.append($("<div/>").addClass("col-6 p-0 m-0").append($("<span/>").addClass("d-block p-0 lead").html(n)));const i=this.makeFaceCollectionDeleteBtn(e);s.append($("<div/>").addClass("col-6 p-0 m-0 text-left").append(i.addClass("float-right"))),t.append(s);const o=$("<table/>").addClass("table table-hover my-4 lead-xs"),r=this.makeFaceTableHeaderRow();o.append($("<thead/>").append(r));const l=await Promise.all(a.faces.map(t=>this.makeFaceTableRow(e,t)));o.append($("<tbody/>").append(l)),t.append(o);const d=this.makeLoadMoreBtn(o,e,a.token);t.append(d),t.removeClass("collapse"),this.loading(!1)}makeFaceTableHeaderRow(){const e=["#","ExternalImageId","FriendlyName","FaceId","Remove?"].map(e=>$("<th/>").addClass("align-middle text-center lead-sm").attr("scope","col").append(e));return $("<tr/>").append(e)}async makeFaceTableRow(e,t){const a=$("<tr/>"),s=await this.makeFaceTableRowImage(t.key),n=this.makeFaceTableRowItem(AppUtils.toFriendlyName(t.externalImageId)),i=this.makeFaceTableRowItem(t.faceId),o=this.makeFaceTableRowItem(t.externalImageId),r=this.makeFaceTableRowDeleteBtn(e,t.faceId);return a.append(s).append(o).append(n).append(i).append(r)}async makeFaceTableRowImage(e){const t=await this.faceManager.getFaceImage(e),a=t?$("<img/>").addClass("face-thumbnail").attr("src",t):$("<div/>").addClass("face-thumbnail").append($("<i/>").addClass("fas fa-eye-slash text-white"));return $("<td/>").addClass("h-100 align-middle text-center").addClass("m-0 p-0").append(a)}makeFaceTableRowItem(e){return $("<td/>").addClass("h-100 align-middle text-center").append(e)}makeFaceCollectionDeleteBtn(e){const t=$("<button/>").addClass("btn btn-sm btn-danger").attr("type","button").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",Localization.Tooltips.RemoveFaceCollection).html(Localization.Buttons.RemoveFaceCollection).tooltip({trigger:"hover"});return t.off("click").on("click",async()=>{this.loading(!0),t.tooltip("hide").addClass("disabled").attr("disabled","disabled"),await this.faceManager.deleteCollection(e);const a=this.tabContent.find("select#"+ID_FACECOLLECTION_CONTAINER);a.val("undefined").trigger("change"),a.find(`option[value="${e}"]`).remove(),this.loading(!1)}),t}makeFaceTableRowDeleteBtn(e,t){const a=$("<button/>").addClass("btn btn-sm btn-outline-danger").attr("type","button").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",Localization.Tooltips.RemoveFaceFromCollection).append($("<i/>").addClass("far fa-trash-alt")).tooltip({trigger:"hover"});return a.off("click").on("click",async()=>{this.loading(!0),a.tooltip("hide").addClass("disabled").attr("disabled","disabled"),await this.faceManager.deleteFace(e,t);a.parents("tr").remove(),this.loading(!1)}),$("<td/>").addClass("h-100 align-middle text-center").append(a)}makeLoadMoreBtn(e,t,a){const s=$("<button/>").addClass("btn btn-sm btn-outline-dark").html(Localization.Messages.LoadMore);s.data("token",a),a||s.addClass("disabled").attr("disabled","disabled").html(Localization.Messages.NoMoreData),s.off("click").on("click",async()=>{const a=s.data("token"),n=await this.faceManager.getFacesInCollection(t,a),i=e.find("tbody"),o=await Promise.all(n.faces.map(e=>this.makeFaceTableRow(t,e)));i.append(o),s.data("token",n.token),n.token||s.addClass("disabled").attr("disabled","disabled").html(Localization.Messages.NoMoreData)});return $("<div/>").addClass("col-12 text-center mb-4").append(s)}async refreshCollectionList(e){this.loading(!0),e.val("undefined").trigger("change"),e.find('option[value!="undefined"]').remove();const t=(await this.faceManager.refreshCollections()||[]).map(e=>$("<option/>").attr("value",e.name).html(`${e.name} (${e.faces} faces)`));e.append(t),this.loading(!1)}async showAlert(e,t){return super.showMessage(this.tabContent,"danger",Localization.Alerts.Oops,e,t)}}class SettingsTab extends(mxAnalysisSettings(BaseTab)){constructor(e=!1){super(Localization.Messages.SettingsTab,{selected:e})}get parentContainer(){return this.tabContent}createSkeleton(){const e=super.createSkeleton(),t=this.createDatastoreForm();return e.children().first().after($("<div/>").addClass("col-9 p-0 mx-auto mt-4").append(t)),e}createDatastoreForm(){const e=$("<span/>").addClass("d-block p-2 bg-light text-black lead").html(Localization.Messages.DatastoreFeature),t=$("<p/>").addClass("lead-s mt-4").html(Localization.Messages.DatastoreFeatureDesc),a=$("<form/>").addClass("col-9 px-0 form-inline mt-4").attr("role","form"),s=$("<button/>").addClass("btn btn-sm btn-outline-danger").attr("type","button").attr("data-toggle","button").attr("aria-pressed","false").attr("autocomplete","off").append(Localization.Buttons.CleanupDatastore);return s.off("click").on("click",async e=>{this.loading(!0),e.preventDefault(),e.stopPropagation();const t=LocalStoreDB.getSingleton();return await t.clearAllStores(),this.loading(!1),!1}),a.append(s),a.submit(e=>e.preventDefault()),$("<div/>").addClass("ai-group").addClass("overflow-auto my-auto align-content-start").append($("<div/>").addClass("mt-4").append(e).append(t).append(a))}}const TITLE=Localization.Messages.UserManagementTab,DESCRIPTION=Localization.Messages.UserManagementDesc,USERNAME=Localization.Messages.Username,TABLE_HEADER=[USERNAME,Localization.Messages.Email,Localization.Messages.Group,Localization.Messages.Status,Localization.Messages.LastModified,Localization.Messages.RemoveUser],PERMISSION_VIEWER=Localization.Messages.PermissionViewer,PERMISSION_CREATOR=Localization.Messages.PermissionCreator,PERMISSION_ADMIN=Localization.Messages.PermissionAdmin,TOOLTIP_REMOVE_USER=Localization.Tooltips.RemoveUserFromCognito,TOOLTIP_REFRESH_USER_TABLE=Localization.Tooltips.RefreshUserTable,LIST_OF_CURRENT_USERS=Localization.Messages.CurrentUsers,CREATE_NEW_USERS=Localization.Messages.CreateNewUsers,CREATE_NEW_USERS_DESC=Localization.Messages.CreateNewUsersDesc,BTN_ADD_EMAIL=Localization.Buttons.AddEmail,BTN_CONFIRM_AND_ADD=Localization.Buttons.ConfirmAndAddUsers,BTN_REFRESH=Localization.Buttons.Refresh,OOPS=Localization.Alerts.Oops,ERR_INVALID_EMAIL_ADDRESS=Localization.Alerts.InvalidEmailAddress,ERR_INVALID_USERNAME=Localization.Alerts.UsernameConformance,ERR_NO_USER_TO_ADD=Localization.Alerts.NoNewUsers,ERR_FAIL_ADDIND_USERS=Localization.Alerts.FailAddingUsers;class UserManagementTab extends(mxAlert(mxSpinner(BaseTab))){constructor(e=!1){super(TITLE,{selected:e}),this.$uid=AppUtils.randomHexstring()}get uid(){return this.$uid}async show(){if(!this.initialized){const e=await this.createContent();this.tabContent.append(e)}return super.show()}async createContent(){const e=$("<div/>").addClass("row no-gutters"),t=this.createDescriptionSection();e.append(t);const a=await this.createUserTableSection();e.append(a);const s=this.createAddUsersSection();e.append(s);const n=this.createLoading();return e.append(n),e}createDescriptionSection(){const e=$("<div/>").addClass("col-9 p-0 mx-auto mt-4"),t=AWSConsoleCongito.getUserPoolLink(SolutionManifest.Cognito.UserPoolId);let a=DESCRIPTION.replace("{{CONSOLE_USERPOOL}}",t);return a=$("<p/>").addClass("lead").html(a),e.append(a),e}async createUserTableSection(){const e=ApiHelper.getUsers(),t=$("<div/>").addClass("col-9 p-0 mx-auto mt-4 vh-30"),a=$("<div/>").addClass("col-12 p-0 mb-4 d-flex justify-content-between");t.append(a);const s=$("<span/>").addClass("lead").append(LIST_OF_CURRENT_USERS);a.append(s);const n=$("<button/>").addClass("btn btn-sm btn-outline-dark").attr("type","button").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",TOOLTIP_REFRESH_USER_TABLE).html(BTN_REFRESH).tooltip({trigger:"hover"});n.on("click",async()=>{this.loading(!0),await this.refreshUserTable(),this.loading(!1)}),a.append(n);const i=$("<table/>").attr("id","table-"+this.uid).addClass("table table-sm lead-xs no-border");t.append(i);const o=$("<tbody/>");i.append(o);const r=this.makeTableHeaderRow();o.append(r);const l=(await e).map(e=>this.makeTableRowItem(e));return o.append(l),t}makeTableHeaderRow(){const e=$("<tr/>"),t=TABLE_HEADER.map(e=>$("<th/>").addClass("align-middle text-center lead-sm").attr("scope","col").append(e));return e.append(t),e}makeTableRowItem(e){const t=$("<tr/>").attr("data-username",e.username);let a;switch(e.group){case SolutionManifest.Cognito.Group.Admin:a=PERMISSION_ADMIN;break;case SolutionManifest.Cognito.Group.Creator:a=PERMISSION_CREATOR;break;default:a=PERMISSION_VIEWER}a=`${e.group}<br/>(${a})`;const s=$("<button/>").addClass("btn btn-sm btn-outline-danger").attr("type","button").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",TOOLTIP_REMOVE_USER).append($("<i/>").addClass("far fa-trash-alt")).tooltip({trigger:"hover"});s.off("click").on("click",async()=>{this.loading(!0),s.tooltip("hide").addClass("disabled").attr("disabled","disabled"),await this.onRemoveUser(e.username),t.remove(),this.loading(!1)});const n=[e.username,e.email,a,e.status,new Date(e.lastModified).toISOString(),s].map(e=>$("<td/>").addClass("h-100 align-middle text-center col-2").append(e||"--"));return t.append(n),t}createAddUsersSection(){const e=$("<div/>").addClass("col-12 p-0 m-0 bg-light"),t=$("<div/>").addClass("col-9 p-0 mx-auto mt-4");e.append(t);const a=$("<span/>").addClass("d-block p-0 lead mb-4").append(CREATE_NEW_USERS);t.append(a);let s=CREATE_NEW_USERS_DESC.replace("{{ADD_EMAIL}}",BTN_ADD_EMAIL).replace("{{CONFIRM_AND_ADD}}",BTN_CONFIRM_AND_ADD);s=$("<p/>").addClass("lead-s").append(s),t.append(s);const n=this.createAddUserControls();return t.append(n),e}createAddUserControls(){const e="form-"+this.uid,t=$("<form/>").addClass("col-9 px-0 needs-validation").attr("id",e).attr("novalidate","novalidate"),a=$("<div/>").addClass("form-group mt-2");t.append(a);const s=$("<button/>").addClass("btn btn-primary btn-sm mb-2 mr-1").attr("type","button").html(BTN_ADD_EMAIL);a.append(s);const n=$("<button/>").addClass("btn btn-success btn-sm mb-2 mr-1").attr("type","button").html(BTN_CONFIRM_AND_ADD);return a.append(n),s.on("click",async e=>(e.preventDefault(),a.before(this.createEmailField()),!0)),n.on("click",async e=>{e.preventDefault();let s=[];const n=t.children(".input-group");return n.each((e,t)=>{const a=$(t).find('[data-attr-type="email"]').val(),n=$(t).find("select").val();let i=$(t).find('input[type="text"]').val();void 0!==i&&0!==i.length||(i=void 0),a&&n&&s.push({email:a,group:n,username:i})}),s.length?(this.loading(!0),s=await this.onAddNewUsers(s),this.loading(!1),n.children().remove()):(this.shake(a),this.showAlert(ERR_NO_USER_TO_ADD))}),t}async refreshUserTable(e){const t=void 0!==e?e.slice(0):await ApiHelper.getUsers(),a=this.tabContent.find("table#table-"+this.uid).find("tbody");a.children("[data-username]").each((e,a)=>{const s=$(a).data("username"),n=t.findIndex(e=>e.username===s);if(n>=0){const e=t.splice(n,1)[0],s=this.makeTableRowItem(e);$(a).replaceWith(s)}});const s=t.map(e=>this.makeTableRowItem(e));a.append(s)}createEmailField(){const e=$("<div/>").addClass("input-group mb-2 mr-sm-2"),t=$("<input/>").addClass("form-control col-3").attr("data-attr-type","email").attr("type","email").attr("required","required").attr("placeholder","(Email)");e.append(t);const a=$("<select/>").addClass("custom-select col-2").attr("id","select-"+this.uid);e.append(a);const s=Object.values(SolutionManifest.Cognito.Group).map(e=>$("<option/>").attr("value",e).html(e));s[0].attr("selected","selected"),a.append(s);const n=$("<input/>").addClass("form-control col-3").attr("type","text").attr("pattern","[a-zA-Z0-9._%+-]{1,128}").attr("placeholder",`(${USERNAME})`);e.append(n);const i=$("<button/>").addClass("btn btn-secondary ml-1").append($("<i/>").addClass("far fa-times-circle"));return e.append(i),i.on("click",t=>{t.preventDefault(),e.remove()}),[[t,ERR_INVALID_EMAIL_ADDRESS],[n,ERR_INVALID_USERNAME]].forEach(t=>{t[0].focusout(async a=>{const s=e.parent("form").first();return!(!this.validateForm(a,s)&&!t[0].get(0).validity.valid)||(this.shake(e),await this.showAlert(t[1]),t[0].focus(),!1)}),t[0].keypress(async a=>{if(13===a.which){const s=e.parent("form").first();if(!this.validateForm(a,s)&&!t[0].get(0).validity.valid)return this.shake(e),await this.showAlert(t[1]),t[0].focus(),!1}return!0})}),e}validateForm(e,t){return e.preventDefault(),!1!==t[0].checkValidity()||(e.stopPropagation(),!1)}async showAlert(e,t){return super.showMessage(this.tabContent,"danger",OOPS,e,t)}async onRemoveUser(e){return ApiHelper.deleteUser(e)}async onAddNewUsers(e){const t=await ApiHelper.addUsers(e),a=t.filter(e=>void 0===e.error);await this.refreshUserTable(a);const s=t.filter(e=>void 0!==e.error);if(s.length>0){console.error(s);const e=s.map(e=>`<strong>${e.email}</strong>`).join(", "),t=ERR_FAIL_ADDIND_USERS.replace("{{USERS}}",e);await this.showAlert(t)}return a}}const ID_MAIN_CONTAINER="main-"+AppUtils.randomHexstring(),ID_MAIN_TOASTLIST="main-"+AppUtils.randomHexstring(),ID_MAIN_TABLIST="main-"+AppUtils.randomHexstring(),ID_MAIN_TABCONTENT="main-"+AppUtils.randomHexstring(),SOLUTION_URL="https://aws.amazon.com/solutions/media2cloud/",SOLUTION_ICON$1="/images/m2c-short-white.png";class MainView{constructor(){this.$view=$("<div/>").attr("id",ID_MAIN_CONTAINER),this.$cognito=CognitoConnector.getSingleton(),this.$tabControllers=this.initTabControllersByGroup()}get view(){return this.$view}get cognito(){return this.$cognito}get tabControllers(){return this.$tabControllers}initTabControllersByGroup(){const e={};return this.cognito.canRead()&&(e.collection=new CollectionTab(!0),e.processing=new ProcessingTab,e.stats=new StatsTab),this.cognito.canWrite()&&(e.upload=new UploadTab,e.faceCollection=new FaceCollectionTab,e.settings=new SettingsTab),this.cognito.canModify()&&(e.userManagement=new UserManagementTab),[e.collection,e.upload,e.processing,e.stats,e.faceCollection,e.settings,e.userManagement].filter(e=>void 0!==e)}appendTo(e){return e.append(this.view)}async show(){await this.hide();const e=$("<nav/>").addClass("navbar navbar-expand-lg navbar-dark bg-dark").append(this.createLogo()).append(this.createNavToggle()).append(this.createTabItems()).append(this.createLogoutIcon());return this.view.append(e),this.view.append(this.createTabContents()),this.view.append(this.createPadding()),this.view.append(this.createToastLayer()),this.tabControllers[0].show()}async hide(){return Promise.all(this.tabControllers.map(e=>e.hide()))}createLogo(){const e=$("<a/>").addClass("navbar-brand").attr("href",SOLUTION_URL).attr("target","_blank").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",Localization.Tooltips.VisitSolutionPage).css("font-size","1rem");return e.tooltip(),e.append($("<img/>").addClass("d-inline-block align-top").attr("src",SOLUTION_ICON$1).attr("height",48).attr("alt",Localization.Messages.SolutionName))}createNavToggle(){const e=ID_MAIN_TABLIST;return $("<button/>").addClass("navbar-toggler").attr("type","button").attr("data-toggle","collapse").attr("data-target","#"+e).attr("aria-controls",e).attr("aria-expanded","false").attr("aria-label","Toggle navigation").append($("<span/>").addClass("navbar-toggler-icon"))}createTabItems(){const e=ID_MAIN_TABLIST,t=$("<div/>").addClass("navbar-nav").attr("role","tablist");return this.tabControllers.forEach(e=>t.append(e.tabLink)),$("<div/>").addClass("collapse navbar-collapse").attr("id",e).append(t)}createLogoutIcon(){const e=$("<button/>").addClass("btn btn-sm btn-link text-white").attr("type","button").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title",`${this.cognito.user.username}, ${Localization.Tooltips.Logout}`).css("font-size","1rem").html($("<i/>").addClass("fas fa-user-circle").css("font-size","2rem"));return e.tooltip(),e.off("click").click(()=>(this.cognito.signOut(),window.location.reload())),e}createTabContents(){const e=$("<div/>").addClass("tab-content").attr("id",ID_MAIN_TABCONTENT);return this.tabControllers.forEach(t=>e.append(t.tabContent)),e}createPadding(){return $("<div/>").addClass("row no-gutters").css("height",100).append($("<div/>").addClass("col-12 lead-sm d-flex justify-content-center align-self-center").append($("<span/>").addClass("lead-sm mr-2").append(`Version ${SolutionManifest.Version} (${SolutionManifest.LastUpdated})`)))}createToastLayer(e=ID_MAIN_TOASTLIST){return $("<div/>").addClass("position-absolute w-100 d-flex flex-column").css("z-index",1e3).css("margin-left","60%").attr("id",e)}}const SOLUTION_ICON="/images/m2c-full-black.png";class SignInFlow{constructor(){this.$ids={container:"signin-"+AppUtils.randomHexstring(),carousel:"signin-"+AppUtils.randomHexstring(),slides:{signIn:"signin-slide-"+AppUtils.randomHexstring(),newPassword:"signin-slide-"+AppUtils.randomHexstring(),resetSendCode:"signin-slide-"+AppUtils.randomHexstring(),resetPassword:"signin-slide-"+AppUtils.randomHexstring()},normal:{username:"signin-normal-"+AppUtils.randomHexstring(),password:"signin-normal-"+AppUtils.randomHexstring()},new:{password01:"signin-new-"+AppUtils.randomHexstring(),password02:"signin-new-"+AppUtils.randomHexstring()},reset:{code:"signin-new-"+AppUtils.randomHexstring(),email:"signin-new-"+AppUtils.randomHexstring(),username:"signin-new-"+AppUtils.randomHexstring(),password:"signin-new-"+AppUtils.randomHexstring()}},this.$view=$("<div/>").attr("id",this.$ids.container),this.$cognito=CognitoConnector.getSingleton(),this.$dialog=void 0}static get Events(){return{View:{Hidden:"signin:view:hidden"}}}get ids(){return this.$ids}appendTo(e){return e.append(this.view)}get view(){return this.$view}get dialog(){return this.$dialog}set dialog(e){this.$dialog=e}get cognito(){return this.$cognito}async show(){await this.hide();const e=await this.userSignIn().catch(()=>{});this.dialog=$("<div/>").addClass("modal fade").attr("tabindex",-1).attr("role","dialog");const t=$("<div/>").addClass("modal-dialog").attr("role","document").append($("<div/>").addClass("modal-content").append($("<div/>").addClass("modal-header").append($("<h5/>").addClass("modal-title lead").html(Localization.Messages.Title))).append($("<div/>").addClass("modal-body").append(this.createCarousel(e))).append($("<div/>").addClass("modal-footer").append(this.createCopyright())));return this.dialog.append(t),this.view.append(this.dialog),this.dialog.off("hidden.bs.modal").on("hidden.bs.modal",()=>this.view.trigger(SignInFlow.Events.View.Hidden)),e?this.view.trigger(SignInFlow.Events.View.Hidden):this.dialog.modal({backdrop:"static",keyboard:!1,show:!0})}async hide(){this.view.children().remove(),this.dialog=void 0}async userSignIn(){const e=await this.cognito.signIn();return void 0!==e&&(await ApiHelper.attachIot(),console.log(`iot permission granted to '${e.username}'...`),await IotSubscriber.getSingleton().connect()),e}createCarousel(e){const t=[{id:this.ids.slides.signIn,el:this.createSignInForm(e)},{id:this.ids.slides.newPassword,el:this.createNewPasswordForm(e)},{id:this.ids.slides.resetSendCode,el:this.createResetSendCodeForm(e)},{id:this.ids.slides.resetPassword,el:this.createResetPasswordForm(e)}],a=$("<div/>").addClass("carousel-inner");for(let e=0;e<t.length;e++){const s=0===e?"carousel-item active":"carousel-item";a.append($("<div/>").addClass(s).attr("id",t[e].id).append(t[e].el))}return $("<div/>").addClass("carousel slide").attr("data-ride",!1).attr("data-interval",!1).attr("id",this.ids.carousel).append(a)}createSignInForm(e){const t=$("<form/>").addClass("form-signin text-center needs-validation").attr("novalidate","novalidate").append(this.createLogo()).append(this.createUserInput(this.ids.normal.username,"Username",(e||{}).username)).append(this.createPasswordInput()).append(this.createSubmitButton()).append(this.createResetLink());return t.off("submit").submit(async e=>{if(e.preventDefault(),!1===t[0].checkValidity())return e.stopPropagation(),this.shake(),await this.showMessage("danger",Localization.Alerts.Oops,Localization.Alerts.PwdConformance),!1;const a=t.find("#"+this.ids.normal.username),s=t.find("#"+this.ids.normal.password);try{const e=await this.cognito.authenticate({Username:a.val(),Password:s.val()});return s.val(""),"newPasswordRequired"===e.status?this.slideTo(this.ids.slides.newPassword):(await this.userSignIn(),this.dialog.modal("hide"))}catch(t){return e.stopPropagation(),this.shake(),await this.showMessage("danger",Localization.Alerts.Oops,`${Localization.Alerts.SignInProblem}<br><span class="small">(error: ${encodeURIComponent(t.message).replace(/%20/g," ")})</span>`),!1}}),t}createNewPasswordForm(e){const t=$("<div/>").append($("</p>").addClass("text-muted").html(Localization.Messages.PwdRequirement)),a=$("<form/>").addClass("form-signin text-center needs-validation").attr("novalidate","novalidate").append(this.createPasswordInput(this.ids.new.password01,"New Password","")).append(this.createPasswordInput(this.ids.new.password02,"Confirm Password","")).append(this.createSubmitButton("Confirm"));return a.off("submit").submit(async e=>{e.preventDefault();const t=a.find("#"+this.ids.new.password01),s=a.find("#"+this.ids.new.password02);if(t.val()!==s.val())return e.stopPropagation(),this.shake(),await this.showMessage("danger",Localization.Alerts.Oops,Localization.Alerts.MismatchPwds),s.val(""),!1;if(!1===a[0].checkValidity())return e.stopPropagation(),this.shake(),await this.showMessage("danger",Localization.Alerts.Oops,Localization.Alerts.PwdConformance),t.val(""),s.val(""),!1;try{await this.cognito.confirmNewPassword(t.val());return a.find('button[type="submit"]').addClass("disabled").attr("disabled","disabled"),await this.showMessage("success",Localization.Alerts.Confirmed,Localization.Alerts.PwdConfirmed,3e3),this.cognito.signOut(),t.val(""),s.val(""),this.slideTo(this.ids.slides.signIn)}catch(t){return e.stopPropagation(),this.shake(),await this.showMessage("danger",Localization.Alerts.Oops,`${Localization.Alerts.SessionExpired}</br><span class="small">(error: ${encodeURIComponent(t.message).replace(/%20/g," ")})</span>`),!1}}),t.append(a)}createResetSendCodeForm(e){const t=$("<div/>").append($("</p>").addClass("text-muted").html(Localization.Messages.ResetSendCode)),a=$("<form/>").addClass("form-signin text-center needs-validation").attr("novalidate","novalidate").append(this.createUserInput(this.ids.reset.username,"Username",void 0,"")).append(this.createSubmitButton("Send code"));return a.off("submit").submit(async e=>{e.preventDefault();const t=a.find("#"+this.ids.reset.username);if(!1===a[0].checkValidity())return e.stopPropagation(),this.shake(),await this.showMessage("danger",Localization.Alerts.Oops,Localization.Alerts.UsernameConformance),t.val(""),!1;try{await this.cognito.forgotPasswordFlow({Username:t.val()});return this.slideTo(this.ids.slides.resetPassword)}catch(t){return e.stopPropagation(),this.shake(),await this.showMessage("danger",Localization.Alerts.Oops,`${Localization.Alerts.SessionExpired}</br><span class="small">(error: ${encodeURIComponent(t.message).replace(/%20/g," ")})</span>`),!1}}),t.append(a)}createResetPasswordForm(e){const t=$("<div/>").append($("</p>").addClass("text-muted").html(Localization.Messages.ResetPwd)),a=$("<form/>").addClass("form-signin text-center needs-validation").attr("novalidate","novalidate").append(this.createCodeInput(this.ids.reset.code)).append(this.createPasswordInput(this.ids.reset.password,"New Password","")).append(this.createSubmitButton("Reset Password"));return a.off("submit").submit(async e=>{e.preventDefault();const t=a.find("#"+this.ids.reset.code),s=a.find("#"+this.ids.reset.password);if(!1===a[0].checkValidity())return e.stopPropagation(),this.shake(),await this.showMessage("danger",Localization.Alerts.Oops,Localization.Alerts.PwdConformance),t.val(""),s.val(""),!1;try{return await this.cognito.confirmPassword(t.val(),s.val()),await this.showMessage("success",Localization.Alerts.Confirmed,Localization.Alerts.PwdConfirmed),this.cognito.signOut(),t.val(""),s.val(""),this.slideTo(this.ids.slides.signIn)}catch(a){return e.stopPropagation(),this.shake(),t.val(""),s.val(""),await this.showMessage("danger",Localization.Alerts.Oops,`${Localization.Alerts.SessionExpired}</br><span class="small">(error: ${encodeURIComponent(a.message).replace(/%20/g," ")})</span>`),!1}}),t.append(a)}createLogo(){return $("<img/>").addClass("mb-4").attr("src",SOLUTION_ICON).attr("alt","media2cloud logo").attr("width",240)}createUserInput(e,t,a,s="sr-only"){return $("<div/>").addClass("text-left").append($("<label/>").addClass(s).attr("for",e).html(t)).append($("<input/>").addClass("form-control").attr("type","text").attr("id",e).attr("pattern","[a-zA-Z0-9._%+-]+").attr("placeholder",t).attr("value",a).attr("required","required").attr("autofocus","autofocus")).append($("<div/>").addClass("invalid-feedback").html("Invalid username"))}createPasswordInput(e=this.ids.normal.password,t="Password",a="sr-only"){return $("<div/>").addClass("text-left").append($("<label/>").addClass(a).attr("for",e).html(t)).append($("<input/>").addClass("form-control").attr("type","password").attr("id",e).attr("pattern","(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z]).{8,}").attr("placeholder","Password").attr("required","required")).append($("<div/>").addClass("invalid-feedback").html("Invalid password"))}createCodeInput(e,t="Verification Code",a,s=""){return $("<div/>").addClass("text-left mb-2").append($("<label/>").addClass(s).attr("for",e).html(t)).append($("<input/>").addClass("form-control").attr("type","text").attr("id",e).attr("pattern","[0-9]{6}").attr("placeholder",t).attr("value",a).attr("required","required").attr("autofocus","autofocus")).append($("<div/>").addClass("invalid-feedback").html("Invalid code"))}createSubmitButton(e="Sign in"){return $("<div/>").addClass("mt-4").append($("<button/>").addClass("btn btn-primary btn-block").attr("type","submit").html(e))}createResetLink(){const e=$("<button/>").addClass("btn btn-sm btn-link mt-2").attr("type","button").html("Forgot password?");return e.off("click").on("click",()=>this.slideTo(this.ids.slides.resetSendCode)),e}createCopyright(){return $("<p/>").addClass("font-weight-light text-muted mb-0").html("copyright &copy; 2020")}async showMessage(e,t,a,s=5e3){return new Promise((n,i)=>{const o=$("<div/>").addClass("alert alert-dismissible fade show alert-"+e).attr("role","alert").append($("<h4/>").addClass("alert-heading").html(t)).append($("<p/>").html(a)).append($("<button/>").addClass("close").attr("type","button").attr("data-dismiss","alert").attr("aria-label","Close").append($("<span/>").attr("aria-hidden",!0).html("&times;")));let r=setTimeout(()=>{o.alert("close"),r=void 0},s);o.on("close.bs.alert",()=>{clearInterval(r),r=void 0}),o.on("closed.bs.alert",()=>{o.alert("dispose"),o.remove(),n()}),this.dialog.append(o)})}shake(e=200){this.dialog.addClass("shake-sm").off("webkitAnimationEnd oanimationend msAnimationEnd animationend").on("webkitAnimationEnd oanimationend msAnimationEnd animationend",t=>this.dialog.delay(e).removeClass("shake-sm"))}slideTo(e){const t=this.dialog.find("#"+this.ids.carousel).first(),a=t.find("#"+e).index();t.carousel(a)}}const ID_DEMOAPP="#demo-app";class DemoApp{constructor(){this.$ids={container:"app-"+AppUtils.randomHexstring()};const e=$("<div/>").attr("id",this.ids.container),t=new SignInFlow;t.appendTo(e),t.view.on(SignInFlow.Events.View.Hidden,()=>setTimeout(async()=>{const t=new MainView;t.appendTo(e),t.show()},10)),this.$signInFlow=t,this.$view=e}get ids(){return this.$ids}get view(){return this.$view}get signInFlow(){return this.$signInFlow}appendTo(e){e.append(this.view)}async show(){return this.hide(),await this.openIndexedDB(),this.signInFlow.show()}async hide(){return this.closeIndexedDB()}async openIndexedDB(){return LocalStoreDB.getSingleton().open().catch(e=>console.error(e))}async closeIndexedDB(){return LocalStoreDB.getSingleton().close().catch(e=>console.error(e))}}$(document).ready(async()=>{const e=new DemoApp;e.appendTo($(ID_DEMOAPP)),await e.show(),$(window).on("unload",async()=>{await e.hide()})});export{DemoApp as default};